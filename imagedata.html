<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="img/favicon.ico" />
    <title>ImageData - vcat</title>
    <link rel="stylesheet" href="css/theme.css" />
    <link rel="stylesheet" href="css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "ImageData";
        var mkdocs_page_input_path = "imagedata.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="index.html" class="icon icon-home"> vcat
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="index.html">VCAT Documention</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Example Notebooks</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="tutorials.html">Tutorial Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="examples/ImageDataPlots.html">Plotting Images</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="examples/ImageOperations.html">Modifying Images</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="examples/ImageCubePlots.html">Plotting ImageCubes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="examples/ImageCubeOperations.html">Modifying ImageCubes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="examples/Alignment.html">Alignment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="examples/ModelComponents.html">Model Component Analysis</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="examples/Ridgeline.html">Ridgeline Fitting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="examples/Stacking.html">Stacking</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="examples/TurnoverFrequency.html">Turnover Frequency</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Code Documentation</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="overview.html">Code Overview</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">ImageData</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data">image_data</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.ImageData">ImageData</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.__init__">__init__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.align">align</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.calculate_opening_angle">calculate_opening_angle</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.center">center</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.change_component_ids">change_component_ids</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.copy">copy</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.export">export</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.fit_collimation_profile">fit_collimation_profile</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.fit_comp_polarization">fit_comp_polarization</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.get_component">get_component</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.get_core_component">get_core_component</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.get_model_info">get_model_info</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.get_noise_from_shift">get_noise_from_shift</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.get_peak_distance">get_peak_distance</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.get_pixel_value">get_pixel_value</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.get_profile">get_profile</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.get_ridgeline">get_ridgeline</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.jet_to_counterjet_profile">jet_to_counterjet_profile</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.masking">masking</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.plot_uv">plot_uv</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.regrid">regrid</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.remove_component">remove_component</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.restore">restore</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.rotate">rotate</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.set_core_component">set_core_component</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.shift">shift</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#vcat.image_data.ImageData.write_mod_file_from_casa">write_mod_file_from_casa</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.Jy2JyPerBeam">Jy2JyPerBeam</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.JyPerBeam2Jy">JyPerBeam2Jy</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.PXPERBEAM">PXPERBEAM</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.calculate_beam_width">calculate_beam_width</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.convolve_with_elliptical_gaussian">convolve_with_elliptical_gaussian</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.elliptical_gaussian_kernel">elliptical_gaussian_kernel</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.fit_width">fit_width</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.func_turn">func_turn</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.getComponentInfo">getComponentInfo</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.getMinVolEllipse">getMinVolEllipse</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.get_common_beam">get_common_beam</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.get_comp_peak_rms">get_comp_peak_rms</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.get_date">get_date</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.get_noise_from_residual_map">get_noise_from_residual_map</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.get_residual_map">get_residual_map</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.get_uvf_frequency">get_uvf_frequency</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.mas2pc">mas2pc</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.plot_pixel_fit">plot_pixel_fit</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.rotate_points">rotate_points</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.set_figsize">set_figsize</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.total_flux_from_mod">total_flux_from_mod</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.wrap_evpas">wrap_evpas</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.write_mod_file">write_mod_file</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.write_mod_file_from_casa">write_mod_file_from_casa</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#vcat.image_data.write_mod_file_from_components">write_mod_file_from_components</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="imagecube.html">ImageCube</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="helpers.html">vcat.helpers</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">About</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="license.html">License</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="release-note.html">Release Notes</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">vcat</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html" class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Code Documentation</li>
      <li class="breadcrumb-item active">ImageData</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/mpifr-vlbi/VCAT/edit/master/docs/imagedata.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="the-imagedata-class">The ImageData class</h1>
<p>The imageData class which hold one image and allows operations on this.</p>


<div class="doc doc-object doc-module">



<a id="vcat.image_data"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="vcat.image_data.ImageData" class="doc doc-heading">
            <code>ImageData</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code>object</code></p>


        <p>Class to handle VLBI Image data (single image with or without polarization at one frequency)</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Attributes:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>name</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>Source name of the observation</p>
              </div>
            </li>
            <li>
              <b><code>date</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>Date of the observation</p>
              </div>
            </li>
            <li>
              <b><code>mjd</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>MJD of the observation</p>
              </div>
            </li>
            <li>
              <b><code>freq</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Frequency of the observation in Hz</p>
              </div>
            </li>
            <li>
              <b><code>beam_maj</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Beam Major Axis in the intrinsic image scale (usually 'mas')</p>
              </div>
            </li>
            <li>
              <b><code>beam_min</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Beam Minor Axis in the intrinsic image scale (usually 'mas')</p>
              </div>
            </li>
            <li>
              <b><code>beam_pa</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Beam position angle in degrees (North through East)</p>
              </div>
            </li>
            <li>
              <b><code>scale</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Conversion from degrees to the intrinsic image scale (for 'mas': 3.6e6)</p>
              </div>
            </li>
            <li>
              <b><code>degpp</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Degrees per pixel</p>
              </div>
            </li>
            <li>
              <b><code>unit</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>Intrinsic Scale Unit of the image ('mas', 'arcsec', 'arcsec', 'deg')</p>
              </div>
            </li>
            <li>
              <b><code>uvw</code></b>
                  (<code>list[int]</code>)
              –
              <div class="doc-md-description">
                <p>uv-weighting to use for DIFMAP</p>
              </div>
            </li>
            <li>
              <b><code>stokes_i</code></b>
                  (<code>list[list[float]]</code>)
              –
              <div class="doc-md-description">
                <p>2d-array of the Stokes I image</p>
              </div>
            </li>
            <li>
              <b><code>stokes_q</code></b>
                  (<code>list[list[float]]</code>)
              –
              <div class="doc-md-description">
                <p>2d-array of the Stokes Q image (if polarization loaded)</p>
              </div>
            </li>
            <li>
              <b><code>stokes_u</code></b>
                  (<code>list[list[float]]</code>)
              –
              <div class="doc-md-description">
                <p>2d-array of the Stokes U image (if polarization loaded)</p>
              </div>
            </li>
            <li>
              <b><code>residual_map</code></b>
                  (<code>list[list[float]]</code>)
              –
              <div class="doc-md-description">
                <p>2d-array of the residual map (if .uvf file provided)</p>
              </div>
            </li>
            <li>
              <b><code>lin_pol</code></b>
                  (<code>list[list[float]]</code>)
              –
              <div class="doc-md-description">
                <p>2d-array of the linear polarization</p>
              </div>
            </li>
            <li>
              <b><code>evpa</code></b>
                  (<code>list[list[float]]</code>)
              –
              <div class="doc-md-description">
                <p>2d-array of the EVPA</p>
              </div>
            </li>
            <li>
              <b><code>mask</code></b>
                  (<code>list[list[bool]]</code>)
              –
              <div class="doc-md-description">
                <p>Image mask</p>
              </div>
            </li>
            <li>
              <b><code>model</code></b>
                  (<code>DataFrame</code>)
              –
              <div class="doc-md-description">
                <p>DataFrame with all components of the loaded model</p>
              </div>
            </li>
            <li>
              <b><code>model_i</code></b>
                  (<code>DataFrame</code>)
              –
              <div class="doc-md-description">
                <p>DataFrame with all Stokes I clean components</p>
              </div>
            </li>
            <li>
              <b><code>model_q</code></b>
                  (<code>DataFrame</code>)
              –
              <div class="doc-md-description">
                <p>DataFrame with all Stokes Q clean components</p>
              </div>
            </li>
            <li>
              <b><code>model_u</code></b>
                  (<code>DataFrame</code>)
              –
              <div class="doc-md-description">
                <p>DataFrame with all Stokes U clean components</p>
              </div>
            </li>
            <li>
              <b><code>components</code></b>
                  (<code>list[<span title="vcat.kinematics.Component">Component</span>]</code>)
              –
              <div class="doc-md-description">
                <p>List of Modelfit-Components</p>
              </div>
            </li>
            <li>
              <b><code>noise</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Image noise in Jy, calculated using the specified 'noise_method'</p>
              </div>
            </li>
            <li>
              <b><code>pol_noise</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Image noise of the linear polarization image in Jy</p>
              </div>
            </li>
            <li>
              <b><code>noise_3sigma</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>3-sigma Image noise level in Jy</p>
              </div>
            </li>
            <li>
              <b><code>pol_noise_3sigma</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>3-sigma Polarization noise level in Jy</p>
              </div>
            </li>
            <li>
              <b><code>integrated_flux_image</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Integrated flux density of the entire image (pixel sum)</p>
              </div>
            </li>
            <li>
              <b><code>integrated_flux_clean</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Integrated flux density from the Stokes I clean model</p>
              </div>
            </li>
            <li>
              <b><code>integrated_pol_flux_image</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Integrated linearly polarized flux density of the entire image (pixel sum)</p>
              </div>
            </li>
            <li>
              <b><code>integrated_pol_flux_clean</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Integrated linearly polarized flux density from Stokes Q and U clean models</p>
              </div>
            </li>
            <li>
              <b><code>evpa_average</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Average EVPA calculated from Stokes Q and U clean models (in rad!).</p>
              </div>
            </li>
            <li>
              <b><code>frac_pol</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Fractional polarization of the image (integrated_flux_pol_clean/integrated_flux_clean)</p>
              </div>
            </li>
            <li>
              <b><code>uvtaper</code></b>
                  (<code>list[float]</code>)
              –
              <div class="doc-md-description">
                <p>Pass uvtaper parameter [fraction, uv-radius]</p>
              </div>
            </li>
            <li>
              <b><code>ridgeline</code></b>
                  (<code><span title="vcat.ridgeline.Ridgeline">Ridgeline</span></code>)
              –
              <div class="doc-md-description">
                <p>Ridgeline of the image (can be created with self.get_ridgeline())</p>
              </div>
            </li>
            <li>
              <b><code>counter_ridgeline</code></b>
                  (<code>Ridgline</code>)
              –
              <div class="doc-md-description">
                <p>Counter-Ridgeline of the image (can be created with self.get_ridgeline())</p>
              </div>
            </li>
            <li>
              <b><code>file_path</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>File path to Stokes I .fits file</p>
              </div>
            </li>
            <li>
              <b><code>model_file_path</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>File path to modelfit .fits file</p>
              </div>
            </li>
            <li>
              <b><code>stokes_q_path</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>File path to Stokes Q .fits file</p>
              </div>
            </li>
            <li>
              <b><code>stokes_u_path</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>File path to Stokes U .fits file</p>
              </div>
            </li>
            <li>
              <b><code>stokes_i_mod_file</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>File path to Stokes I clean model .mod file</p>
              </div>
            </li>
            <li>
              <b><code>stokes_q_mod_file</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>File path to Stokes Q clean model .mod file</p>
              </div>
            </li>
            <li>
              <b><code>stokes_u_mod_file</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>File path to Stokes U clean model .mod file</p>
              </div>
            </li>
            <li>
              <b><code>model_mod_file</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>File path to the modelfit .mod file</p>
              </div>
            </li>
            <li>
              <b><code>residual_map_path</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>Path to the .fits file of the residual map (if .uvf file provided)</p>
              </div>
            </li>
            <li>
              <b><code>spix</code></b>
                  (<code>list[list[float]]</code>)
              –
              <div class="doc-md-description">
                <p>2d-array of spectral index data (if loaded)</p>
              </div>
            </li>
            <li>
              <b><code>rm</code></b>
                  (<code>list[list[float]]</code>)
              –
              <div class="doc-md-description">
                <p>2d-array of rotation measure data (if loaded)</p>
              </div>
            </li>
            <li>
              <b><code>turnover</code></b>
                  (<code>list[list[float]]</code>)
              –
              <div class="doc-md-description">
                <p>2d-array of turnover frequency data (if loaded)</p>
              </div>
            </li>
            <li>
              <b><code>turnover_flux</code></b>
                  (<code>list[list[float]]</code>)
              –
              <div class="doc-md-description">
                <p>2d-array of turnover flux density data (if loaded)</p>
              </div>
            </li>
            <li>
              <b><code>turnover_error</code></b>
                  (<code>list[list[float]]</code>)
              –
              <div class="doc-md-description">
                <p>2d-array of turnover frequency error data (if loaded)</p>
              </div>
            </li>
            <li>
              <b><code>turnover_chi_sq</code></b>
                  (<code>list[list[float]]</code>)
              –
              <div class="doc-md-description">
                <p>2d-array of turnover-fit chi-squared values</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>





              <details class="quote">
                <summary>Source code in <code>vcat/image_data.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  37</span>
<span class="normal">  38</span>
<span class="normal">  39</span>
<span class="normal">  40</span>
<span class="normal">  41</span>
<span class="normal">  42</span>
<span class="normal">  43</span>
<span class="normal">  44</span>
<span class="normal">  45</span>
<span class="normal">  46</span>
<span class="normal">  47</span>
<span class="normal">  48</span>
<span class="normal">  49</span>
<span class="normal">  50</span>
<span class="normal">  51</span>
<span class="normal">  52</span>
<span class="normal">  53</span>
<span class="normal">  54</span>
<span class="normal">  55</span>
<span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ImageData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to handle VLBI Image data (single image with or without polarization at one frequency)</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name (str): Source name of the observation</span>
<span class="sd">        date (str): Date of the observation</span>
<span class="sd">        mjd (float): MJD of the observation</span>
<span class="sd">        freq (float): Frequency of the observation in Hz</span>
<span class="sd">        beam_maj (float): Beam Major Axis in the intrinsic image scale (usually &#39;mas&#39;)</span>
<span class="sd">        beam_min (float): Beam Minor Axis in the intrinsic image scale (usually &#39;mas&#39;)</span>
<span class="sd">        beam_pa (float): Beam position angle in degrees (North through East)</span>
<span class="sd">        scale (float): Conversion from degrees to the intrinsic image scale (for &#39;mas&#39;: 3.6e6)</span>
<span class="sd">        degpp (float): Degrees per pixel</span>
<span class="sd">        unit (str): Intrinsic Scale Unit of the image (&#39;mas&#39;, &#39;arcsec&#39;, &#39;arcsec&#39;, &#39;deg&#39;)</span>
<span class="sd">        uvw (list[int]): uv-weighting to use for DIFMAP</span>
<span class="sd">        stokes_i (list[list[float]]): 2d-array of the Stokes I image</span>
<span class="sd">        stokes_q (list[list[float]]): 2d-array of the Stokes Q image (if polarization loaded)</span>
<span class="sd">        stokes_u (list[list[float]]): 2d-array of the Stokes U image (if polarization loaded)</span>
<span class="sd">        residual_map (list[list[float]]): 2d-array of the residual map (if .uvf file provided)</span>
<span class="sd">        lin_pol (list[list[float]]): 2d-array of the linear polarization</span>
<span class="sd">        evpa (list[list[float]]): 2d-array of the EVPA</span>
<span class="sd">        mask (list[list[bool]]): Image mask</span>
<span class="sd">        model (DataFrame): DataFrame with all components of the loaded model</span>
<span class="sd">        model_i (DataFrame): DataFrame with all Stokes I clean components</span>
<span class="sd">        model_q (DataFrame): DataFrame with all Stokes Q clean components</span>
<span class="sd">        model_u (DataFrame): DataFrame with all Stokes U clean components</span>
<span class="sd">        components (list[Component]): List of Modelfit-Components</span>
<span class="sd">        noise (float): Image noise in Jy, calculated using the specified &#39;noise_method&#39;</span>
<span class="sd">        pol_noise (float): Image noise of the linear polarization image in Jy</span>
<span class="sd">        noise_3sigma (float): 3-sigma Image noise level in Jy</span>
<span class="sd">        pol_noise_3sigma (float): 3-sigma Polarization noise level in Jy</span>
<span class="sd">        integrated_flux_image (float): Integrated flux density of the entire image (pixel sum)</span>
<span class="sd">        integrated_flux_clean (float): Integrated flux density from the Stokes I clean model</span>
<span class="sd">        integrated_pol_flux_image (float): Integrated linearly polarized flux density of the entire image (pixel sum)</span>
<span class="sd">        integrated_pol_flux_clean (float): Integrated linearly polarized flux density from Stokes Q and U clean models</span>
<span class="sd">        evpa_average (float): Average EVPA calculated from Stokes Q and U clean models (in rad!).</span>
<span class="sd">        frac_pol (float): Fractional polarization of the image (integrated_flux_pol_clean/integrated_flux_clean)</span>
<span class="sd">        uvtaper (list[float]): Pass uvtaper parameter [fraction, uv-radius]</span>
<span class="sd">        ridgeline (Ridgeline): Ridgeline of the image (can be created with self.get_ridgeline())</span>
<span class="sd">        counter_ridgeline (Ridgline): Counter-Ridgeline of the image (can be created with self.get_ridgeline())</span>
<span class="sd">        file_path (str): File path to Stokes I .fits file</span>
<span class="sd">        model_file_path (str): File path to modelfit .fits file</span>
<span class="sd">        stokes_q_path (str): File path to Stokes Q .fits file</span>
<span class="sd">        stokes_u_path (str): File path to Stokes U .fits file</span>
<span class="sd">        stokes_i_mod_file (str): File path to Stokes I clean model .mod file</span>
<span class="sd">        stokes_q_mod_file (str): File path to Stokes Q clean model .mod file</span>
<span class="sd">        stokes_u_mod_file (str): File path to Stokes U clean model .mod file</span>
<span class="sd">        model_mod_file (str): File path to the modelfit .mod file</span>
<span class="sd">        residual_map_path (str): Path to the .fits file of the residual map (if .uvf file provided)</span>
<span class="sd">        spix (list[list[float]]): 2d-array of spectral index data (if loaded)</span>
<span class="sd">        rm (list[list[float]]): 2d-array of rotation measure data (if loaded)</span>
<span class="sd">        turnover (list[list[float]]): 2d-array of turnover frequency data (if loaded)</span>
<span class="sd">        turnover_flux (list[list[float]]): 2d-array of turnover flux density data (if loaded)</span>
<span class="sd">        turnover_error (list[list[float]]): 2d-array of turnover frequency error data (if loaded)</span>
<span class="sd">        turnover_chi_sq (list[list[float]]): 2d-array of turnover-fit chi-squared values</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">fits_file</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">uvf_file</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">stokes_i</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">model</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">lin_pol</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">evpa</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">pol_from_stokes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">mask</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">ridgeline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">counter_ridgeline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">stokes_q</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">stokes_u</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">comp_ids</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">auto_identify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">core_comp_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">redshift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">query_redshift</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">M</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">model_save_dir</span><span class="o">=</span><span class="s2">&quot;tmp/&quot;</span><span class="p">,</span>
                 <span class="n">is_casa_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">is_ehtim_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">noise_method</span><span class="o">=</span><span class="n">noise_method</span><span class="p">,</span> <span class="c1">#choose noise method</span>
                 <span class="n">mfit_err_method</span><span class="o">=</span><span class="n">mfit_err_method</span><span class="p">,</span>
                 <span class="n">res_lim_method</span><span class="o">=</span><span class="n">res_lim_method</span><span class="p">,</span>
                 <span class="n">uvtaper</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">correct_rician_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">error</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="c1">#relative error flux densities,</span>
                 <span class="n">fit_comp_polarization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">fit_comp_pol_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">gain_err</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                 <span class="n">uvw</span><span class="o">=</span><span class="n">uvw</span><span class="p">,</span>
                 <span class="n">difmap_path</span><span class="o">=</span><span class="n">difmap_path</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes an ImageData object to handle a full-polarization VLBI data set at one epoch and one frequency.</span>

<span class="sd">        Args:</span>
<span class="sd">            fits_file (str): Input .fits file(s) (Stokes I or full polarization, e.g. from CASA)</span>
<span class="sd">            uvf_file (str): Input .uvf file(s)</span>
<span class="sd">            stokes_i (list[list[float]]): Input of Stokes-I data as a 2d-array</span>
<span class="sd">            model (str): Input of modelfit .fits or .mod file (e.g., from DIFMAP), for CASA .fits model, set is_casa_model=True</span>
<span class="sd">            lin_pol (list[list[float]]): 2d array of linear polarized intensity values (if using, set pol_from_stokes=False)</span>
<span class="sd">            evpa (list[list[float]]): 2d array of Electric Vector Position Angle (EVPA) (if using, set pol_from_stokes=False)</span>
<span class="sd">            pol_from_stokes (bool): Choose whether to import data from fits-files or from lin_pol/evpa</span>
<span class="sd">            mask (list[list[bool]]): 2d-array of an image mask</span>
<span class="sd">            ridgeline (Ridgeline): Ridgeline of the image</span>
<span class="sd">            counter_ridgeline (Ridgeline): Counter ridgeline of the image.</span>
<span class="sd">            stokes_q (str or list[list[float]]): Input Stokes-Q .fits file or 2d array of Stokes-Q image</span>
<span class="sd">            stokes_u (str or list[list[float]]): Input Stokes-U .fits file or 2d array of Stokes-U image</span>
<span class="sd">            comp_ids (list[int]): list of integers to assign as component number (from top to bottom .mod file or .fits header)</span>
<span class="sd">            auto_identify (bool): If true and no comp_ids provided components will automatically be named</span>
<span class="sd">            core_comp_id (int): Component ID of the core component</span>
<span class="sd">            redshift (float): Redshift of the source</span>
<span class="sd">            query_redshift (bool): Choose whether to query redshift automatically from NED</span>
<span class="sd">            M (float): Black hole mass</span>
<span class="sd">            model_save_dir (str): Directory where temporary data for VCAT operations will be stored</span>
<span class="sd">            is_casa_model (bool): If using a CASA .fits model for &#39;model&#39;, set to True</span>
<span class="sd">            is_ehtim_model (bool): If using a ehtim .txt model file for &#39;model&#39;, set to True</span>
<span class="sd">            noise_method (str): Choose method to calculate image noise (&#39;Histogram Fit&#39;, &#39;box&#39;, &#39;Image RMS&#39;, &#39;DIFMAP&#39;)</span>
<span class="sd">            mfit_err_method (str): Choose method to compute modelcomponent errors (&#39;flat&#39;, &#39;Schinzel12&#39;, &#39;Weaver22&#39;)</span>
<span class="sd">            res_lim_method (str): Choose method to compute component resolution limit (&#39;Kovalev05&#39;, &#39;Lobanov05&#39;,&#39;beam&#39;)</span>
<span class="sd">            correct_rician_bias (bool): Choose whether to correct polarization for Rician Bias</span>
<span class="sd">            error (float): Set relative error on the flux density scale</span>
<span class="sd">            fit_comp_polarization (bool): Choose whether to fit polarization of modelfit components</span>
<span class="sd">            fit_comp_pol_errors (bool): Choose whether to determine lin_pol and evpa errors for components</span>
<span class="sd">            difmap_path (str): Path to the folder of your DIFMAP installation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">==</span><span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_inp</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fits_file</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">fits_file</span><span class="o">=</span><span class="n">model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_inp</span><span class="o">=</span><span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">fits_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span> <span class="o">=</span> <span class="n">fits_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="o">=</span><span class="n">lin_pol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evpa</span><span class="o">=</span><span class="n">evpa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stokes_i</span><span class="o">=</span><span class="n">stokes_i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="o">=</span><span class="n">uvf_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="o">=</span><span class="n">difmap_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residual_map_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residual_map</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_method</span><span class="o">=</span><span class="n">noise_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_casa_model</span><span class="o">=</span><span class="n">is_casa_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_ehtim_model</span><span class="o">=</span><span class="n">is_ehtim_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">=</span><span class="n">model_save_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correct_rician_bias</span><span class="o">=</span><span class="n">correct_rician_bias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol</span> <span class="o">=</span> <span class="n">fit_comp_polarization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol_errors</span> <span class="o">=</span> <span class="n">fit_comp_pol_errors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">=</span><span class="n">error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gain_err</span><span class="o">=</span><span class="n">gain_err</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="o">=</span><span class="n">uvtaper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="o">=</span><span class="n">uvw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="o">=</span><span class="n">M</span>
        <span class="k">if</span> <span class="n">ridgeline</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">=</span><span class="n">Ridgeline</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">=</span><span class="n">ridgeline</span>
        <span class="k">if</span> <span class="n">counter_ridgeline</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="o">=</span><span class="n">Ridgeline</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="o">=</span><span class="n">counter_ridgeline</span>


        <span class="k">if</span> <span class="n">fits_file</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="c1">#if no fits file was loaded try to get the dirty image</span>
            <span class="k">if</span> <span class="n">uvf_file</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Only .uvf file given, will create dirty image with npix=1024 and pxsize=0.05!&quot;</span><span class="p">)</span>
                <span class="c1">#get dirty map from uvf file</span>
                <span class="n">get_residual_map</span><span class="p">(</span><span class="n">uvf_file</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">difmap_path</span><span class="o">=</span><span class="n">difmap_path</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span>
                                 <span class="n">save_location</span><span class="o">=</span><span class="s2">&quot;/tmp/dirty_image.fits&quot;</span><span class="p">,</span> <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span>
                                 <span class="n">npix</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span><span class="n">pxsize</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">do_selfcal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">fits_file</span><span class="o">=</span><span class="s2">&quot;/tmp/dirty_image.fits&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="o">=</span><span class="n">fits_file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="o">=</span><span class="n">fits_file</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">no_fits</span><span class="o">=</span><span class="kc">True</span>

        <span class="c1"># Read clean files in</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">hdu_list</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hdu_list</span> <span class="o">=</span> <span class="n">hdu_list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_fits</span><span class="o">=</span><span class="kc">False</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_path</span><span class="o">=</span><span class="n">stokes_q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_path</span><span class="o">=</span><span class="n">stokes_u</span>
        <span class="n">stokes_q_path</span><span class="o">=</span><span class="n">stokes_q</span>
        <span class="n">stokes_u_path</span><span class="o">=</span><span class="n">stokes_u</span>
        <span class="c1">#read stokes data from input files if defined</span>
        <span class="k">if</span> <span class="n">stokes_q</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">q_fits</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stokes_q</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">stokes_q</span> <span class="o">=</span> <span class="n">q_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">stokes_q</span> <span class="o">=</span> <span class="n">q_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                <span class="n">q_fits</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">stokes_q</span><span class="o">=</span><span class="n">stokes_q</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stokes_q</span><span class="o">=</span><span class="p">[]</span>

        <span class="k">if</span> <span class="n">stokes_u</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">u_fits</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stokes_u</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">stokes_u</span> <span class="o">=</span> <span class="n">u_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">stokes_u</span> <span class="o">=</span> <span class="n">u_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                <span class="n">u_fits</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">stokes_u</span> <span class="o">=</span> <span class="n">stokes_u</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stokes_u</span><span class="o">=</span><span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="o">=</span><span class="n">stokes_u</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="o">=</span><span class="n">stokes_q</span>

        <span class="c1"># Set name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;OBJECT&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">get_date</span><span class="p">(</span><span class="n">fits_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">)</span><span class="o">.</span><span class="n">mjd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">)</span><span class="o">.</span><span class="n">decimalyear</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRVAL3&quot;</span><span class="p">])</span>  <span class="c1"># frequency in Hertz</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FREQ&quot;</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="mi">15000000000</span>


        <span class="c1">#get redshift</span>
        <span class="k">if</span> <span class="n">redshift</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">query_redshift</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">Ned</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="s2">&quot;redshifts&quot;</span><span class="p">)[</span><span class="s2">&quot;Published Redshift&quot;</span><span class="p">])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Redshift for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> automatically determined from NED: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span> <span class="o">=</span> <span class="mf">0.00</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="o">=</span><span class="n">redshift</span>

        <span class="c1"># Unit selection and adjustment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">])</span>  <span class="c1"># degree per pixel</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;deg&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">&gt;</span> <span class="mf">6.94e-6</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;arcmin&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">60.</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">&gt;</span> <span class="mf">1.157e-7</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">60.</span> <span class="o">*</span> <span class="mf">60.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;arcsec&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">60.</span> <span class="o">*</span> <span class="mf">60.</span> <span class="o">*</span> <span class="mf">1000.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;mas&#39;</span>
        <span class="c1"># FMP suggestion: add microarcseconds for possible scale</span>

        <span class="c1"># Set beam parameters</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># DIFMAP style</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMAJ&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMIN&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BPA&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># TODO check if this is actually working!</span>
                <span class="c1"># CASA style</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># convert to mas</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># convert to mas</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No input beam information!&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span> <span class="o">=</span> <span class="mi">0</span>


        <span class="c1"># Convert Pixel into unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">],</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">],</span>
                        <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># NAXIS1: number of pixels at R.A.-axis</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span>
                <span class="s2">&quot;CDELT1&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>  <span class="c1"># CRPIX1: reference pixel, CDELT1: deg/pixel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">],</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">],</span>
                        <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># NAXIS2: number of pixels at Dec.-axis</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span>
                <span class="s2">&quot;CDELT2&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>  <span class="c1"># CRPIX2: reference pixel, CDELT2: deg/pixel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_fits</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_data</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_data</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>


        <span class="c1">#handle model loading</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span> <span class="o">=</span> <span class="n">model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_fits_file</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_casa_model</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_ehtim_model</span><span class="p">:</span> <span class="c1">#Careful, this may not work for CASA style .fits files!</span>
            <span class="c1">#this means it is a .mod file -&gt; will create .fits file from it</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_model/&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">new_model_fits</span><span class="o">=</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_model/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz&quot;</span>
            <span class="k">if</span> <span class="n">difmap_path</span><span class="o">!=</span><span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">uvf_file</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="c1"># use difmap to load the model and create model .fits file and store it as model_file_path</span>
                <span class="n">fold_with_beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">],</span><span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                               <span class="n">bmaj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">,</span>
                               <span class="n">outname</span><span class="o">=</span><span class="n">new_model_fits</span><span class="p">,</span> <span class="n">n_pixel</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                               <span class="n">mod_files</span><span class="o">=</span><span class="p">[</span><span class="n">model</span><span class="p">],</span><span class="n">clean_mod_files</span><span class="o">=</span><span class="p">[</span><span class="n">model</span><span class="p">],</span> <span class="n">uvf_files</span><span class="o">=</span><span class="p">[</span><span class="n">uvf_file</span><span class="p">],</span> <span class="n">do_selfcal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#TODO does not work for AIPS .fits!!!</span>
                <span class="c1">#copy the clean .fits file and write the model info to the header and store it as model_file_path</span>
                <span class="c1">#get model first:</span>
                <span class="n">model_df</span> <span class="o">=</span> <span class="n">getComponentInfo</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                <span class="c1">#now modify fits file</span>
                <span class="n">f</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">)</span>
                <span class="c1"># FITS column names</span>
                <span class="n">fits_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">,</span><span class="s2">&quot;DELTAX&quot;</span><span class="p">,</span><span class="s2">&quot;DELTAY&quot;</span><span class="p">,</span><span class="s2">&quot;MAJOR AX&quot;</span><span class="p">,</span><span class="s2">&quot;MINOR AX&quot;</span><span class="p">,</span><span class="s2">&quot;POSANGLE&quot;</span><span class="p">,</span><span class="s2">&quot;TYPE OBJ&quot;</span><span class="p">]</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([</span>
                    <span class="p">(</span><span class="s1">&#39;FLUX&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f4&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;DELTAX&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f4&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;DELTAY&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f4&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;MAJOR AX&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f4&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;MINOR AX&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f4&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;POSANGLE&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f4&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;TYPE OBJ&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f4&#39;</span><span class="p">)</span>
                    <span class="p">])</span>


                <span class="c1"># Manually map DataFrame columns to FITS structure</span>
                <span class="n">column_mapping</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;FLUX&quot;</span><span class="p">:</span> <span class="s2">&quot;Flux&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;DELTAX&quot;</span><span class="p">:</span> <span class="s2">&quot;Delta_x&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;DELTAY&quot;</span><span class="p">:</span> <span class="s2">&quot;Delta_y&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;MAJOR AX&quot;</span><span class="p">:</span> <span class="s2">&quot;Major_axis&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;MINOR AX&quot;</span><span class="p">:</span> <span class="s2">&quot;Minor_axis&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;POSANGLE&quot;</span><span class="p">:</span> <span class="s2">&quot;PA&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;TYPE OBJ&quot;</span><span class="p">:</span> <span class="s2">&quot;Typ_obj&quot;</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="c1"># Ensure correct order and match dtype</span>
                <span class="n">new_data_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column_mapping</span><span class="p">[</span><span class="n">col</span><span class="p">]]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">fits_columns</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">model_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()],</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>  <span class="c1"># Ensure the same dtype as the original FITS table</span>
                <span class="p">)</span>

                <span class="c1"># Overwrite the FITS table with the new structured array</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">new_data_array</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>
                <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_model_fits</span><span class="o">+</span><span class="s2">&quot;.fits&quot;</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span> <span class="o">=</span> <span class="n">new_model_fits</span> <span class="o">+</span> <span class="s2">&quot;.fits&quot;</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span>

        <span class="c1">#overwrite fits image data with stokes_i input if given</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stokes_i</span><span class="o">==</span><span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">=</span><span class="n">stokes_i</span>

        <span class="c1">#read in polarization input</span>

        <span class="c1"># check if FITS file contains more than just Stokes I</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">only_stokes_i</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">only_stokes_i</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">only_stokes_i</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stokes_q</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stokes_u</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stokes_q</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stokes_u</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">only_stokes_i</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#in this case override the polarization data with the data that was input to Q and U</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">only_stokes_i</span><span class="p">:</span>
            <span class="c1">#DIFMAP Style</span>
            <span class="n">pols</span><span class="o">=</span><span class="mi">1</span>
            <span class="c1"># Check if linpol/evpa/stokes_i have same dimensions!</span>
            <span class="n">dim_wrong</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">pol_from_stokes</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stokes_q</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stokes_u</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stokes_q</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stokes_u</span><span class="p">)):</span>
                    <span class="n">dim_wrong</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="o">=</span><span class="n">stokes_q</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="o">=</span><span class="n">stokes_u</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">evpa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">lin_pol</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">evpa</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">lin_pol</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">evpa</span><span class="p">)):</span>
                    <span class="n">dim_wrong</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="o">=</span><span class="n">lin_pol</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">evpa</span><span class="o">=</span><span class="n">evpa</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">evpa</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#CASA STYLE</span>
            <span class="n">pols</span><span class="o">=</span><span class="mi">3</span>
            <span class="n">dim_wrong</span><span class="o">=</span><span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="o">=</span><span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="o">=</span><span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_data</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_data</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span>

        <span class="k">if</span> <span class="n">pol_from_stokes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dim_wrong</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evpa</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="p">)</span>
            <span class="c1">#shift to 0-180 (only positive)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evpa</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evpa</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evpa</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evpa</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">difmap_noise</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NOISE&quot;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">difmap_noise</span> <span class="o">=</span> <span class="mi">0</span>


        <span class="k">try</span><span class="p">:</span>
            <span class="n">q_fits</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stokes_q_path</span><span class="p">)</span>
            <span class="n">u_fits</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stokes_u_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">difmap_pol_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">q_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NOISE&quot;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="nb">float</span><span class="p">(</span><span class="n">u_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NOISE&quot;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">q_fits</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">u_fits</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">difmap_pol_noise</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#calculate image noise according to the method selected</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calculating Stokes I noise&quot;</span><span class="p">)</span>
        <span class="n">unused</span><span class="p">,</span> <span class="n">levs_i</span> <span class="o">=</span> <span class="n">get_sigma_levs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="n">noise_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_method</span><span class="p">,</span><span class="n">noise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_noise</span><span class="p">)</span> <span class="c1">#get noise for stokes i</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calculating Pol noise&quot;</span><span class="p">)</span>
            <span class="n">unused</span><span class="p">,</span> <span class="n">levs_pol</span> <span class="o">=</span> <span class="n">get_sigma_levs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="n">noise_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_method</span><span class="p">,</span><span class="n">noise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_noise</span><span class="p">)</span> <span class="c1">#get noise for polarization</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">levs_pol</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">levs_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pol_noise</span> <span class="o">=</span> <span class="n">levs_pol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1">#calculate integrated total flux in image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrated_flux_image</span> <span class="o">=</span> <span class="n">JyPerBeam2Jy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>

        <span class="c1">#calculate integrated pol flux in image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrated_pol_flux_image</span> <span class="o">=</span> <span class="n">JyPerBeam2Jy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_casa_model</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ehtim_model</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1">#TODO basic checks if file is valid</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">=</span><span class="n">getComponentInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                <span class="c1">#write .mod file from .fits input</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_model/&quot;</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="o">=</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_model/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span>
                    <span class="n">write_mod_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;FITS file does not contain model extension!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ehtim_model</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_clean&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_q&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_u&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span> <span class="o">=</span> <span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_clean/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span>
            <span class="n">write_mod_file_from_ehtim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span> <span class="o">=</span> <span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_q/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span>
            <span class="n">write_mod_file_from_ehtim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span> <span class="o">=</span> <span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_u/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span>
            <span class="n">write_mod_file_from_ehtim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">getComponentInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span><span class="n">year</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">mjd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span><span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span>

        <span class="k">elif</span> <span class="n">is_casa_model</span><span class="p">:</span>
            <span class="c1">#TODO basic checks if file is valid</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_clean&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_q&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_u&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="o">=</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_clean/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_mod_file_from_casa</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="o">=</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_q/&quot;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_mod_file_from_casa</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="o">=</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_u/&quot;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_mod_file_from_casa</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">getComponentInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_clean&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_q&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_u&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1">#try to import model which is attached to the main .fits file</span>
            <span class="n">model_i</span> <span class="o">=</span> <span class="n">getComponentInfo</span><span class="p">(</span><span class="n">fits_file</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_i</span> <span class="o">=</span> <span class="n">model_i</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="o">=</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_clean/&quot;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span>
            <span class="n">write_mod_file</span><span class="p">(</span><span class="n">model_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span>
            <span class="c1">#load stokes q and u clean models</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_q</span><span class="o">=</span><span class="n">getComponentInfo</span><span class="p">(</span><span class="n">stokes_q_path</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="o">=</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_q/&quot;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span>
            <span class="n">write_mod_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_u</span><span class="o">=</span><span class="n">getComponentInfo</span><span class="p">(</span><span class="n">stokes_u_path</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="o">=</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_u/&quot;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span>
            <span class="n">write_mod_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1">#calculate residual map if uvf and modelfile present</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="o">!=</span><span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="o">!=</span><span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_casa_model</span> <span class="ow">and</span>  <span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;residual_maps&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">residual_map_path</span> <span class="o">=</span> <span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;residual_maps/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
                                                                                                                 <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz_residual.fits&quot;</span>

            <span class="n">get_residual_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">,</span>
                             <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                             <span class="n">save_location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_map_path</span><span class="p">,</span><span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span>
                             <span class="n">npix</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">),</span><span class="n">pxsize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">residual_map</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_map_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>

        <span class="c1">#save modelfit (or clean) components as Component objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">=</span><span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_inp</span><span class="p">:</span>
            <span class="c1">#only do this if a model was specified explicitely</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="c1">#use provided comp_id</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">comp_id</span><span class="o">=</span><span class="n">comp_ids</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1">#assign automatic comp_id</span>
                    <span class="k">if</span> <span class="n">auto_identify</span><span class="p">:</span>
                        <span class="n">comp_id</span><span class="o">=</span><span class="n">ind</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">comp_id</span><span class="o">=-</span><span class="mi">1</span>

                <span class="c1">#check if component is the core component</span>
                <span class="k">if</span> <span class="n">comp_id</span><span class="o">==</span><span class="n">core_comp_id</span><span class="p">:</span>
                    <span class="n">is_core</span><span class="o">=</span><span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">is_core</span><span class="o">=</span><span class="kc">False</span>

                <span class="c1">#calculate component SNR</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="o">!=</span><span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">S_p</span><span class="p">,</span> <span class="n">rms</span> <span class="o">=</span> <span class="n">get_comp_peak_rms</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;Delta_x&quot;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;Delta_y&quot;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">,</span>
                                                 <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span> <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">)</span>
                    <span class="n">comp_snr</span> <span class="o">=</span> <span class="n">S_p</span><span class="o">/</span><span class="n">rms</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ind</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No .uvfits file or difmap path provided. Calculating modelfit component SNR based on the clean map only.&#39;</span><span class="p">)</span>
                    <span class="c1"># TODO: use .fits file from Gaussian modelfit instead of clean map</span>
                    <span class="n">S_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pixel_value</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;Delta_x&quot;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                                                   <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;Delta_y&quot;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                    <span class="n">rms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span>
                    <span class="n">comp_snr</span> <span class="o">=</span> <span class="n">S_p</span><span class="o">/</span><span class="n">rms</span>

                <span class="n">component</span><span class="o">=</span><span class="n">Component</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;Delta_x&quot;</span><span class="p">],</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;Delta_y&quot;</span><span class="p">],</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;Major_axis&quot;</span><span class="p">],</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;Minor_axis&quot;</span><span class="p">],</span>
                                    <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;PA&quot;</span><span class="p">],</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;Flux&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span><span class="n">Time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;mjd&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decimalyear</span><span class="p">,</span><span class="n">component_number</span><span class="o">=</span><span class="n">comp_id</span><span class="p">,</span>
                                    <span class="n">redshift</span><span class="o">=</span><span class="n">redshift</span><span class="p">,</span> <span class="n">is_core</span><span class="o">=</span><span class="n">is_core</span><span class="p">,</span><span class="n">beam_maj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span><span class="n">beam_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span><span class="n">beam_pa</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">,</span>
                                    <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="n">noise</span><span class="o">=</span><span class="n">rms</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">snr</span><span class="o">=</span><span class="n">comp_snr</span><span class="p">,</span><span class="n">error_method</span><span class="o">=</span><span class="n">mfit_err_method</span><span class="p">,</span>
                                    <span class="n">res_lim_method</span><span class="o">=</span><span class="n">res_lim_method</span><span class="p">,</span><span class="n">gain_err</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gain_err</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

            <span class="c1">#set core</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_core_component</span><span class="p">(</span><span class="n">core_comp_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="o">!=</span><span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">fit_comp_polarization</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retrieving polarization information for modelfit components.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_polarization</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fit_comp_polarization</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Trying to fit component polarization, but no uvf file loaded!&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not fitting component polarization&quot;</span><span class="p">)</span>


        <span class="n">hdu_list</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1">#calculate cleaned flux density from mod files</span>
        <span class="c1">#first stokes I</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">integrated_flux_clean</span><span class="o">=</span><span class="n">total_flux_from_mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_clean/&quot;</span>  <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">integrated_flux_clean</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">#and then polarization</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flux_q</span><span class="o">=</span><span class="n">total_flux_from_mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_q/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span>
                                       <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span><span class="p">)</span>
            <span class="n">flux_u</span><span class="o">=</span><span class="n">total_flux_from_mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_u/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span>
                                       <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">integrated_pol_flux_clean</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">flux_u</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">flux_q</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frac_pol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrated_pol_flux_clean</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrated_flux_clean</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evpa_average</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">flux_u</span><span class="p">,</span><span class="n">flux_q</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">integrated_pol_flux_clean</span><span class="o">=</span><span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frac_pol</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#correct rician bias</span>
        <span class="k">if</span> <span class="n">correct_rician_bias</span><span class="p">:</span>
            <span class="n">lin_pol_sqr</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_noise</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">lin_pol_sqr</span><span class="p">[</span><span class="n">lin_pol_sqr</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lin_pol_sqr</span><span class="p">)</span>

        <span class="c1"># initialize mask</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="c1">#test masking</span>
            <span class="c1">#self.mask[0:200]=np.ones_like(self.Z[0:200],dtype=bool)</span>
            <span class="c1">#self.masking(mask_type=&quot;cut_left&quot;,args=-200)</span>
            <span class="c1">#set mask where Image is None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)]</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Mask input format invalid, Mask reset to no mask.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span>

        <span class="c1"># additional parameters only used for spectral index type data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_spix</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spix</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spix_vmin</span><span class="o">=-</span><span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spix_vmax</span><span class="o">=</span><span class="mi">5</span>

        <span class="c1">#additional parameter only used for rotation measure data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_rm</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rm</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rm_vmin</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rm_vmax</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

        <span class="c1"># additional parameter only used for Spectral turnover data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_turnover</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnover</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnover_flux</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnover_error</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnover_chi_sq</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#print function for ImageData</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">freq_ghz</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image of the source </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> at frequency </span><span class="si">{</span><span class="n">freq_ghz</span><span class="si">}</span><span class="s2"> GHz on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Total cleaned flux: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">integrated_flux_clean</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> mJy </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Image Noise: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> mJy using method &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_method</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1">#polarization info</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evpa</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="c1">#print polarization info if pol data was loaded</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Polarization information:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Pol Flux: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">integrated_pol_flux_clean</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> mJy (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">frac_pol</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Pol Noise: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pol_noise</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> mJy using method &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_method</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Average EVPA direction: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">evpa_average</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">°</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No polarization data loaded.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1">#model info</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Model information: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No model loaded. Clean model info: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">model_flux</span> <span class="o">=</span> <span class="n">total_flux_from_mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="p">)</span>
            <span class="n">num_comps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Model Flux: </span><span class="si">{</span><span class="n">model_flux</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> mJy </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Number of Components: </span><span class="si">{</span><span class="n">num_comps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;No data loaded yet.&quot;</span>

    <span class="k">def</span> <span class="nf">write_mod_file_from_casa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span><span class="n">export</span><span class="o">=</span><span class="s2">&quot;export.mod&quot;</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Writes a .mod file from a CASA exported .fits model file.</span>
<span class="sd">            Args:</span>
<span class="sd">                file_path: File path to a .fits model file as exported from a CASA .model file (e.g. with exportfits() in CASA)</span>
<span class="sd">                channel: Choose the Stokes channel to use (options: &quot;i&quot;,&quot;q&quot;,&quot;u&quot;,&quot;v&quot;)</span>
<span class="sd">                export: File path where to write the .mod file</span>

<span class="sd">            Returns:</span>
<span class="sd">                Nothing, but writes a .mod file to export</span>
<span class="sd">            &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">channel</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
            <span class="n">clean_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span>
        <span class="k">elif</span> <span class="n">channel</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
            <span class="n">clean_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span>
        <span class="k">elif</span> <span class="n">channel</span> <span class="o">==</span> <span class="s2">&quot;u&quot;</span><span class="p">:</span>
            <span class="n">clean_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please enter a valid channel (i,q,u)&quot;</span><span class="p">)</span>

        <span class="c1"># read out clean components from pixel map</span>
        <span class="n">delta_x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">delta_y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">zeros</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">clean_map</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">delta_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                    <span class="n">delta_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                    <span class="n">flux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clean_map</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">zeros</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="c1"># create model_df</span>
        <span class="n">model_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;Flux&#39;</span><span class="p">:</span> <span class="n">flux</span><span class="p">,</span>
             <span class="s1">&#39;Delta_x&#39;</span><span class="p">:</span> <span class="n">delta_x</span><span class="p">,</span>
             <span class="s1">&#39;Delta_y&#39;</span><span class="p">:</span> <span class="n">delta_y</span><span class="p">,</span>
             <span class="s1">&#39;Major_axis&#39;</span><span class="p">:</span> <span class="n">zeros</span><span class="p">,</span>
             <span class="s1">&#39;Minor_axis&#39;</span><span class="p">:</span> <span class="n">zeros</span><span class="p">,</span>
             <span class="s1">&#39;PA&#39;</span><span class="p">:</span> <span class="n">zeros</span><span class="p">,</span>
             <span class="s1">&#39;Typ_obj&#39;</span><span class="p">:</span> <span class="n">zeros</span>
             <span class="p">})</span>

        <span class="c1"># create mod file</span>
        <span class="n">write_mod_file</span><span class="p">(</span><span class="n">model_df</span><span class="p">,</span> <span class="n">export</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_pixel_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">image</span><span class="o">=</span><span class="s2">&quot;stokes_i&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get value of a specific pixel from an image</span>

<span class="sd">        Args:</span>
<span class="sd">            x (float): X position in mas</span>
<span class="sd">            y (float): Y position in mas</span>
<span class="sd">            image (str): Select Image to get value from (&#39;stokes_i&#39;,&#39;stokes_q&#39;,&quot;stokes_u&quot;,&quot;lin_pol&quot;,&quot;evpa&quot;)</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Xind</span><span class="o">=</span><span class="n">closest_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
        <span class="n">Yind</span><span class="o">=</span><span class="n">closest_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;stokes_i&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">[</span><span class="n">Yind</span><span class="p">,</span><span class="n">Xind</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;stokes_q&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="p">[</span><span class="n">Yind</span><span class="p">,</span><span class="n">Xind</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;stokes_q&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="p">[</span><span class="n">Yind</span><span class="p">,</span><span class="n">Xind</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;stokes_u&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="p">[</span><span class="n">Yind</span><span class="p">,</span><span class="n">Xind</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;lin_pol&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="p">[</span><span class="n">Yind</span><span class="p">,</span><span class="n">Xind</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;evpa&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">evpa</span><span class="p">[</span><span class="n">Yind</span><span class="p">,</span><span class="n">Xind</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create copy of the current ImageData object</span>

<span class="sd">        Returns:</span>
<span class="sd">            image (ImageData): Copied image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outputfile</span><span class="p">,</span><span class="n">polarization</span><span class="o">=</span><span class="s2">&quot;I&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to export fits file</span>

<span class="sd">        Args:</span>
<span class="sd">            outputfile (str): Name/path of the intended output file</span>
<span class="sd">            polarization (str): Polarization to export (&#39;I&#39;,&#39;Q&#39;,&#39;U&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">polarization</span><span class="o">==</span><span class="s2">&quot;I&quot;</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cp </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">outputfile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stokes </span><span class="si">{</span><span class="n">polarization</span><span class="si">}</span><span class="s2"> succesfully exported to </span><span class="si">{</span><span class="n">outputfile</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">polarization</span><span class="o">==</span><span class="s2">&quot;Q&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_path</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stokes </span><span class="si">{</span><span class="n">polarization</span><span class="si">}</span><span class="s2"> succesfully exported to </span><span class="si">{</span><span class="n">outputfile</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cp </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">outputfile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stokes </span><span class="si">{</span><span class="n">polarization</span><span class="si">}</span><span class="s2"> succesfully exported to </span><span class="si">{</span><span class="n">outputfile</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">polarization</span><span class="o">==</span><span class="s2">&quot;U&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_path</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stokes </span><span class="si">{</span><span class="n">polarization</span><span class="si">}</span><span class="s2"> succesfully exported to </span><span class="si">{</span><span class="n">outputfile</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cp </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">outputfile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stokes </span><span class="si">{</span><span class="n">polarization</span><span class="si">}</span><span class="s2"> succesfully exported to </span><span class="si">{</span><span class="n">outputfile</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">regrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">npix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">pixel_size</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">useDIFMAP</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mask_outside</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method regrids the image in full polarization</span>

<span class="sd">        Args:</span>
<span class="sd">            npix (int): Number of pixels in ONE direction</span>
<span class="sd">            pixel_size (float): Size of pixel in image scale units (usually mas)</span>
<span class="sd">            useDIFMAP (bool): Choose whether to regrid using DIFMAP or not</span>
<span class="sd">            mask_outside (bool): Choose whether new image ares created through regridding will be masked automatically (bool)</span>

<span class="sd">        Returns:</span>
<span class="sd">            regridded ImageData object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Regridding Image&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">==</span><span class="n">npix</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span><span class="o">==</span><span class="n">npix</span> <span class="ow">and</span> <span class="n">pixel_size</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="n">n2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>

        <span class="c1"># Original grid (centered)</span>
        <span class="n">x_old</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">n2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
        <span class="n">y_old</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">n1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="c1"># New grid (centered)</span>
        <span class="n">x_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">npix</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">pixel_size</span>
        <span class="n">y_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">npix</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">pixel_size</span>

        <span class="c1"># Generate new grid coordinates</span>
        <span class="n">X_new</span><span class="p">,</span> <span class="n">Y_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_new</span><span class="p">,</span> <span class="n">y_new</span><span class="p">)</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Y_new</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">X_new</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># define interpolator</span>
        <span class="k">def</span> <span class="nf">interpolator</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">interpolator</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">((</span><span class="n">y_old</span><span class="p">,</span> <span class="n">x_old</span><span class="p">),</span> <span class="n">image</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                   <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">interpolator</span>

        <span class="c1"># regrid mask</span>
        <span class="k">if</span> <span class="n">mask_outside</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span>


        <span class="n">new_mask</span> <span class="o">=</span> <span class="n">interpolator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">fill_value</span><span class="p">)(</span><span class="n">points</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>  <span class="c1"># flags new points automatically</span>
        <span class="n">new_mask</span><span class="p">[</span><span class="n">new_mask</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">new_mask</span><span class="p">[</span><span class="n">new_mask</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="o">==</span><span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="n">useDIFMAP</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="c1"># Interpolate values at new grid points</span>
            <span class="n">new_image_i</span> <span class="o">=</span> <span class="n">interpolator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)(</span><span class="n">points</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>

            <span class="c1">#try polarization</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_image_q</span> <span class="o">=</span> <span class="n">interpolator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="p">)(</span><span class="n">points</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>
                <span class="n">new_image_u</span> <span class="o">=</span> <span class="n">interpolator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="p">)(</span><span class="n">points</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to regrid polarization, probably no polarization loaded&quot;</span><span class="p">)</span>


            <span class="c1"># write outputs to the fits files</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">only_stokes_i</span><span class="p">:</span>
                <span class="c1"># this means DIFMAP style fits image</span>
                <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="c1">#overwrite image data</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">))</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_i</span>
                    <span class="n">new_stokes_i_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_clean/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span> <span class="c1">#This is a bug fix that is needed for some .fits files, otherwise writeto throws an error</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1">#modify header parameters to new npix and pixelsize</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">npix</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">npix</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">]</span><span class="o">=-</span><span class="n">pixel_size</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT2&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">pixel_size</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="n">npix</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="n">npix</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_i_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="c1"># overwrite image data</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">))</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_q</span>
                        <span class="n">new_stokes_q_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_q/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>  <span class="c1"># This is a bug fix that is needed for some .fits files, otherwise writeto throws an error</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="c1"># modify header parameters to new npix and pixelsize</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npix</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npix</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">pixel_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">npix</span><span class="p">)</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">npix</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_q_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_stokes_q_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>


                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="c1"># overwrite image data</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">))</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_u</span>
                        <span class="n">new_stokes_u_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_u/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>  <span class="c1"># This is a bug fix that is needed for some .fits files, otherwise writeto throws an error</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="c1"># modify header parameters to new npix and</span>
                        <span class="c1"># pixelsize</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npix</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npix</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">pixel_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">npix</span><span class="p">)</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">npix</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_u_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_stokes_u_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># CASA style</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">)</span>
                <span class="c1"># overwrite image data</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">))</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_i</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_q</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_u</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npix</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npix</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">pixel_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">npix</span><span class="p">)</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">npix</span><span class="p">)</span>
                <span class="n">new_stokes_i_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_clean/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_i_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                <span class="n">new_stokes_q_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
                <span class="n">new_stokes_u_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

            <span class="c1">#if model loaded try regridding as well</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">new_image_model</span> <span class="o">=</span> <span class="n">interpolator</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])(</span><span class="n">points</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span><span class="n">npix</span><span class="p">)</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">))</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_model</span>
                            <span class="n">new_model_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_model/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>  <span class="c1"># This is a bug fix that is needed for some .fits files, otherwise writeto throws an error</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npix</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npix</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">pixel_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="n">npix</span><span class="p">)</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="n">npix</span><span class="p">)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_model_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_model_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_model_fits</span><span class="o">=</span><span class="n">new_stokes_i_fits</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Model not regridded, probably no model loaded.&quot;</span><span class="p">)</span>
                <span class="n">new_model_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">npix</span><span class="o">=</span><span class="n">npix</span><span class="o">*</span><span class="mi">2</span> <span class="c1">#DIFMAP npix convention</span>
            <span class="c1">#Using DIFMAP</span>
            <span class="c1"># restore Stokes I</span>
            <span class="n">new_stokes_i_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.mod&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="n">fold_with_beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">],</span> <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                           <span class="n">bmaj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_clean&quot;</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="n">new_stokes_i_fits</span><span class="p">,</span>
                           <span class="n">n_pixel</span><span class="o">=</span><span class="n">npix</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="n">pixel_size</span><span class="p">,</span>
                           <span class="n">mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">],</span><span class="n">clean_mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">],</span> <span class="n">uvf_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">],</span>
                           <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span><span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

            <span class="n">new_stokes_i_fits</span> <span class="o">+=</span> <span class="s2">&quot;.fits&quot;</span>

            <span class="c1"># try to restore modelfit if it is there</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">:</span>
                    <span class="n">new_model_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.mod&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                    <span class="n">fold_with_beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">],</span> <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                                   <span class="n">bmaj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                   <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_model&quot;</span><span class="p">,</span>
                                   <span class="n">outname</span><span class="o">=</span><span class="n">new_model_fits</span><span class="p">,</span>
                                   <span class="n">n_pixel</span><span class="o">=</span><span class="n">npix</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="n">pixel_size</span><span class="p">,</span>
                                   <span class="n">mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="p">],</span><span class="n">clean_mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">],</span> <span class="n">uvf_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">],</span>
                                   <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span><span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

                    <span class="n">new_model_fits</span> <span class="o">+=</span> <span class="s2">&quot;.fits&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_model_fits</span> <span class="o">=</span> <span class="n">new_stokes_i_fits</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">new_model_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="c1"># try to restore polarization as well if it is there</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_stokes_q_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.mod&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">new_stokes_u_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.mod&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="n">fold_with_beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">],</span> <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                               <span class="n">bmaj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_q&quot;</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="n">new_stokes_q_fits</span><span class="p">,</span>
                               <span class="n">n_pixel</span><span class="o">=</span><span class="n">npix</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="n">pixel_size</span><span class="p">,</span>
                               <span class="n">mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="p">],</span><span class="n">clean_mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">],</span> <span class="n">uvf_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">],</span>
                               <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span><span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

                <span class="n">new_stokes_q_fits</span> <span class="o">+=</span> <span class="s2">&quot;.fits&quot;</span>

                <span class="n">fold_with_beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">],</span> <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                               <span class="n">bmaj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_u&quot;</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="n">new_stokes_u_fits</span><span class="p">,</span>
                               <span class="n">n_pixel</span><span class="o">=</span><span class="n">npix</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="n">pixel_size</span><span class="p">,</span>
                               <span class="n">mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="p">],</span> <span class="n">clean_mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">],</span><span class="n">uvf_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">],</span>
                               <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span><span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

                <span class="n">new_stokes_u_fits</span> <span class="o">+=</span> <span class="s2">&quot;.fits&quot;</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="n">new_stokes_q_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">new_stokes_u_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_inp</span><span class="p">:</span>
            <span class="n">new_model_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">return</span> <span class="n">ImageData</span><span class="p">(</span><span class="n">fits_file</span><span class="o">=</span><span class="n">new_stokes_i_fits</span><span class="p">,</span>
                         <span class="n">uvf_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">,</span>
                         <span class="n">stokes_q</span><span class="o">=</span><span class="n">new_stokes_q_fits</span><span class="p">,</span>
                         <span class="n">stokes_u</span><span class="o">=</span><span class="n">new_stokes_u_fits</span><span class="p">,</span>
                         <span class="n">mask</span><span class="o">=</span><span class="n">new_mask</span><span class="p">,</span>
                         <span class="n">ridgeline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="p">,</span>
                         <span class="n">redshift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">,</span>
                         <span class="n">counter_ridgeline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="p">,</span>
                         <span class="n">noise_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_method</span><span class="p">,</span>
                         <span class="n">model_save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="p">,</span>
                         <span class="n">model</span><span class="o">=</span><span class="n">new_model_fits</span><span class="p">,</span>
                         <span class="n">correct_rician_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">correct_rician_bias</span><span class="p">,</span>
                         <span class="n">comp_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                         <span class="n">core_comp_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span>
                         <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                         <span class="n">fit_comp_polarization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol</span><span class="p">,</span>
                         <span class="n">fit_comp_pol_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol_errors</span><span class="p">,</span>
                         <span class="n">uvw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span>
                         <span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">savefig</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;stokes_i_sigma_cut&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;plot_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;stokes_i&quot;</span><span class="p">,</span>
            <span class="s2">&quot;im_colormap&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;contour&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;contour_color&quot;</span><span class="p">:</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span>
            <span class="s2">&quot;contour_cmap&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;contour_alpha&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;contour_width&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="s2">&quot;im_color&quot;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s2">&quot;do_colorbar&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;plot_ridgeline&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;ridgeline_color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plot_counter_ridgeline&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;counter_ridgeline_color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plot_line&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;line_color&quot;</span> <span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="s2">&quot;line_width&quot;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;plot_polar&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;plot_beam&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;beam_color&quot;</span><span class="p">:</span> <span class="s2">&quot;grey&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plot_model&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;component_color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plot_comp_ids&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;plot_comp_evpas&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;plot_clean&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;plot_mask&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;xlim&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;ylim&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;plot_evpa&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;evpa_width&quot;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
            <span class="s2">&quot;evpa_len&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;lin_pol_sigma_cut&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;evpa_distance&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;fractional_evpa_distance&quot;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span>
            <span class="s2">&quot;rotate_evpa&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;colorbar_loc&quot;</span><span class="p">:</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span>
            <span class="s2">&quot;evpa_color&quot;</span><span class="p">:</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;background_color&quot;</span><span class="p">:</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span>
            <span class="s2">&quot;font_size_axis_title&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="s2">&quot;font_size_axis_tick&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="s2">&quot;rcparams&quot;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">defaults</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>
        <span class="n">plot</span><span class="o">=</span><span class="n">FitsImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">savefig</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">plot</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">savefig</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">plot</span>

    <span class="k">def</span> <span class="nf">align</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">image_data2</span><span class="p">,</span><span class="n">masked_shift</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;cross_correlation&quot;</span><span class="p">,</span><span class="n">beam_arg</span><span class="o">=</span><span class="s2">&quot;common&quot;</span><span class="p">,</span> <span class="n">auto_regrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">useDIFMAP</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">comp_ids</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">weight_by_comp_err</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function aligns the image to a reference image (image_data2).</span>

<span class="sd">        Args:</span>
<span class="sd">            image_data2 (ImageData): ImageData object of the reference image</span>
<span class="sd">            masked_shift (bool): Choose whether to consider the image masks for alignment</span>
<span class="sd">            method: Choose alignment method (Options: &#39;cross_correlation&#39;, &#39;brightest&#39;, &#39;modelcomp&#39;)</span>
<span class="sd">            beam_arg (str): Choose which common beam to use (Options: &#39;common&#39;, &#39;max&#39;, &#39;min&#39;), only applied when auto_regrid=True</span>
<span class="sd">            auto_regrid (bool): Choose whether to automatically regrid and restore both images to a common beam and image size.</span>
<span class="sd">            useDIFMAP (bool): Choose whether to use DIFMAP for image operations or not.</span>
<span class="sd">            comp_ids (int or list[int]): Component IDs to use for the alignment in &#39;modelcomp&#39; mode.</span>

<span class="sd">        Returns:</span>
<span class="sd">            image (ImageData): aligned imaged (possibly also regridded and restored if auto_regrid=True).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">==</span><span class="n">image_data2</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">image_data2</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">!=</span> <span class="n">image_data2</span><span class="o">.</span><span class="n">degpp</span><span class="p">)</span> <span class="ow">or</span> <span class="n">auto_regrid</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">auto_regrid</span><span class="p">:</span>
                <span class="c1"># if this is selected will automatically convolve with common beam and regrid</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Automatically regridding image to minimum pixelsize, smallest FOV and common beam&quot;</span><span class="p">)</span>

                <span class="c1">#determin common image parameters</span>
                <span class="n">pixel_size</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span><span class="n">image_data2</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="n">image_data2</span><span class="o">.</span><span class="n">scale</span><span class="p">])</span>
                <span class="c1">#TODO: change this to maximum FoV? (to make sure no information is lost in any map)</span>
                <span class="c1"># aligning this also with the edit by FMP in image_cube.py regrid function</span>
                <span class="n">min_fov</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span><span class="n">image_data2</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">image_data2</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">])</span>
                <span class="n">npix</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">min_fov</span><span class="o">/</span><span class="n">pixel_size</span><span class="p">)</span>

                <span class="c1">#get common beam</span>
                <span class="n">common_beam</span><span class="o">=</span><span class="n">get_common_beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span><span class="n">image_data2</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">],</span>
                                            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span><span class="n">image_data2</span><span class="o">.</span><span class="n">beam_min</span><span class="p">],</span>
                                            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">,</span><span class="n">image_data2</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">],</span><span class="n">arg</span><span class="o">=</span><span class="n">beam_arg</span><span class="p">)</span>

                <span class="c1">#regrid images</span>
                <span class="n">image_self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="c1"># convolve with common beam</span>
                <span class="n">image_self</span> <span class="o">=</span> <span class="n">image_self</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">useDIFMAP</span><span class="o">=</span><span class="n">useDIFMAP</span><span class="p">)</span>
                <span class="n">image_self</span> <span class="o">=</span> <span class="n">image_self</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">common_beam</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">common_beam</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">common_beam</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">useDIFMAP</span><span class="o">=</span><span class="n">useDIFMAP</span><span class="p">)</span>

                <span class="c1"># same for image 2</span>
                <span class="n">image_data2</span> <span class="o">=</span> <span class="n">image_data2</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">useDIFMAP</span><span class="o">=</span><span class="n">useDIFMAP</span><span class="p">)</span>
                <span class="n">image_data2</span> <span class="o">=</span> <span class="n">image_data2</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">common_beam</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">common_beam</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">common_beam</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">useDIFMAP</span><span class="o">=</span><span class="n">useDIFMAP</span><span class="p">)</span>



            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">method</span><span class="o">==</span><span class="s2">&quot;modelcomp&quot;</span> <span class="ow">or</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;model_comp&quot;</span> <span class="ow">or</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;model&quot;</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Images do not have the same npix and pixelsize, please regrid first or use auto_regrid=True.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">image_self</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">image_self</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;cross_correlation&quot;</span> <span class="ow">or</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;crosscorrelation&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">image_data2</span><span class="o">.</span><span class="n">mask</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">image_self</span><span class="o">.</span><span class="n">mask</span><span class="o">==</span><span class="kc">False</span><span class="p">))</span> <span class="ow">or</span> <span class="n">masked_shift</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>

                <span class="n">shift</span><span class="p">,</span><span class="n">error</span><span class="p">,</span><span class="n">diffphase</span> <span class="o">=</span> <span class="n">phase_cross_correlation</span><span class="p">(</span><span class="n">image_data2</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="n">image_self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="n">upsample_factor</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;will apply shift (x,y): [</span><span class="si">{}</span><span class="s1"> : </span><span class="si">{}</span><span class="s1">] </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span> <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># contrary to the skikit-image documentation, only the shift is returned for masked cross-correlation</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="n">phase_cross_correlation</span><span class="p">(</span><span class="n">image_data2</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="n">image_self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="n">upsample_factor</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">reference_mask</span><span class="o">=</span><span class="n">image_data2</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span><span class="n">moving_mask</span><span class="o">=</span><span class="n">image_self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;will apply shift (x,y): [</span><span class="si">{}</span><span class="s1"> : </span><span class="si">{}</span><span class="s1">] </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span> <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;brightest&quot;</span><span class="p">:</span>
            <span class="c1">#align images on brightest pixel</span>
            <span class="c1">#find brightest pixel of reference image and image</span>
            <span class="n">x_ind</span><span class="p">,</span><span class="n">y_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">image_data2</span><span class="o">.</span><span class="n">Z</span><span class="p">),</span> <span class="n">image_data2</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">x_</span><span class="p">,</span><span class="n">y_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">image_self</span><span class="o">.</span><span class="n">Z</span><span class="p">),</span> <span class="n">image_self</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="n">shift</span><span class="o">=</span><span class="p">[</span><span class="n">y_ind</span><span class="o">-</span><span class="n">y_</span><span class="p">,</span><span class="n">x_ind</span><span class="o">-</span><span class="n">x_</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;will apply shift (x,y): [</span><span class="si">{}</span><span class="s1"> : </span><span class="si">{}</span><span class="s1">] </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">image_self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span>
                                                                 <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">image_self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;modelcomp&quot;</span> <span class="ow">or</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;model_comp&quot;</span> <span class="ow">or</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;model&quot;</span><span class="p">:</span>
            <span class="c1">#get models of both images</span>
            <span class="n">comps1</span><span class="o">=</span><span class="n">image_self</span><span class="o">.</span><span class="n">components</span>
            <span class="n">ref_comps</span><span class="o">=</span><span class="n">image_data2</span><span class="o">.</span><span class="n">components</span>

            <span class="k">if</span> <span class="n">comp_ids</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please specify valid component IDs with &#39;comp_ids=...&#39;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">comp_ids</span><span class="o">==</span><span class="s2">&quot;all&quot;</span><span class="p">:</span>
                    <span class="c1">#find all possible component ids</span>
                    <span class="n">comp_ids</span><span class="o">=</span><span class="p">[]</span>
                    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">image_self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                        <span class="n">comp_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">component_number</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">image_data2</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                        <span class="n">comp_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">component_number</span><span class="p">)</span>

                    <span class="n">comp_ids</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">comp_ids</span><span class="p">)</span>

                <span class="n">comp_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">comp_ids</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp_ids</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">comp_ids</span>
                <span class="n">x_shifts</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">y_shifts</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">x_shift_err</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">y_shift_err</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">for</span> <span class="n">comp_id</span> <span class="ow">in</span> <span class="n">comp_ids</span><span class="p">:</span>
                    <span class="c1">#get component from comps1:</span>
                    <span class="n">found</span><span class="o">=</span><span class="kc">False</span>
                    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">component_number</span><span class="o">==</span><span class="n">comp_id</span><span class="p">:</span>
                            <span class="n">align_comp</span><span class="o">=</span><span class="n">comp</span>
                            <span class="n">found</span><span class="o">=</span><span class="kc">True</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                        <span class="n">align_comp</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
                    <span class="n">found</span><span class="o">=</span><span class="kc">False</span>
                    <span class="k">for</span> <span class="n">ref_comp</span> <span class="ow">in</span> <span class="n">ref_comps</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ref_comp</span><span class="o">.</span><span class="n">component_number</span><span class="o">==</span><span class="n">comp_id</span><span class="p">:</span>
                            <span class="n">align_comp_ref</span><span class="o">=</span><span class="n">ref_comp</span>
                            <span class="n">found</span><span class="o">=</span><span class="kc">True</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                        <span class="n">align_comp_ref</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

                    <span class="k">if</span> <span class="n">align_comp</span><span class="o">!=</span><span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">align_comp_ref</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="c1">#this means a component with the given comp_id was found in both images</span>
                        <span class="c1">#calculate shift:</span>
                        <span class="n">x1</span><span class="o">=</span><span class="n">align_comp</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span>
                        <span class="n">x_ref</span><span class="o">=</span><span class="n">align_comp_ref</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">image_data2</span><span class="o">.</span><span class="n">scale</span>
                        <span class="n">y1</span><span class="o">=</span><span class="n">align_comp</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span>
                        <span class="n">y_ref</span><span class="o">=</span><span class="n">align_comp_ref</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">image_data2</span><span class="o">.</span><span class="n">scale</span>

                        <span class="n">x_shifts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">x_ref</span><span class="p">)</span>
                        <span class="n">y_shifts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_ref</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span>
                        <span class="n">x_shift_err</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">align_comp</span><span class="o">.</span><span class="n">x_err</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">align_comp_ref</span><span class="o">.</span><span class="n">x_err</span><span class="o">*</span><span class="n">image_data2</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                        <span class="n">y_shift_err</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">align_comp</span><span class="o">.</span><span class="n">y_err</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">align_comp_ref</span><span class="o">.</span><span class="n">y_err</span><span class="o">*</span><span class="n">image_data2</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Did no find component with id </span><span class="si">{</span><span class="n">comp_id</span><span class="si">}</span><span class="s2"> in both images, skipping it&quot;</span><span class="p">)</span>

                <span class="c1">#take mean shift if multiple components were used</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No matching components found, will not apply a shift.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">weight_by_comp_err</span><span class="p">:</span>
                        <span class="c1"># Compute weights as inverse variance</span>
                        <span class="n">weights_x</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_shift_err</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                        <span class="n">weights_y</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_shift_err</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

                        <span class="c1"># Weighted mean</span>
                        <span class="n">x_shift_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights_x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights_x</span><span class="p">)</span>
                        <span class="n">y_shift_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights_y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights_y</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">x_shift_final</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">)</span>
                        <span class="n">y_shift_final</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">)</span>

                    <span class="n">shift</span><span class="o">=</span><span class="p">[</span><span class="n">y_shift_final</span><span class="o">/</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span><span class="n">x_shift_final</span><span class="o">/</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;will apply shift (x,y): [</span><span class="si">{}</span><span class="s1"> : </span><span class="si">{}</span><span class="s1">] </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">image_self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span>
                                                                       <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">image_self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>


        <span class="k">else</span><span class="p">:</span>
            <span class="n">warning</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Please use valid align method (&#39;cross_correlation&#39;,&#39;brightest&#39;).&quot;</span><span class="p">)</span>

        <span class="c1">#shift shifted image</span>
        <span class="k">return</span> <span class="n">image_self</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span><span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span><span class="n">useDIFMAP</span><span class="o">=</span><span class="n">useDIFMAP</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">bmaj</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">bmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">posa</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">shift_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">shift_y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">npix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">pixel_size</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">useDIFMAP</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mask_outside</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This allows you to restore the ImageData object with a custom beam either with DIFMAP or just the image itself</span>

<span class="sd">        Args:</span>
<span class="sd">            bmaj (float): Beam major axis (in mas)</span>
<span class="sd">            bmin (float): Beam minor axis (in mas)</span>
<span class="sd">            posa (float): Beam position angle (in deg)</span>
<span class="sd">            shift_x (float): Shift in mas in x-direction</span>
<span class="sd">            shift_y (float): Shift in mas in y-direction</span>
<span class="sd">            npix (int): Number of pixels in one image direction</span>
<span class="sd">            pixel_size (float): pixel size in mas</span>
<span class="sd">            useDIFMAP (bool): Choose whether to use DIFMAP for the restoring or not</span>

<span class="sd">        Returns:</span>
<span class="sd">            image (ImageData): New ImageData object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">bmaj</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">bmaj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span>
        <span class="k">if</span> <span class="n">bmin</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">bmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span>
        <span class="k">if</span> <span class="n">posa</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">posa</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span>


        <span class="c1">#TODO basic sanity check if uvf file is present and if polarization is there</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="o">==</span><span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="n">useDIFMAP</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="c1">#this means there is no valid .uvf file or we don&#39;t want to use DIFMAP</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No .uvf file attached or useDIFMAP=False selected, will do simple shift of image only&quot;</span><span class="p">)</span>

            <span class="c1"># shift in degree</span>
            <span class="n">shift_x_deg</span> <span class="o">=</span> <span class="n">shift_x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
            <span class="n">shift_y_deg</span> <span class="o">=</span> <span class="n">shift_y</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

            <span class="c1"># calculate shift to pixel increments:</span>
            <span class="n">shift_x</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">shift_x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">)</span>
            <span class="n">shift_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">shift_y</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">)</span>

            <span class="c1">#shift the image mask</span>
            <span class="n">input_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>  <span class="c1"># before it was np.fft.fftn(img)</span>
            <span class="n">offset_image</span> <span class="o">=</span> <span class="n">fourier_shift</span><span class="p">(</span><span class="n">input_</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="p">[</span><span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">])</span>
            <span class="n">imgalign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">offset_image</span><span class="p">)</span>  <span class="c1"># again before ifftn</span>
            <span class="n">new_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">imgalign</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span>

            <span class="c1"># shift image directly</span>
            <span class="n">input_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>  <span class="c1"># before it was np.fft.fftn(img)</span>
            <span class="n">offset_image</span> <span class="o">=</span> <span class="n">fourier_shift</span><span class="p">(</span><span class="n">input_</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="p">[</span><span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">])</span>
            <span class="n">imgalign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">offset_image</span><span class="p">)</span>  <span class="c1"># again before ifftn</span>
            <span class="n">new_image_i</span> <span class="o">=</span> <span class="n">imgalign</span><span class="o">.</span><span class="n">real</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bmaj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bmin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">posa</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="c1">#convert to jansky per pixel</span>
                <span class="n">new_image_i</span> <span class="o">=</span> <span class="n">JyPerBeam2Jy</span><span class="p">(</span><span class="n">new_image_i</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                <span class="n">new_image_i</span> <span class="o">=</span> <span class="n">convolve_with_elliptical_gaussian</span><span class="p">(</span><span class="n">new_image_i</span><span class="p">,</span> <span class="n">bmaj</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))),</span>
                                                             <span class="n">bmin</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))),</span> <span class="n">posa</span><span class="p">)</span>
                <span class="c1">#convert to jansky per (new) beam</span>
                <span class="n">new_image_i</span> <span class="o">=</span> <span class="n">Jy2JyPerBeam</span><span class="p">(</span><span class="n">new_image_i</span><span class="p">,</span><span class="n">bmaj</span><span class="p">,</span><span class="n">bmin</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
            <span class="c1"># try polarization</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">input_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="p">)</span>  <span class="c1"># before it was np.fft.fftn(img)</span>
                <span class="n">offset_image</span> <span class="o">=</span> <span class="n">fourier_shift</span><span class="p">(</span><span class="n">input_</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="p">[</span><span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">])</span>
                <span class="n">imgalign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">offset_image</span><span class="p">)</span>  <span class="c1"># again before ifftn</span>
                <span class="n">new_image_q</span> <span class="o">=</span> <span class="n">imgalign</span><span class="o">.</span><span class="n">real</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bmaj</span><span class="o">==-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bmin</span> <span class="o">==-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">posa</span><span class="o">==-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">new_image_q</span> <span class="o">=</span> <span class="n">JyPerBeam2Jy</span><span class="p">(</span><span class="n">new_image_q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                    <span class="n">new_image_q</span> <span class="o">=</span> <span class="n">convolve_with_elliptical_gaussian</span><span class="p">(</span><span class="n">new_image_q</span><span class="p">,</span>
                                                                    <span class="n">bmaj</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))),</span>
                                                                    <span class="n">bmin</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))),</span><span class="n">posa</span><span class="p">)</span>
                    <span class="c1"># convert to jansky per (new) beam</span>
                    <span class="n">new_image_q</span> <span class="o">=</span> <span class="n">Jy2JyPerBeam</span><span class="p">(</span><span class="n">new_image_q</span><span class="p">,</span> <span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>

                <span class="n">input_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="p">)</span>  <span class="c1"># before it was np.fft.fftn(img)</span>
                <span class="n">offset_image</span> <span class="o">=</span> <span class="n">fourier_shift</span><span class="p">(</span><span class="n">input_</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="p">[</span><span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">])</span>
                <span class="n">imgalign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">offset_image</span><span class="p">)</span>  <span class="c1"># again before ifftn</span>
                <span class="n">new_image_u</span> <span class="o">=</span> <span class="n">imgalign</span><span class="o">.</span><span class="n">real</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bmaj</span><span class="o">==-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bmin</span> <span class="o">==-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">posa</span><span class="o">==-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">new_image_u</span> <span class="o">=</span> <span class="n">JyPerBeam2Jy</span><span class="p">(</span><span class="n">new_image_u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                    <span class="n">new_image_u</span><span class="o">=</span> <span class="n">convolve_with_elliptical_gaussian</span><span class="p">(</span><span class="n">new_image_u</span><span class="p">,</span><span class="n">bmaj</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))),</span>
                                                                    <span class="n">bmin</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))),</span><span class="n">posa</span><span class="p">)</span>
                    <span class="c1"># convert to jansky per (new) beam</span>
                    <span class="n">new_image_u</span> <span class="o">=</span> <span class="n">Jy2JyPerBeam</span><span class="p">(</span><span class="n">new_image_u</span><span class="p">,</span> <span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="n">new_image_q</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">new_image_u</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">new_stokes_u_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">new_stokes_q_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="c1">#write outputs to the fitsfiles</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">only_stokes_i</span><span class="p">:</span>
                <span class="c1"># this means DIFMAP style fits image</span>
                <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_i</span>
                    <span class="n">new_stokes_i_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_clean/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>
                        <span class="c1">#shift model/clean components</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAX&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift_x_deg</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAY&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift_y_deg</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bmaj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bmin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">posa</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="c1">#Overwrite beam parameters in header</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMAJ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmaj</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmin</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BPA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">posa</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_i_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_q</span>
                        <span class="n">new_stokes_q_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_q/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>
                            <span class="c1"># shift model/clean components</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAX&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift_x_deg</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAY&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift_y_deg</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bmaj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bmin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">posa</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                            <span class="c1"># Overwrite beam parameters in header</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMAJ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmaj</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmin</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BPA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">posa</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_q_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_u</span>
                        <span class="n">new_stokes_u_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_u/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>
                            <span class="c1"># shift model/clean components</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAX&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift_x_deg</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAY&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift_y_deg</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bmaj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bmin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">posa</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                            <span class="c1"># Overwrite beam parameters in header</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMAJ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmaj</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmin</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BPA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">posa</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_u_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># CASA style</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">)</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_i</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_q</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_u</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bmaj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bmin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">posa</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># Overwrite beam parameters in header</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMAJ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmaj</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmin</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BPA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">posa</span>
                <span class="n">new_stokes_i_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_clean/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_i_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="n">new_stokes_q_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
                <span class="n">new_stokes_u_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

            <span class="c1"># if model loaded try shifting model image as well</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">:</span>
                    <span class="n">input_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span>
                        <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>  <span class="c1"># before it was np.fft.fftn(img)</span>
                    <span class="n">offset_image</span> <span class="o">=</span> <span class="n">fourier_shift</span><span class="p">(</span><span class="n">input_</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="p">[</span><span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">])</span>
                    <span class="n">imgalign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">offset_image</span><span class="p">)</span>  <span class="c1"># again before ifftn</span>
                    <span class="n">new_image_model</span> <span class="o">=</span> <span class="n">imgalign</span><span class="o">.</span><span class="n">real</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bmaj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bmin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">posa</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">new_image_model</span> <span class="o">=</span> <span class="n">JyPerBeam2Jy</span><span class="p">(</span><span class="n">new_image_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                        <span class="n">new_image_model</span> <span class="o">=</span> <span class="n">convolve_with_elliptical_gaussian</span><span class="p">(</span><span class="n">new_image_model</span><span class="p">,</span>
                                                                            <span class="n">bmaj</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))),</span>
                                                                            <span class="n">bmin</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))),</span>
                                                                            <span class="n">posa</span><span class="p">)</span>
                        <span class="c1"># convert to jansky per (new) beam</span>
                        <span class="n">new_image_model</span> <span class="o">=</span> <span class="n">Jy2JyPerBeam</span><span class="p">(</span><span class="n">new_image_model</span><span class="p">,</span> <span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>

                    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_model</span>
                        <span class="n">new_model_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_model/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAX&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift_x_deg</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAY&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift_y_deg</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bmaj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bmin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">posa</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMAJ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmaj</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmin</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BPA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">posa</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_model_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_model_fits</span> <span class="o">=</span> <span class="n">new_stokes_i_fits</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">new_image_model</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">new_model_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="n">new_uvf_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#This means we have a valid .uvf file and we will use DIFMAP for shifting and restoring</span>
            <span class="c1"># calculate shift to pixel increments:</span>
            <span class="n">shift_x_pix</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">shift_x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">)</span>
            <span class="n">shift_y_pix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">shift_y</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">)</span>

            <span class="c1">#first let&#39;s shift the mask</span>
            <span class="c1"># shift the image mask</span>
            <span class="n">input_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>  <span class="c1"># before it was np.fft.fftn(img)</span>
            <span class="n">offset_image</span> <span class="o">=</span> <span class="n">fourier_shift</span><span class="p">(</span><span class="n">input_</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="p">[</span><span class="n">shift_y_pix</span><span class="p">,</span> <span class="n">shift_x_pix</span><span class="p">])</span>
            <span class="n">imgalign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">offset_image</span><span class="p">)</span>  <span class="c1"># again before ifftn</span>
            <span class="n">new_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">imgalign</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span>

            <span class="c1">#restore Stokes I</span>
            <span class="n">new_stokes_i_fits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.mod&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="n">fold_with_beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">],</span><span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                    <span class="n">bmaj</span><span class="o">=</span><span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=</span><span class="n">bmin</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="n">posa</span><span class="p">,</span><span class="n">shift_x</span><span class="o">=</span><span class="n">shift_x</span><span class="p">,</span><span class="n">shift_y</span><span class="o">=</span><span class="n">shift_y</span><span class="p">,</span>
                    <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span><span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_clean&quot;</span><span class="p">,</span><span class="n">outname</span><span class="o">=</span><span class="n">new_stokes_i_fits</span><span class="p">,</span>
                    <span class="n">n_pixel</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">pixel_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                    <span class="n">mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">],</span><span class="n">clean_mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">],</span>
                    <span class="n">uvf_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">],</span><span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span><span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

            <span class="n">new_stokes_i_fits</span><span class="o">+=</span><span class="s2">&quot;.fits&quot;</span>

            <span class="c1">#try to restore modelfit if it is there</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">:</span>
                    <span class="n">new_model_fits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.mod&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

                    <span class="n">fold_with_beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">],</span> <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                        <span class="n">bmaj</span><span class="o">=</span><span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=</span><span class="n">bmin</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="n">posa</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="n">shift_y</span><span class="p">,</span>
                        <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_model&quot;</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="n">new_model_fits</span><span class="p">,</span>
                        <span class="n">n_pixel</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">pixel_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                        <span class="n">mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="p">],</span> <span class="n">clean_mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">],</span> <span class="n">uvf_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">],</span>
                        <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span><span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

                    <span class="n">new_model_fits</span><span class="o">+=</span><span class="s2">&quot;.fits&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_model_fits</span><span class="o">=</span><span class="n">new_stokes_i_fits</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">new_model_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

            <span class="c1">#try to restore polarization as well if it is there</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_stokes_q_fits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.mod&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">new_stokes_u_fits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.mod&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>


                <span class="n">fold_with_beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">],</span><span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                    <span class="n">bmaj</span><span class="o">=</span><span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=</span><span class="n">bmin</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="n">posa</span><span class="p">,</span><span class="n">shift_x</span><span class="o">=</span><span class="n">shift_x</span><span class="p">,</span><span class="n">shift_y</span><span class="o">=</span><span class="n">shift_y</span><span class="p">,</span>
                    <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;q&quot;</span><span class="p">,</span><span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_q&quot;</span><span class="p">,</span><span class="n">outname</span><span class="o">=</span><span class="n">new_stokes_q_fits</span><span class="p">,</span>
                    <span class="n">n_pixel</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">pixel_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                    <span class="n">mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="p">],</span><span class="n">clean_mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">],</span>
                               <span class="n">uvf_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">],</span><span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span><span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

                <span class="n">new_stokes_q_fits</span><span class="o">+=</span><span class="s2">&quot;.fits&quot;</span>

                <span class="n">fold_with_beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">],</span><span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                    <span class="n">bmaj</span><span class="o">=</span><span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=</span><span class="n">bmin</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="n">posa</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="n">shift_x</span><span class="p">,</span><span class="n">shift_y</span><span class="o">=</span><span class="n">shift_y</span><span class="p">,</span>
                    <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;u&quot;</span><span class="p">,</span><span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_u&quot;</span><span class="p">,</span><span class="n">outname</span><span class="o">=</span><span class="n">new_stokes_u_fits</span><span class="p">,</span>
                    <span class="n">n_pixel</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">pixel_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                    <span class="n">mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="p">],</span><span class="n">clean_mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">],</span>
                               <span class="n">uvf_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">],</span><span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span><span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

                <span class="n">new_stokes_u_fits</span><span class="o">+=</span><span class="s2">&quot;.fits&quot;</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="n">new_stokes_q_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
                <span class="n">new_stokes_u_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

            <span class="n">new_uvf_file</span><span class="o">=</span><span class="n">new_stokes_i_fits</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.fits&quot;</span><span class="p">,</span><span class="s2">&quot;.uvf&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_inp</span><span class="p">:</span>
            <span class="n">new_model_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">return</span> <span class="n">ImageData</span><span class="p">(</span><span class="n">fits_file</span><span class="o">=</span><span class="n">new_stokes_i_fits</span><span class="p">,</span>
                         <span class="n">uvf_file</span><span class="o">=</span><span class="n">new_uvf_file</span><span class="p">,</span>
                         <span class="n">stokes_q</span><span class="o">=</span><span class="n">new_stokes_q_fits</span><span class="p">,</span>
                         <span class="n">stokes_u</span><span class="o">=</span><span class="n">new_stokes_u_fits</span><span class="p">,</span>
                         <span class="n">mask</span><span class="o">=</span><span class="n">new_mask</span><span class="p">,</span>
                         <span class="n">ridgeline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="p">,</span>
                         <span class="n">redshift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">,</span>
                         <span class="n">counter_ridgeline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="p">,</span>
                         <span class="n">noise_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_method</span><span class="p">,</span>
                         <span class="n">model_save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="p">,</span>
                         <span class="n">model</span><span class="o">=</span><span class="n">new_model_fits</span><span class="p">,</span>
                         <span class="n">correct_rician_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">correct_rician_bias</span><span class="p">,</span>
                         <span class="n">comp_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                         <span class="n">core_comp_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span>
                         <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                         <span class="n">fit_comp_polarization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol</span><span class="p">,</span>
                         <span class="n">fit_comp_pol_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol_errors</span><span class="p">,</span>
                         <span class="n">uvw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span>
                         <span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">shift_x</span><span class="p">,</span><span class="n">shift_y</span><span class="p">,</span><span class="n">useDIFMAP</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to shift the image in RA and Dec.</span>

<span class="sd">        Args:</span>
<span class="sd">            shift_x (float): Shift in Right Ascension (in mas)</span>
<span class="sd">            shift_y (float): Shift in Declination (in mas)</span>
<span class="sd">            npix (int): Option to change the number of pixels in ONE direction.</span>
<span class="sd">            pixel_size (float): Option to change the pixel size (in mas)</span>
<span class="sd">            useDIFMAP (bool): Choose whether to use DIFMAP for shifting or not.</span>

<span class="sd">        Returns:</span>
<span class="sd">            image (ImageData): shifted ImageData object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#We can just call the restore() function without doing the restore steps</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">shift_x</span><span class="p">,</span><span class="n">shift_y</span><span class="p">,</span><span class="n">useDIFMAP</span><span class="o">=</span><span class="n">useDIFMAP</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No shift possible, something went wrong!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">masking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_type</span><span class="o">=</span><span class="s1">&#39;ellipse&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">invert_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to mask ImageData object.</span>

<span class="sd">        Args:</span>
<span class="sd">            mask_type: &#39;npix_x&#39;,&#39;cut_left&#39;,&#39;cut_right&#39;,&#39;radius&#39;,&#39;ellipse&#39;,&#39;flux_cut&#39;</span>
<span class="sd">            args: the arguments for the mask</span>
<span class="sd">                &#39;npix_x&#39;: args=[npix_x,npixy]</span>
<span class="sd">                &#39;cut_left&#39;: args = cut_left</span>
<span class="sd">                &#39;cut_right&#39;: args = cut_right</span>
<span class="sd">                &#39;radius&#39;: args = radius</span>
<span class="sd">                &#39;ellipse&#39;: args = {&#39;e_args&#39;: [e_maj,e_min,e_pa], &#39;e_xoffset&#39;: xoff, &#39;e_yoffset&#39;: yoff} all in the image intrinsic unit</span>
<span class="sd">                &#39;flux_cut: args = flux cut</span>
<span class="sd">                    Flags everything above flux_cut times peak brightness</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># cut out inner, optically thick part of the image</span>
        <span class="k">if</span> <span class="n">mask_type</span> <span class="o">==</span> <span class="s1">&#39;npix_x&#39;</span><span class="p">:</span>
            <span class="n">npix_x</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">npix_y</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">px_min_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">npix_x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">px_max_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">npix_x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">px_min_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">npix_y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">px_max_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">npix_y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">px_range_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">px_min_x</span><span class="p">,</span> <span class="n">px_max_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">px_range_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">px_min_y</span><span class="p">,</span> <span class="n">px_max_y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">px_range_y</span><span class="p">,</span> <span class="n">px_range_x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">mask_type</span> <span class="o">==</span> <span class="s1">&#39;cut_left&#39;</span><span class="p">:</span>
            <span class="n">cut_left</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">px_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">+</span> <span class="n">cut_left</span><span class="p">)</span>
            <span class="n">px_range_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">px_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[:,</span> <span class="n">px_range_x</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">mask_type</span> <span class="o">==</span> <span class="s1">&#39;cut_right&#39;</span><span class="p">:</span>
            <span class="n">cut_right</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">px_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">cut_right</span><span class="p">)</span>
            <span class="n">px_range_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">px_max</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[:,</span> <span class="n">px_range_x</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">mask_type</span> <span class="o">==</span> <span class="s1">&#39;radius&#39;</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">rr</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">disk</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">radius</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">rr</span><span class="p">,</span> <span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">mask_type</span> <span class="o">==</span> <span class="s1">&#39;ellipse&#39;</span><span class="p">:</span>
            <span class="n">e_maj</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;e_args&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">e_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;e_args&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">e_pa</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;e_args&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">e_xoffset</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;e_xoffset&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">)</span>
            <span class="n">e_yoffset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;e_yoffset&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">e_xoffset</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">e_yoffset</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">e_xoffset</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">e_yoffset</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">e_pa</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">e_pa</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">e_pa</span> <span class="o">=</span> <span class="n">e_pa</span>
            <span class="n">rr</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">ellipse</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">e_maj</span><span class="p">,</span> <span class="n">e_min</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=-</span><span class="n">e_pa</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">rr</span><span class="p">,</span> <span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">mask_type</span> <span class="o">==</span> <span class="s1">&#39;flux_cut&#39;</span><span class="p">:</span>
            <span class="n">flux_cut</span> <span class="o">=</span> <span class="n">args</span>
            <span class="c1"># mask everything above flux_cut times the peak brightness</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">&gt;</span><span class="n">flux_cut</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">mask_type</span> <span class="o">==</span> <span class="s1">&#39;reset&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">invert_mask</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">angle</span><span class="p">,</span><span class="n">useDIFMAP</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to rotate ImageData Object (note: EVPAs are currently not rotated!)</span>

<span class="sd">        Args:</span>
<span class="sd">            angle (float): Rotation angle in degrees (North through East)</span>
<span class="sd">            useDIFMAP (bool): Choose whether to use DIFMAP or not</span>
<span class="sd">            reshape (bool): If useDIFMAP=False, choose whether to reshape the image size to avoid empty areas.</span>
<span class="sd">            order (int): Order parameter for scipy.ndimage.rotate function</span>

<span class="sd">        Returns:</span>
<span class="sd">            image (ImageData): rotated ImageData object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#rotate mask</span>
        <span class="n">new_mask</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span><span class="o">-</span><span class="n">angle</span><span class="p">,</span><span class="n">reshape</span><span class="o">=</span><span class="n">reshape</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#make sure values are valid</span>
        <span class="n">new_mask</span><span class="p">[</span><span class="n">new_mask</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">new_mask</span><span class="p">[</span><span class="n">new_mask</span> <span class="o">&gt;=</span> <span class="mf">0.1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1">#rotate uvf file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">new_uvf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_clean/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.uvf&quot;</span>

            <span class="n">rotate_uvf_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">,</span> <span class="o">-</span><span class="n">angle</span><span class="p">,</span> <span class="n">new_uvf</span><span class="p">)</span>

        <span class="c1">#rotate ridgeline</span>
        <span class="n">x_new</span><span class="p">,</span><span class="n">y_new</span><span class="o">=</span><span class="n">rotate_points</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">.</span><span class="n">X_ridg</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">.</span><span class="n">Y_ridg</span><span class="p">),</span> <span class="o">-</span><span class="n">angle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">.</span><span class="n">X_ridg</span><span class="o">=</span><span class="n">x_new</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">.</span><span class="n">Y_ridg</span><span class="o">=</span><span class="n">y_new</span>

        <span class="c1">#rotate counterridgeline</span>
        <span class="n">x_new</span><span class="p">,</span> <span class="n">y_new</span> <span class="o">=</span> <span class="n">rotate_points</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="o">.</span><span class="n">X_ridg</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="o">.</span><span class="n">Y_ridg</span><span class="p">),</span> <span class="o">-</span><span class="n">angle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="o">.</span><span class="n">X_ridg</span> <span class="o">=</span> <span class="n">x_new</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="o">.</span><span class="n">Y_ridg</span> <span class="o">=</span> <span class="n">y_new</span>

        <span class="c1">#do actual image rotations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="o">==</span><span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">useDIFMAP</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No .uvf file attached or useDIFMAP=False selected, will do simple shift of image only&quot;</span><span class="p">)</span>

            <span class="n">new_image_i</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="o">-</span><span class="n">angle</span><span class="p">,</span><span class="n">reshape</span><span class="o">=</span><span class="n">reshape</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_image_q</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="p">,</span><span class="o">-</span><span class="n">angle</span><span class="p">,</span><span class="n">reshape</span><span class="o">=</span><span class="n">reshape</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
                <span class="n">new_image_u</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="p">,</span><span class="o">-</span><span class="n">angle</span><span class="p">,</span><span class="n">reshape</span><span class="o">=</span><span class="n">reshape</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to rotate polarization, probably no polarization loaded&quot;</span><span class="p">)</span>

            <span class="c1"># write outputs to the fits files</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">only_stokes_i</span><span class="p">:</span>
                <span class="c1"># this means DIFMAP style fits image</span>
                <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="c1"># overwrite image data</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_i</span>
                    <span class="n">new_stokes_i_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_clean/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>
                        <span class="n">new_x</span><span class="p">,</span><span class="n">new_y</span><span class="o">=</span><span class="n">rotate_points</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAX&quot;</span><span class="p">],</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAY&quot;</span><span class="p">],</span><span class="o">-</span><span class="n">angle</span><span class="p">)</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DELTAX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_x</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DELTAY&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_y</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BPA&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">angle</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_i_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="c1"># overwrite image data</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_q</span>
                        <span class="n">new_stokes_q_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_q/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>
                            <span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span> <span class="o">=</span> <span class="n">rotate_points</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAX&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAY&quot;</span><span class="p">],</span> <span class="o">-</span><span class="n">angle</span><span class="p">)</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DELTAX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_x</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DELTAY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_y</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BPA&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">angle</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_q_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_stokes_q_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="c1"># overwrite image data</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_u</span>
                        <span class="n">new_stokes_u_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_u/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>
                            <span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span> <span class="o">=</span> <span class="n">rotate_points</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAX&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAY&quot;</span><span class="p">],</span> <span class="o">-</span><span class="n">angle</span><span class="p">)</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DELTAX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_x</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DELTAY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_y</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BPA&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">angle</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_u_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_stokes_u_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># CASA style</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">)</span>
                <span class="c1"># overwrite image data</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_i</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_q</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_u</span>
                <span class="n">new_stokes_i_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_clean/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BPA&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">angle</span>
                <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_i_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                <span class="n">new_stokes_q_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">new_stokes_u_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="c1"># if model loaded try rotating as well</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>

                        <span class="n">new_image_model</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="o">-</span><span class="n">angle</span><span class="p">,</span><span class="n">reshape</span><span class="o">=</span><span class="n">reshape</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

                        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_model</span>
                            <span class="n">new_model_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_model/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>
                                <span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span> <span class="o">=</span> <span class="n">rotate_points</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAX&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAY&quot;</span><span class="p">],</span> <span class="o">-</span><span class="n">angle</span><span class="p">)</span>
                                <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DELTAX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_x</span>
                                <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DELTAY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_y</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BPA&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">angle</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_model_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_model_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_model_fits</span> <span class="o">=</span> <span class="n">new_stokes_i_fits</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Model not regridded, probably no model loaded.&quot;</span><span class="p">)</span>
                <span class="n">new_model_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_inp</span><span class="p">:</span>
                <span class="n">new_model_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="o">+=</span><span class="n">angle</span>

            <span class="n">newImageData</span><span class="o">=</span> <span class="n">ImageData</span><span class="p">(</span><span class="n">fits_file</span><span class="o">=</span><span class="n">new_stokes_i_fits</span><span class="p">,</span>
                         <span class="n">uvf_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">,</span>
                         <span class="n">stokes_q</span><span class="o">=</span><span class="n">new_stokes_q_fits</span><span class="p">,</span>
                         <span class="n">stokes_u</span><span class="o">=</span><span class="n">new_stokes_u_fits</span><span class="p">,</span>
                         <span class="n">mask</span><span class="o">=</span><span class="n">new_mask</span><span class="p">,</span>
                         <span class="n">redshift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">,</span>
                         <span class="n">ridgeline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="p">,</span>
                         <span class="n">counter_ridgeline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="p">,</span>
                         <span class="n">noise_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_method</span><span class="p">,</span>
                         <span class="n">model_save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="p">,</span>
                         <span class="n">model</span><span class="o">=</span><span class="n">new_model_fits</span><span class="p">,</span>
                         <span class="n">correct_rician_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">correct_rician_bias</span><span class="p">,</span>
                         <span class="n">comp_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                         <span class="n">core_comp_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span>
                         <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                         <span class="n">fit_comp_polarization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol</span><span class="p">,</span>
                         <span class="n">fit_comp_pol_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol_errors</span><span class="p">,</span>
                         <span class="n">uvw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span>
                         <span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_inp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

            <span class="n">newImageData</span><span class="o">=</span><span class="n">ImageData</span><span class="p">(</span><span class="n">fits_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">,</span>
                         <span class="n">uvf_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">,</span>
                         <span class="n">stokes_q</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_path</span><span class="p">,</span>
                         <span class="n">stokes_u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_path</span><span class="p">,</span>
                         <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span>
                         <span class="n">redshift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">,</span>
                         <span class="n">ridgeline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="p">,</span>
                         <span class="n">counter_ridgeline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="p">,</span>
                         <span class="n">noise_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_method</span><span class="p">,</span>
                         <span class="n">model_save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="p">,</span>
                         <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="p">,</span>
                         <span class="n">correct_rician_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">correct_rician_bias</span><span class="p">,</span>
                         <span class="n">comp_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                         <span class="n">core_comp_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span>
                         <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                         <span class="n">fit_comp_polarization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol</span><span class="p">,</span>
                         <span class="n">fit_comp_pol_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol_errors</span><span class="p">,</span>
                         <span class="n">uvw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span>
                         <span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

            <span class="n">rotate_mod_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">,</span><span class="n">angle</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rotate_mod_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="p">,</span><span class="n">angle</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="p">)</span>
                <span class="n">rotate_mod_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="p">,</span><span class="n">angle</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Could not rotate polarization, probably not loaded.&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rotate_mod_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="p">,</span><span class="n">angle</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Could not rotate model, probably not loaded.&quot;</span><span class="p">)</span>

            <span class="n">newImageData</span><span class="o">.</span><span class="n">uvf_file</span><span class="o">=</span><span class="n">new_uvf</span>
            <span class="n">newImageData</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="n">new_mask</span>
            <span class="n">newImageData</span><span class="o">.</span><span class="n">beam_pa</span><span class="o">+=</span><span class="n">angle</span>

            <span class="n">newImageData</span><span class="o">=</span><span class="n">newImageData</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">newImageData</span>

    <span class="k">def</span> <span class="nf">get_peak_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to calculate the Distance between Stokes I and Linear Polarization Peak</span>

<span class="sd">        Returns:</span>
<span class="sd">            [x_dist,y_dist]: Vector difference between Stokes I and Lin-Pol peak (in mas)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#returns distance between stokes I and lin pol peak</span>

        <span class="c1">#find maximum indices for stokes I and lin_pol</span>
        <span class="n">y_i</span><span class="p">,</span> <span class="n">x_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">y_pol</span><span class="p">,</span> <span class="n">x_pol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">x_dist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">x_pol</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">x_i</span><span class="p">]</span>
        <span class="n">y_dist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">y_pol</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">y_i</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">x_dist</span><span class="p">,</span> <span class="n">y_dist</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;stokes_i&quot;</span><span class="p">,</span><span class="n">useDIFMAP</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to center the brightest pixel of the image.</span>

<span class="sd">        Args:</span>
<span class="sd">            mode: Choose which map to use (&#39;stokes_i&#39;, &#39;lin_pol&#39;,&#39;core&#39;)</span>
<span class="sd">            useDIFMAP: Choose whether to use DIFMAP or not.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Shifted ImageData object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;stokes_i&quot;</span> <span class="ow">or</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;lin_pol&quot;</span> <span class="ow">or</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;linpol&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;stokes_i&quot;</span><span class="p">:</span>
                <span class="n">ref_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span>
            <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;lin_pol&quot;</span> <span class="ow">or</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;linpol&quot;</span><span class="p">:</span>
                <span class="n">ref_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span>

            <span class="c1"># find brightest pixel of reference image and center of current image</span>
            <span class="n">x_ind</span><span class="p">,</span> <span class="n">y_ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">x_</span><span class="p">,</span> <span class="n">y_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">ref_image</span><span class="p">),</span> <span class="n">ref_image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="n">shift</span> <span class="o">=</span> <span class="p">[</span><span class="n">y_ind</span> <span class="o">-</span> <span class="n">y_</span><span class="p">,</span> <span class="n">x_ind</span> <span class="o">-</span> <span class="n">x_</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;will apply shift (x,y): [</span><span class="si">{}</span><span class="s1"> : </span><span class="si">{}</span><span class="s1">] </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span>
                                                                 <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span>
                              <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span> <span class="n">useDIFMAP</span><span class="o">=</span><span class="n">useDIFMAP</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;core&quot;</span><span class="p">:</span>
            <span class="n">core</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_core_component</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">core</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">core</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span><span class="o">-</span><span class="n">core</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">core</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span><span class="n">useDIFMAP</span><span class="o">=</span><span class="n">useDIFMAP</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please pick valid &#39;mode&#39; parameter (&#39;stokes_i&#39;,&#39;lin_pol&#39;,&#39;core&#39;).&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">point1</span><span class="p">,</span><span class="n">point2</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">image</span><span class="o">=</span><span class="s2">&quot;stokes_i&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to obtain a line profile of the image.</span>

<span class="sd">        Args:</span>
<span class="sd">            point1 (list[float]): Starting Point of the profile [x1,y1] (in mas)</span>
<span class="sd">            point2 (list[float]): End Point of the profile [x2,y2] (in mas)</span>
<span class="sd">            show (bool): Choose whether to display a plot of the profile</span>
<span class="sd">            image (bool): Choose map to use (&#39;stokes_i&#39;,&#39;lin_pol&#39;,&#39;evpa&#39;,&#39;spix&#39;,&#39;rm&#39;)</span>

<span class="sd">        Returns:</span>
<span class="sd">            x_values, intensity_profile: Array of the Distance from point1 to point2 and the profile</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#get index of slice ends</span>
        <span class="n">x_ind1</span> <span class="o">=</span> <span class="n">closest_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span><span class="n">point1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">y_ind1</span> <span class="o">=</span> <span class="n">closest_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span><span class="n">point1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">x_ind2</span> <span class="o">=</span> <span class="n">closest_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">point2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">y_ind2</span> <span class="o">=</span> <span class="n">closest_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">point2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1">#select image to get slice from</span>
        <span class="k">if</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;stokes_i&quot;</span><span class="p">:</span>
            <span class="n">image_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span>
        <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;lin_pol&quot;</span><span class="p">:</span>
            <span class="n">image_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span>
        <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;evpa&quot;</span><span class="p">:</span>
            <span class="n">image_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evpa</span>
        <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;spix&quot;</span><span class="p">:</span>
            <span class="n">image_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spix</span>
        <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;rm&quot;</span><span class="p">:</span>
            <span class="n">image_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rm</span>
        <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;frac_pol&quot;</span><span class="p">:</span>
            <span class="n">image_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span>
        <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;stokes_q&quot;</span><span class="p">:</span>
            <span class="n">image_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span>
        <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;stokes_u&quot;</span><span class="p">:</span>
            <span class="n">image_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Please specify valid &#39;image&#39; parameter, image=&#39;</span><span class="si">{</span><span class="n">image</span><span class="si">}</span><span class="s2">&#39; not supported.&quot;</span><span class="p">)</span>

        <span class="n">intensity_profile</span><span class="o">=</span><span class="n">profile_line</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="p">(</span><span class="n">y_ind1</span><span class="p">,</span><span class="n">x_ind1</span><span class="p">),</span> <span class="p">(</span><span class="n">y_ind2</span><span class="p">,</span><span class="n">x_ind2</span><span class="p">))</span>

        <span class="c1">#calculate distance between points</span>
        <span class="n">dist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">point2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">point1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">point2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">point1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1">#get x_values of intensity_profile</span>
        <span class="n">x_values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">intensity_profile</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span><span class="n">intensity_profile</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distance from Point 1 [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Flux Density [Jy/beam]&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">x_values</span><span class="p">,</span> <span class="n">intensity_profile</span>

    <span class="k">def</span> <span class="nf">get_ridgeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;slices&quot;</span><span class="p">,</span><span class="n">angle_for_slices</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">auto_rotate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">jet_angle</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                      <span class="n">cut_radial</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">cut_final</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span><span class="n">counterjet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">j_len</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">start_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">end_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">chi_sq_val</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span><span class="n">err_FWHM</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to calculate the Ridgeline (and Counter-Ridgeline) of an image.</span>

<span class="sd">        Args:</span>
<span class="sd">            method (str): Select method to use (&#39;slices&#39;, &#39;polar&#39;)</span>
<span class="sd">            angle_for_slices (float): Choose angle for the slices method</span>
<span class="sd">            auto_rotate (bool): For the &#39;slices&#39; method, choose whether to automatically detect the jet direction</span>
<span class="sd">            jet_angle (float): If auto_rotate=False, provide the jet_angle in degrees for the &#39;slices&#39; method</span>
<span class="sd">            cut_radial (float): radial SNR Cut for the &#39;slices&#39; method</span>
<span class="sd">            cut_final (float): final SNR cut for the &#39;slices&#39; method</span>
<span class="sd">            counterjet (bool): Choose whether to also fit a counterjet</span>
<span class="sd">            width (int): Jet width in to consider for &#39;slices&#39; method (in pixel)</span>
<span class="sd">            j_len (int): Jet length to consider for &#39;slices&#39; method (in pixel)</span>
<span class="sd">            start_radius (float): Start radius for polar method (in mas)</span>
<span class="sd">            chi_sq_val (float): Chi-squared cut for fits.</span>
<span class="sd">            err_FWHM (float): Relative error of the FWHM to consider for fits</span>

<span class="sd">        Returns:</span>
<span class="sd">            ridgelines (list): Ridgeline and Counter-Ridgeline objects</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;slices&quot;</span><span class="p">:</span>
            <span class="c1">#this is Lucas method with an additional option to auto_rotate.</span>
            <span class="n">image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">auto_rotate</span><span class="p">:</span>
                <span class="c1">#convert image to polar coordinates</span>
                <span class="n">R</span><span class="p">,</span> <span class="n">Theta</span><span class="p">,</span> <span class="n">Z_polar</span> <span class="o">=</span> <span class="n">convert_image_to_polar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>
                <span class="c1">#Integrate over the radius to find jet direction:</span>
                <span class="n">integrated_jet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Theta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="n">integrated_jet</span><span class="o">+=</span><span class="n">Z_polar</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">R</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="c1">#correct for rdTheta in integration</span>
                <span class="c1">#plt.plot(Theta[:,0],integrated_jet)</span>
                <span class="c1">#plt.show()</span>
                <span class="c1">#find maximum flux</span>
                <span class="n">max_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">integrated_jet</span><span class="p">)</span>
                <span class="n">jet_direction</span><span class="o">=</span><span class="n">Theta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="n">max_ind</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Automatically determined jet direction </span><span class="si">{</span><span class="n">jet_direction</span><span class="si">}</span><span class="s2">°.&quot;</span><span class="p">)</span>
                <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="o">-</span><span class="n">jet_direction</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">jet_angle</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="o">-</span><span class="n">jet_angle</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Will assume the jet was already rotated to position angle 0°.&quot;</span><span class="p">)</span>

            <span class="c1"># TODO need to CONVERT IT TO Jy/px????</span>
            <span class="n">image_data</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">Z</span>

            <span class="c1">#if not j_len given, will use full image - 10 pixels at the edge</span>
            <span class="k">if</span> <span class="n">j_len</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">j_len</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span>

            <span class="c1">#get ridgeline</span>
            <span class="n">ridgeline</span><span class="o">=</span><span class="n">Ridgeline</span><span class="p">()</span><span class="o">.</span><span class="n">get_ridgeline_luca</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">],</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span><span class="n">angle_for_slices</span><span class="o">=</span><span class="n">angle_for_slices</span><span class="p">,</span><span class="n">cut_radial</span><span class="o">=</span><span class="n">cut_radial</span><span class="p">,</span>
                                                     <span class="n">cut_final</span><span class="o">=</span><span class="n">cut_final</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span><span class="n">j_len</span><span class="o">=</span><span class="n">j_len</span><span class="p">,</span><span class="n">chi_sq_val</span><span class="o">=</span><span class="n">chi_sq_val</span><span class="p">,</span><span class="n">err_FWHM</span><span class="o">=</span><span class="n">err_FWHM</span><span class="p">)</span>
            <span class="n">image</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">=</span><span class="n">ridgeline</span>

            <span class="k">if</span> <span class="n">counterjet</span><span class="p">:</span>
                <span class="n">counter_ridgeline</span><span class="o">=</span><span class="n">Ridgeline</span><span class="p">()</span><span class="o">.</span><span class="n">get_ridgeline_luca</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">],</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span><span class="n">counterjet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">angle_for_slices</span><span class="o">=</span><span class="n">angle_for_slices</span><span class="p">,</span><span class="n">cut_radial</span><span class="o">=</span><span class="n">cut_radial</span><span class="p">,</span>
                                                     <span class="n">cut_final</span><span class="o">=</span><span class="n">cut_final</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span><span class="n">j_len</span><span class="o">=</span><span class="n">j_len</span><span class="p">,</span><span class="n">chi_sq_val</span><span class="o">=</span><span class="n">chi_sq_val</span><span class="p">,</span><span class="n">err_FWHM</span><span class="o">=</span><span class="n">err_FWHM</span><span class="p">)</span>

                <span class="n">image</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="o">=</span><span class="n">counter_ridgeline</span>

            <span class="k">if</span> <span class="n">auto_rotate</span><span class="p">:</span>
                <span class="c1"># rotate image back</span>
                <span class="n">image</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">jet_direction</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">jet_angle</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">jet_angle</span><span class="p">)</span>
            <span class="c1"># set new ridgeline</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">ridgeline</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">counter_ridgeline</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span>

        <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;polar&quot;</span><span class="p">:</span>
            <span class="c1">#convert image to polar coordinates</span>
            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">auto_rotate</span><span class="p">:</span>
                <span class="c1"># convert image to polar coordinates</span>
                <span class="n">R</span><span class="p">,</span> <span class="n">Theta</span><span class="p">,</span> <span class="n">Z_polar</span> <span class="o">=</span> <span class="n">convert_image_to_polar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>
                <span class="c1"># Integrate over the radius to find jet direction:</span>
                <span class="n">integrated_jet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Theta</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="n">integrated_jet</span> <span class="o">+=</span> <span class="n">Z_polar</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">R</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>  <span class="c1"># correct for rdTheta in integration</span>
                <span class="c1"># plt.plot(Theta[:,0],integrated_jet)</span>
                <span class="c1"># plt.show()</span>
                <span class="c1"># find maximum flux</span>
                <span class="n">max_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">integrated_jet</span><span class="p">)</span>
                <span class="n">jet_direction</span> <span class="o">=</span> <span class="n">Theta</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">][</span><span class="n">max_ind</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Automatically determined jet direction </span><span class="si">{</span><span class="n">jet_direction</span><span class="si">}</span><span class="s2">°.&quot;</span><span class="p">)</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="o">-</span><span class="n">jet_direction</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">jet_angle</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="o">-</span><span class="n">jet_angle</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Will assume the jet was already rotated to position angle 0°.&quot;</span><span class="p">)</span>

            <span class="n">R</span><span class="p">,</span> <span class="n">Theta</span><span class="p">,</span> <span class="n">Z_polar</span> <span class="o">=</span> <span class="n">convert_image_to_polar</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>

            <span class="n">ridgeline</span><span class="o">=</span><span class="n">Ridgeline</span><span class="p">()</span><span class="o">.</span><span class="n">get_ridgeline_polar</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">Theta</span><span class="p">,</span><span class="n">Z_polar</span><span class="p">,</span><span class="bp">self</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
                                                      <span class="n">start_radius</span><span class="o">=</span><span class="n">start_radius</span><span class="p">,</span><span class="n">end_radius</span><span class="o">=</span><span class="n">end_radius</span><span class="p">)</span>

            <span class="n">image</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">=</span><span class="n">ridgeline</span>

            <span class="k">if</span> <span class="n">auto_rotate</span><span class="p">:</span>
                <span class="c1"># rotate image back</span>
                <span class="n">image</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">jet_direction</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">jet_angle</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">jet_angle</span><span class="p">)</span>
            <span class="c1"># set new ridgeline</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">ridgeline</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span>

        <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;polar_gauss&quot;</span><span class="p">:</span>
            <span class="c1">#convert image to polar coordinates</span>
            <span class="n">R</span><span class="p">,</span> <span class="n">Theta</span><span class="p">,</span> <span class="n">Z_polar</span> <span class="o">=</span> <span class="n">convert_image_to_polar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>

            <span class="n">ridgeline</span><span class="o">=</span><span class="n">Ridgeline</span><span class="p">()</span><span class="o">.</span><span class="n">get_ridgeline_polar</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">Theta</span><span class="p">,</span><span class="n">Z_polar</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
                                                      <span class="n">start_radius</span><span class="o">=</span><span class="n">start_radius</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">=</span><span class="n">ridgeline</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please select valid ridgeline method (&#39;polar&#39;, &#39;slices&#39;).&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_noise_from_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">shift_factor</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to calculate the image noise by shifting the phase center with DIFMAP</span>

<span class="sd">        Args:</span>
<span class="sd">            shift_factor (float): Factor of how far times the image size to shift the phase center away.</span>

<span class="sd">        Returns:</span>
<span class="sd">            noise (float): Noise value in Jy</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Shift not possible, no .uvf file attached to ImageData!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span>

        <span class="n">size_x</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
        <span class="n">size_y</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="c1">#shift data away to get rms</span>
        <span class="n">shifted_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">size_x</span><span class="o">*</span><span class="n">shift_factor</span><span class="p">,</span><span class="n">size_y</span><span class="o">*</span><span class="n">shift_factor</span><span class="p">)</span>

        <span class="n">noise</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">shifted_image</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">noise</span>

    <span class="k">def</span> <span class="nf">jet_to_counterjet_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">savefig</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to plot the jet-to-counterjet ratio</span>

<span class="sd">        Args:</span>
<span class="sd">            savefig (str): File path to store the plot</span>
<span class="sd">            show (bool): Choose whether to display the plot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">.</span><span class="n">jet_to_counterjet_profile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="p">,</span><span class="n">savefig</span><span class="o">=</span><span class="n">savefig</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_model_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method to get the current state of the model</span>

<span class="sd">        Returns:</span>
<span class="sd">            comps (list): List of Component IDs and the Core Component ID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">comp_ids</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">core_comp_id</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">!=</span><span class="p">[]:</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">comp_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">component_number</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">is_core</span><span class="p">:</span>
                    <span class="n">core_comp_id</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">component_number</span>

        <span class="k">return</span> <span class="n">comp_ids</span><span class="p">,</span> <span class="n">core_comp_id</span>

    <span class="k">def</span> <span class="nf">change_component_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">old_ids</span><span class="p">,</span><span class="n">new_ids</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to assign new component numbers</span>

<span class="sd">        Args:</span>
<span class="sd">            old_ids (int or list[int]): Old component IDs</span>
<span class="sd">            new_ids (int or list[int]): New component IDs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#handle single value input</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">old_ids</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_ids</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
            <span class="n">old_ids</span><span class="o">=</span><span class="p">[</span><span class="n">old_ids</span><span class="p">]</span>
            <span class="n">new_ids</span><span class="o">=</span><span class="p">[</span><span class="n">new_ids</span><span class="p">]</span>

        <span class="n">old_ids</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">old_ids</span><span class="p">)</span>
        <span class="n">new_ids</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_ids</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">old_ids</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_ids</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">new_ids</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_ids</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Component number specified more than one time in old_ids or new_ids!&quot;</span><span class="p">)</span>

        <span class="c1">#set new component ids</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">component_number</span> <span class="ow">in</span> <span class="n">old_ids</span><span class="p">:</span>
                <span class="n">i</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">old_ids</span><span class="p">)</span><span class="o">==</span><span class="n">comp</span><span class="o">.</span><span class="n">component_number</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">component_number</span><span class="o">=</span><span class="n">new_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">component_number</span> <span class="ow">in</span> <span class="n">new_ids</span><span class="p">:</span>
                    <span class="c1">#in that case we will reset the component id to avoid duplication</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">component_number</span><span class="o">=-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">set_core_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to set the core component</span>

<span class="sd">        Args:</span>
<span class="sd">            id (int): Component ID of the core component</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">core_ind</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">component_number</span><span class="o">==</span><span class="nb">id</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">is_core</span><span class="o">=</span><span class="kc">True</span>
                <span class="n">core_ind</span><span class="o">=</span><span class="n">ind</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">is_core</span><span class="o">=</span><span class="kc">False</span>

        <span class="k">if</span> <span class="n">core_ind</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No component with ID </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> found, no core currently set!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#recalculate core distances for every component</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">):</span>
                <span class="n">core</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">core_ind</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_distance_to_core</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">core</span><span class="o">.</span><span class="n">x_err</span><span class="p">,</span><span class="n">core</span><span class="o">.</span><span class="n">y_err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to get a specific Component.</span>

<span class="sd">        Args:</span>
<span class="sd">            id (int): ID of the component</span>

<span class="sd">        Returns:</span>
<span class="sd">            Component</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">component_number</span><span class="o">==</span><span class="nb">id</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">comp</span>

        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Component with ID </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_core_component</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to retrieve the core component.</span>

<span class="sd">        Returns:</span>
<span class="sd">            comp (Component): Core Component</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">is_core</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">comp</span>

        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No core component defined.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to remove a selected component from the Stokes I image</span>

<span class="sd">        Args:</span>
<span class="sd">            id (int): Component id to remove</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
            <span class="nb">id</span><span class="o">=</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please enter valid component id (int or list[int])!&quot;</span><span class="p">)</span>

        <span class="n">comps_to_remove</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">id</span><span class="p">:</span>
            <span class="n">comps_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="c1">#TODO rewrite to work without ehtim</span>
        <span class="kn">import</span> <span class="nn">ehtim</span> <span class="k">as</span> <span class="nn">eh</span>
        <span class="n">mod</span><span class="o">=</span><span class="n">eh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps_to_remove</span><span class="p">:</span>
            <span class="n">mod</span><span class="o">=</span><span class="n">mod</span><span class="o">.</span><span class="n">add_gauss</span><span class="p">(</span><span class="n">F0</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span>
                              <span class="n">FWHM_maj</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">maj</span><span class="o">*</span><span class="n">comp</span><span class="o">.</span><span class="n">scale</span><span class="o">*</span><span class="n">eh</span><span class="o">.</span><span class="n">RADPERUAS</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span>
                              <span class="n">FWHM_min</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">min</span><span class="o">*</span><span class="n">comp</span><span class="o">.</span><span class="n">scale</span><span class="o">*</span><span class="n">eh</span><span class="o">.</span><span class="n">RADPERUAS</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span>
                              <span class="n">PA</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">pos</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                              <span class="n">x0</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">x</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                              <span class="n">y0</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">y</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="n">im</span><span class="o">=</span><span class="n">mod</span><span class="o">.</span><span class="n">make_image</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">))</span><span class="o">*</span><span class="mf">1e3</span><span class="o">*</span><span class="n">eh</span><span class="o">.</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">))</span>
        <span class="n">im</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">blur_gauss</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">])</span>

        <span class="n">image</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span>
        <span class="n">image</span><span class="o">=</span><span class="n">Jy2JyPerBeam</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
        <span class="n">image</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">#subtract core from stokes I image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span><span class="o">-</span><span class="n">image</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">calculate_opening_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ids</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">snr_cut</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the opening angle for circular Gauss components between the core component and a given component</span>
<span class="sd">        Args:</span>
<span class="sd">            ids (int, list[int]): Component ID of component to calculate the opening angle for</span>

<span class="sd">        Returns:</span>
<span class="sd">            angle (list[float]): Opening angles in degrees</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
            <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ids</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid IDs provided.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ids</span><span class="p">,</span><span class="n">core_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()</span>
                <span class="n">ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">core_id</span><span class="p">)</span>

        <span class="n">core</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_core_component</span><span class="p">()</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span><span class="n">Component</span><span class="p">)</span> <span class="ow">and</span> <span class="n">comp</span><span class="o">.</span><span class="n">resolved</span> <span class="ow">and</span> <span class="n">comp</span><span class="o">.</span><span class="n">snr</span><span class="o">&gt;=</span><span class="n">snr_cut</span><span class="p">:</span>

                    <span class="n">comp_dist</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">maj</span><span class="o">*</span><span class="n">comp</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="mi">2</span>
                    <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">resolved</span><span class="p">:</span>
                        <span class="n">core_dist</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">maj</span><span class="o">*</span><span class="n">comp</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="mi">2</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">core_dist</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">res_lim_maj</span><span class="o">*</span><span class="n">comp</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="mi">2</span>
                    <span class="n">delta_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">core</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">comp</span><span class="o">.</span><span class="n">scale</span>
                    <span class="n">delta_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">core</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">comp</span><span class="o">.</span><span class="n">scale</span>

<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    #this part allows to also do this calculation with elliptical components, but we should discuss if we want it like this</span>
<span class="sd">                    def calculate_theta():</span>
<span class="sd">                        if (delta_y &gt; 0 and delta_x &gt; 0) or (delta_y &gt; 0 and delta_x &lt; 0):</span>
<span class="sd">                            return np.arctan(delta_x / delta_y) / np.pi * 180</span>
<span class="sd">                        elif delta_y &lt; 0 and delta_x &gt; 0:</span>
<span class="sd">                            return np.arctan(delta_x / delta_y) / np.pi * 180 + 180</span>
<span class="sd">                        elif delta_y &lt; 0 and delta_x &lt; 0:</span>
<span class="sd">                            return np.arctan(delta_x / delta_y) / np.pi * 180 - 180</span>
<span class="sd">                        else:</span>
<span class="sd">                            return 0</span>

<span class="sd">                    theta = calculate_theta()</span>

<span class="sd">                    # check core resolution limit</span>
<span class="sd">                    theta_maj, theta_min = get_resolution_limit(self.beam_maj, self.beam_min, self.beam_pa, theta, core.snr,</span>
<span class="sd">                                                                method=res_lim_method, weighting=self.uvw)</span>

<span class="sd">                    new_pos=theta-comp.pos+90</span>
<span class="sd">                    new_pos_core=theta-core.pos+90</span>

<span class="sd">                    line_comp = Line(Point(0, 0), Point(np.cos(new_pos / 180 * np.pi), np.sin(new_pos / 180 * np.pi)))</span>
<span class="sd">                    line_core = Line(Point(0, 0), Point(np.cos(new_pos_core / 180 * np.pi), np.sin(new_pos_core / 180 * np.pi)))</span>

<span class="sd">                    core_Ellipse=Ellipse(Point(0,0),hradius=core.maj*comp.scale/2,vradius=core.min*comp.scale/2)</span>
<span class="sd">                    comp_Ellipse=Ellipse(Point(0,0),hradius=comp.maj*comp.scale/2,vradius=comp.min*comp.scale/2)</span>

<span class="sd">                    if core.maj==0 or core.min==0:</span>
<span class="sd">                        core_dist=np.abs(theta_maj/2)</span>
<span class="sd">                    else:</span>
<span class="sd">                        p1, p2 = core_Ellipse.intersect(line_core)</span>
<span class="sd">                        core_dist=np.abs(float(p1.distance(p2))/2)</span>
<span class="sd">                    p1, p2 = comp_Ellipse.intersect(line_comp)</span>
<span class="sd">                    comp_dist=np.abs(float(p1.distance(p2))/2)</span>
<span class="sd">                    &quot;&quot;&quot;</span>

                    <span class="n">dist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">delta_x</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">delta_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="c1">#calculate opening angle</span>
                    <span class="n">angle</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="n">comp_dist</span><span class="o">-</span><span class="n">core_dist</span><span class="p">)</span><span class="o">/</span><span class="n">dist</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="o">*</span><span class="mi">2</span>

                    <span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Component </span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">component_number</span><span class="si">}</span><span class="s2"> unresolved, will not calculate opening angle.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Component </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> not found, will skip it.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">angles</span>

    <span class="k">def</span> <span class="nf">fit_comp_polarization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to fit polarization to existing Stokes I model components. Will use DIFMAP to fit a Stokes Q and</span>
<span class="sd">        Stokes Q amplitude to the Stokes I components.</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">write_mod_file_from_components</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span><span class="n">export</span><span class="o">=</span><span class="s2">&quot;tmp/model_q.mod&quot;</span><span class="p">,</span><span class="n">adv</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">])</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;cp tmp/model_q.mod tmp/model_u.mod&quot;</span><span class="p">)</span>
        <span class="n">comps_q</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">)</span>
        <span class="n">comps_u</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">)</span>
        <span class="n">comps_q</span><span class="o">=</span><span class="n">modelfit_difmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">,</span><span class="s2">&quot;tmp/model_q.mod&quot;</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="n">difmap_path</span><span class="p">,</span><span class="n">components</span><span class="o">=</span><span class="n">comps_q</span><span class="p">,</span>
                                <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;q&quot;</span><span class="p">,</span><span class="n">do_selfcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">selfcal_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">)</span>
        <span class="n">comps_u</span><span class="o">=</span><span class="n">modelfit_difmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">,</span><span class="s2">&quot;tmp/model_u.mod&quot;</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="n">difmap_path</span><span class="p">,</span><span class="n">components</span><span class="o">=</span><span class="n">comps_u</span><span class="p">,</span>
                                <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;u&quot;</span><span class="p">,</span><span class="n">do_selfcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">selfcal_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comps_q</span><span class="p">)):</span>
                <span class="c1">#we need to check the component association (just to be sure)</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">comps_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="o">-</span><span class="n">comp</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1e-4</span><span class="o">/</span><span class="n">comp</span><span class="o">.</span><span class="n">scale</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">comps_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="o">-</span><span class="n">comp</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1e-4</span><span class="o">/</span><span class="n">comp</span><span class="o">.</span><span class="n">scale</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">comps_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">maj</span><span class="o">-</span><span class="n">comp</span><span class="o">.</span><span class="n">maj</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1e-4</span><span class="o">/</span><span class="n">comp</span><span class="o">.</span><span class="n">scale</span><span class="p">:</span>
                    <span class="c1">#calculate lin_pol and EVPA from Q and U flux</span>
                    <span class="n">lin_pol</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">comps_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">comps_u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">evpa</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">comps_u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span><span class="n">comps_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span>
                    <span class="c1">#set lin_pol and evpa of component</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">lin_pol</span> <span class="o">=</span> <span class="n">lin_pol</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">evpa</span> <span class="o">=</span> <span class="n">evpa</span>

                    <span class="c1">#get component error in lin pol and evpa</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol_errors</span><span class="p">:</span>
                        <span class="c1">#first get q_flux_err</span>
                        <span class="n">S_p</span><span class="p">,</span> <span class="n">rms</span> <span class="o">=</span> <span class="n">get_comp_peak_rms</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">comp</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">comp</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">,</span> <span class="s2">&quot;tmp/model_q.mod&quot;</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;q&quot;</span><span class="p">,</span>
                                                    <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span> <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">)</span>

                        <span class="n">comp_snr_q</span> <span class="o">=</span> <span class="n">S_p</span> <span class="o">/</span> <span class="n">rms</span>

                        <span class="k">if</span> <span class="n">S_p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">S_p</span> <span class="o">=</span> <span class="mf">0.00001</span>
                        <span class="n">sigma_p</span> <span class="o">=</span> <span class="n">rms</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">comp_snr_q</span><span class="p">)</span>

                        <span class="n">sigma_t</span> <span class="o">=</span> <span class="n">sigma_p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">comps_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">S_p</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
                        <span class="n">q_flux_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma_t</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gain_err</span> <span class="o">*</span> <span class="n">comps_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

                        <span class="c1"># get component error in lin pol and evpa</span>
                        <span class="c1">#second get u_flux_err</span>
                        <span class="n">S_p</span><span class="p">,</span> <span class="n">rms</span> <span class="o">=</span> <span class="n">get_comp_peak_rms</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">comp</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">comp</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">,</span> <span class="s2">&quot;tmp/model_u.mod&quot;</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;u&quot;</span><span class="p">,</span>
                                                     <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span> <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">)</span>
                        <span class="n">comp_snr_u</span> <span class="o">=</span> <span class="n">S_p</span> <span class="o">/</span> <span class="n">rms</span>

                        <span class="k">if</span> <span class="n">S_p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">S_p</span> <span class="o">=</span> <span class="mf">0.00001</span>
                        <span class="n">sigma_p</span> <span class="o">=</span> <span class="n">rms</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">comp_snr_u</span><span class="p">)</span>

                        <span class="n">sigma_t</span> <span class="o">=</span> <span class="n">sigma_p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">comps_u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">S_p</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
                        <span class="n">u_flux_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma_t</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gain_err</span> <span class="o">*</span> <span class="n">comps_u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

                        <span class="c1">#calculate EVPA and lin_pol error for component:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">lin_pol_err</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">comps_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">q_flux_err</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">comps_u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">u_flux_err</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">comp</span><span class="o">.</span><span class="n">lin_pol</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">evpa_err</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">comps_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">u_flux_err</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">comps_u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">q_flux_err</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">comp</span><span class="o">.</span><span class="n">lin_pol</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">fit_collimation_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">,</span><span class="n">jet</span><span class="o">=</span><span class="s2">&quot;Jet&quot;</span><span class="p">,</span><span class="n">fit_type</span><span class="o">=</span><span class="s1">&#39;brokenPowerlaw&#39;</span><span class="p">,</span><span class="n">x0</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                                <span class="n">plot_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">plot_fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">fit_r0</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">shift_r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">plot_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">marker</span><span class="o">=</span><span class="n">plot_markers</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to fit a collimation profile to the jet/counterjet</span>

<span class="sd">        Args:</span>
<span class="sd">            method (str): Method to use for collimation profile (&#39;model&#39; to use model components, &#39;ridgeline&#39; to use ridgeline fit)</span>
<span class="sd">            jet (str): Choose whether to do Jet (&#39;Jet&#39;), Counterjet (&#39;Cjet&#39;) or both (&#39;Twin&#39;)</span>
<span class="sd">            fit_type (str): Choose fit_type to use (&#39;brokenPowerlaw&#39; or &#39;Powerlaw&#39;)</span>
<span class="sd">            x0_bpl (list[float]): Start values for fit</span>
<span class="sd">            plot_data (bool): Choose whether to plot the fitted data</span>
<span class="sd">            plot_fit (bool): Choose whether to plot the fit</span>
<span class="sd">            fit_r0 (bool): Choose whether to include (r+r0) in fit or just r</span>
<span class="sd">            shift_r (float): Shift plot by radius in mas.</span>
<span class="sd">            plot (JetProfilePlot): Pass JetProfilePlot to add plots, default will create a new one</span>
<span class="sd">            show (bool): Choose whether to show the plot</span>
<span class="sd">            label (str): Label for the fitted data/fit</span>
<span class="sd">            color (str): Plot color</span>
<span class="sd">            marker (str): Plot marker</span>

<span class="sd">        Returns:</span>
<span class="sd">            plot (JetProfilePlot): Jet profile plot</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fit_fail_jet</span><span class="o">=</span><span class="kc">False</span>
        <span class="n">fit_fail_counterjet</span><span class="o">=</span><span class="kc">False</span>

        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;model&quot;</span><span class="p">:</span>
            <span class="c1">#TODO make it work also for counterjet</span>
            <span class="c1">#jet info</span>
            <span class="n">dists</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">widths</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">width_errs</span><span class="o">=</span><span class="p">[]</span>

            <span class="c1">#counter jet info</span>
            <span class="n">cdists</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">cwidths</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">cwidth_errs</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="c1">#if component Jet</span>
                <span class="n">dists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">distance_to_core</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                <span class="n">widths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">maj</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                <span class="n">width_errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">maj_err</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                <span class="c1">#else component counterjet</span>
                    <span class="c1">#cdists.append(comp.distance_to_core * self.scale)</span>
                    <span class="c1">#cwidths.append(comp.maj * self.scale)</span>
                    <span class="c1">#cwidth_errs.append(comp.maj_err * self.scale)</span>

        <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;ridgeline&quot;</span><span class="p">:</span>

            <span class="c1">#jet info</span>
            <span class="n">dists</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">.</span><span class="n">dist</span>
            <span class="n">widths</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">.</span><span class="n">width</span>
            <span class="n">width_errs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">.</span><span class="n">width_err</span>

            <span class="c1">#counterjet info</span>
            <span class="n">cdists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="o">.</span><span class="n">dist</span>
            <span class="n">cwidths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="o">.</span><span class="n">width</span>
            <span class="n">cwidth_errs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="o">.</span><span class="n">width_err</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please specify valid &#39;method&#39; for fit_collimation_profile (&#39;model&#39;, &#39;ridgeline&#39;).&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">jet</span><span class="o">==</span><span class="s2">&quot;Jet&quot;</span> <span class="ow">or</span> <span class="n">jet</span><span class="o">==</span><span class="s2">&quot;Twin&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">beta</span><span class="p">,</span> <span class="n">sd_beta</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">fit_width</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">widths</span><span class="p">,</span> <span class="n">width_err</span><span class="o">=</span><span class="n">width_errs</span><span class="p">,</span> <span class="n">dist_err</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                                                     <span class="n">fit_type</span><span class="o">=</span><span class="n">fit_type</span><span class="p">,</span><span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span><span class="n">fit_r0</span><span class="o">=</span><span class="n">fit_r0</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Collimation fit did not work for jet!&quot;</span><span class="p">)</span>
                <span class="n">fit_fail_jet</span><span class="o">=</span><span class="kc">True</span>

        <span class="k">if</span> <span class="n">jet</span><span class="o">==</span><span class="s2">&quot;CJet&quot;</span> <span class="ow">or</span> <span class="n">jet</span><span class="o">==</span><span class="s2">&quot;Twin&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cbeta</span><span class="p">,</span> <span class="n">csd_beta</span><span class="p">,</span> <span class="n">cchi2</span><span class="p">,</span> <span class="n">cout</span> <span class="o">=</span> <span class="n">fit_width</span><span class="p">(</span><span class="n">cdists</span><span class="p">,</span> <span class="n">cwidths</span><span class="p">,</span> <span class="n">width_err</span><span class="o">=</span><span class="n">cwidth_errs</span><span class="p">,</span> <span class="n">dist_err</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                                                     <span class="n">fit_type</span><span class="o">=</span><span class="n">fit_type</span><span class="p">,</span><span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span><span class="n">fit_r0</span><span class="o">=</span><span class="n">fit_r0</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Collimation fit did not work for counter jet!&quot;</span><span class="p">)</span>
                <span class="n">fit_fail_counterjet</span><span class="o">=</span><span class="kc">True</span>

        <span class="k">if</span> <span class="n">plot</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">plot</span><span class="o">=</span><span class="n">JetProfilePlot</span><span class="p">(</span><span class="n">jet</span><span class="o">=</span><span class="n">jet</span><span class="p">,</span><span class="n">redshift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">,</span><span class="n">shift_r</span><span class="o">=</span><span class="n">shift_r</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">plot</span><span class="o">.</span><span class="n">jet</span> <span class="o">!=</span> <span class="n">jet</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Plot has wrong &#39;jet&#39; type.&quot;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Plot is not a valid &#39;JetProfilePlot&#39;.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">jet</span><span class="o">==</span><span class="s2">&quot;Jet&quot;</span><span class="p">:</span>
                <span class="n">plot</span><span class="o">.</span><span class="n">plot_profile</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span><span class="n">widths</span><span class="p">,</span><span class="n">width_errs</span><span class="p">,</span><span class="n">color</span><span class="p">,</span><span class="n">marker</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">jet</span><span class="o">==</span><span class="s2">&quot;CJet&quot;</span><span class="p">:</span>
                <span class="n">plot</span><span class="o">.</span><span class="n">plot_profile</span><span class="p">(</span><span class="n">cdists</span><span class="p">,</span><span class="n">cwidths</span><span class="p">,</span><span class="n">cwidth_errs</span><span class="p">,</span><span class="n">color</span><span class="p">,</span><span class="n">marker</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot</span><span class="o">.</span><span class="n">plot_profile</span><span class="p">([</span><span class="n">dists</span><span class="p">,</span><span class="n">cdists</span><span class="p">],[</span><span class="n">widths</span><span class="p">,</span><span class="n">cwidths</span><span class="p">],[</span><span class="n">width_errs</span><span class="p">,</span><span class="n">cwidth_errs</span><span class="p">],</span><span class="n">color</span><span class="p">,</span><span class="n">marker</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">dists</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">dists</span><span class="p">),</span><span class="mi">1000</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_fit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">jet</span><span class="o">==</span><span class="s2">&quot;Jet&quot;</span> <span class="ow">or</span> <span class="n">jet</span><span class="o">==</span><span class="s2">&quot;Twin&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fit_fail_jet</span><span class="p">:</span>
                    <span class="n">plot</span><span class="o">.</span><span class="n">plot_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fit_type</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">sd_beta</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="s2">&quot;Jet&quot;</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span><span class="n">fit_r0</span><span class="o">=</span><span class="n">fit_r0</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">jet</span><span class="o">==</span><span class="s2">&quot;CJet&quot;</span> <span class="ow">or</span> <span class="n">jet</span><span class="o">==</span><span class="s2">&quot;Twin&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fit_fail_counterjet</span><span class="p">:</span>
                    <span class="n">plot</span><span class="o">.</span><span class="n">plot_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fit_type</span><span class="p">,</span> <span class="n">cbeta</span><span class="p">,</span> <span class="n">csd_beta</span><span class="p">,</span> <span class="n">cchi2</span><span class="p">,</span> <span class="s2">&quot;CJet&quot;</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span><span class="n">fit_r0</span><span class="o">=</span><span class="n">fit_r0</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plot</span><span class="o">.</span><span class="n">plot_legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">plot</span>

    <span class="k">def</span> <span class="nf">plot_uv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">savefig</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to plot the uv-coverage, if a .uvf-file is provided.</span>

<span class="sd">        Args:</span>
<span class="sd">            fig (Matplotlib Figure): Optional input of matplotlib fig</span>
<span class="sd">            ax (Matplotlib Ax): Optional input of matplotlib ax</span>
<span class="sd">            savefig (string): Path to export the plot</span>
<span class="sd">            show (bool): Choose whether to show the plot or not</span>

<span class="sd">        Returns:</span>
<span class="sd">            fig, ax</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">fig</span><span class="o">==</span><span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="n">ax</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">)</span>
            <span class="n">u_array</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">v_array</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="n">u_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">v_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;FREQ&quot;</span> <span class="ow">in</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CTYPE&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]:</span>
                        <span class="n">freq_ghz</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRVAL&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span> <span class="o">/</span> <span class="mf">1e9</span>  <span class="c1"># Frequency in GHz</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="c1"># plot it</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">freq_ghz</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">u_array</span><span class="p">),</span> <span class="n">freq_ghz</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v_array</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="n">freq_ghz</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">u_array</span><span class="p">),</span> <span class="o">-</span><span class="n">freq_ghz</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v_array</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;U (10⁶ $\lambda$)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;V (10⁶ $\lambda$)&quot;</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">savefig</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">fits_file</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">uvf_file</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">stokes_i</span><span class="o">=</span><span class="p">[],</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">lin_pol</span><span class="o">=</span><span class="p">[],</span> <span class="n">evpa</span><span class="o">=</span><span class="p">[],</span> <span class="n">pol_from_stokes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ridgeline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">counter_ridgeline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">stokes_q</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">stokes_u</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">comp_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">auto_identify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">core_comp_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">redshift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">query_redshift</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">model_save_dir</span><span class="o">=</span><span class="s1">&#39;tmp/&#39;</span><span class="p">,</span> <span class="n">is_casa_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_ehtim_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">noise_method</span><span class="o">=</span><span class="n">noise_method</span><span class="p">,</span> <span class="n">mfit_err_method</span><span class="o">=</span><span class="n">mfit_err_method</span><span class="p">,</span> <span class="n">res_lim_method</span><span class="o">=</span><span class="n">res_lim_method</span><span class="p">,</span> <span class="n">uvtaper</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">correct_rician_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">fit_comp_polarization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit_comp_pol_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gain_err</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">uvw</span><span class="o">=</span><span class="n">uvw</span><span class="p">,</span> <span class="n">difmap_path</span><span class="o">=</span><span class="n">difmap_path</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initializes an ImageData object to handle a full-polarization VLBI data set at one epoch and one frequency.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>fits_file</code></b>
                  (<code>str</code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Input .fits file(s) (Stokes I or full polarization, e.g. from CASA)</p>
              </div>
            </li>
            <li>
              <b><code>uvf_file</code></b>
                  (<code>str</code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Input .uvf file(s)</p>
              </div>
            </li>
            <li>
              <b><code>stokes_i</code></b>
                  (<code>list[list[float]]</code>, default:
                      <code>[]</code>
)
              –
              <div class="doc-md-description">
                <p>Input of Stokes-I data as a 2d-array</p>
              </div>
            </li>
            <li>
              <b><code>model</code></b>
                  (<code>str</code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Input of modelfit .fits or .mod file (e.g., from DIFMAP), for CASA .fits model, set is_casa_model=True</p>
              </div>
            </li>
            <li>
              <b><code>lin_pol</code></b>
                  (<code>list[list[float]]</code>, default:
                      <code>[]</code>
)
              –
              <div class="doc-md-description">
                <p>2d array of linear polarized intensity values (if using, set pol_from_stokes=False)</p>
              </div>
            </li>
            <li>
              <b><code>evpa</code></b>
                  (<code>list[list[float]]</code>, default:
                      <code>[]</code>
)
              –
              <div class="doc-md-description">
                <p>2d array of Electric Vector Position Angle (EVPA) (if using, set pol_from_stokes=False)</p>
              </div>
            </li>
            <li>
              <b><code>pol_from_stokes</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to import data from fits-files or from lin_pol/evpa</p>
              </div>
            </li>
            <li>
              <b><code>mask</code></b>
                  (<code>list[list[bool]]</code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>2d-array of an image mask</p>
              </div>
            </li>
            <li>
              <b><code>ridgeline</code></b>
                  (<code><span title="vcat.ridgeline.Ridgeline">Ridgeline</span></code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Ridgeline of the image</p>
              </div>
            </li>
            <li>
              <b><code>counter_ridgeline</code></b>
                  (<code><span title="vcat.ridgeline.Ridgeline">Ridgeline</span></code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Counter ridgeline of the image.</p>
              </div>
            </li>
            <li>
              <b><code>stokes_q</code></b>
                  (<code>str or list[list[float]]</code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Input Stokes-Q .fits file or 2d array of Stokes-Q image</p>
              </div>
            </li>
            <li>
              <b><code>stokes_u</code></b>
                  (<code>str or list[list[float]]</code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Input Stokes-U .fits file or 2d array of Stokes-U image</p>
              </div>
            </li>
            <li>
              <b><code>comp_ids</code></b>
                  (<code>list[int]</code>, default:
                      <code>[]</code>
)
              –
              <div class="doc-md-description">
                <p>list of integers to assign as component number (from top to bottom .mod file or .fits header)</p>
              </div>
            </li>
            <li>
              <b><code>auto_identify</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>If true and no comp_ids provided components will automatically be named</p>
              </div>
            </li>
            <li>
              <b><code>core_comp_id</code></b>
                  (<code>int</code>, default:
                      <code>0</code>
)
              –
              <div class="doc-md-description">
                <p>Component ID of the core component</p>
              </div>
            </li>
            <li>
              <b><code>redshift</code></b>
                  (<code>float</code>, default:
                      <code>0</code>
)
              –
              <div class="doc-md-description">
                <p>Redshift of the source</p>
              </div>
            </li>
            <li>
              <b><code>query_redshift</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to query redshift automatically from NED</p>
              </div>
            </li>
            <li>
              <b><code>M</code></b>
                  (<code>float</code>, default:
                      <code>0</code>
)
              –
              <div class="doc-md-description">
                <p>Black hole mass</p>
              </div>
            </li>
            <li>
              <b><code>model_save_dir</code></b>
                  (<code>str</code>, default:
                      <code>&#39;tmp/&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Directory where temporary data for VCAT operations will be stored</p>
              </div>
            </li>
            <li>
              <b><code>is_casa_model</code></b>
                  (<code>bool</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>If using a CASA .fits model for 'model', set to True</p>
              </div>
            </li>
            <li>
              <b><code>is_ehtim_model</code></b>
                  (<code>bool</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>If using a ehtim .txt model file for 'model', set to True</p>
              </div>
            </li>
            <li>
              <b><code>noise_method</code></b>
                  (<code>str</code>, default:
                      <code><span title="vcat.image_data.ImageData.noise_method">noise_method</span></code>
)
              –
              <div class="doc-md-description">
                <p>Choose method to calculate image noise ('Histogram Fit', 'box', 'Image RMS', 'DIFMAP')</p>
              </div>
            </li>
            <li>
              <b><code>mfit_err_method</code></b>
                  (<code>str</code>, default:
                      <code><span title="vcat.config.mfit_err_method">mfit_err_method</span></code>
)
              –
              <div class="doc-md-description">
                <p>Choose method to compute modelcomponent errors ('flat', 'Schinzel12', 'Weaver22')</p>
              </div>
            </li>
            <li>
              <b><code>res_lim_method</code></b>
                  (<code>str</code>, default:
                      <code><span title="vcat.config.res_lim_method">res_lim_method</span></code>
)
              –
              <div class="doc-md-description">
                <p>Choose method to compute component resolution limit ('Kovalev05', 'Lobanov05','beam')</p>
              </div>
            </li>
            <li>
              <b><code>correct_rician_bias</code></b>
                  (<code>bool</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to correct polarization for Rician Bias</p>
              </div>
            </li>
            <li>
              <b><code>error</code></b>
                  (<code>float</code>, default:
                      <code>0.05</code>
)
              –
              <div class="doc-md-description">
                <p>Set relative error on the flux density scale</p>
              </div>
            </li>
            <li>
              <b><code>fit_comp_polarization</code></b>
                  (<code>bool</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to fit polarization of modelfit components</p>
              </div>
            </li>
            <li>
              <b><code>fit_comp_pol_errors</code></b>
                  (<code>bool</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to determine lin_pol and evpa errors for components</p>
              </div>
            </li>
            <li>
              <b><code>difmap_path</code></b>
                  (<code>str</code>, default:
                      <code><span title="vcat.image_data.ImageData.difmap_path">difmap_path</span></code>
)
              –
              <div class="doc-md-description">
                <p>Path to the folder of your DIFMAP installation</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">fits_file</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
             <span class="n">uvf_file</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
             <span class="n">stokes_i</span><span class="o">=</span><span class="p">[],</span>
             <span class="n">model</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
             <span class="n">lin_pol</span><span class="o">=</span><span class="p">[],</span>
             <span class="n">evpa</span><span class="o">=</span><span class="p">[],</span>
             <span class="n">pol_from_stokes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">mask</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
             <span class="n">ridgeline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
             <span class="n">counter_ridgeline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
             <span class="n">stokes_q</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
             <span class="n">stokes_u</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
             <span class="n">comp_ids</span><span class="o">=</span><span class="p">[],</span>
             <span class="n">auto_identify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">core_comp_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
             <span class="n">redshift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
             <span class="n">query_redshift</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">M</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
             <span class="n">model_save_dir</span><span class="o">=</span><span class="s2">&quot;tmp/&quot;</span><span class="p">,</span>
             <span class="n">is_casa_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">is_ehtim_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">noise_method</span><span class="o">=</span><span class="n">noise_method</span><span class="p">,</span> <span class="c1">#choose noise method</span>
             <span class="n">mfit_err_method</span><span class="o">=</span><span class="n">mfit_err_method</span><span class="p">,</span>
             <span class="n">res_lim_method</span><span class="o">=</span><span class="n">res_lim_method</span><span class="p">,</span>
             <span class="n">uvtaper</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
             <span class="n">correct_rician_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">error</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="c1">#relative error flux densities,</span>
             <span class="n">fit_comp_polarization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">fit_comp_pol_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">gain_err</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
             <span class="n">uvw</span><span class="o">=</span><span class="n">uvw</span><span class="p">,</span>
             <span class="n">difmap_path</span><span class="o">=</span><span class="n">difmap_path</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes an ImageData object to handle a full-polarization VLBI data set at one epoch and one frequency.</span>

<span class="sd">    Args:</span>
<span class="sd">        fits_file (str): Input .fits file(s) (Stokes I or full polarization, e.g. from CASA)</span>
<span class="sd">        uvf_file (str): Input .uvf file(s)</span>
<span class="sd">        stokes_i (list[list[float]]): Input of Stokes-I data as a 2d-array</span>
<span class="sd">        model (str): Input of modelfit .fits or .mod file (e.g., from DIFMAP), for CASA .fits model, set is_casa_model=True</span>
<span class="sd">        lin_pol (list[list[float]]): 2d array of linear polarized intensity values (if using, set pol_from_stokes=False)</span>
<span class="sd">        evpa (list[list[float]]): 2d array of Electric Vector Position Angle (EVPA) (if using, set pol_from_stokes=False)</span>
<span class="sd">        pol_from_stokes (bool): Choose whether to import data from fits-files or from lin_pol/evpa</span>
<span class="sd">        mask (list[list[bool]]): 2d-array of an image mask</span>
<span class="sd">        ridgeline (Ridgeline): Ridgeline of the image</span>
<span class="sd">        counter_ridgeline (Ridgeline): Counter ridgeline of the image.</span>
<span class="sd">        stokes_q (str or list[list[float]]): Input Stokes-Q .fits file or 2d array of Stokes-Q image</span>
<span class="sd">        stokes_u (str or list[list[float]]): Input Stokes-U .fits file or 2d array of Stokes-U image</span>
<span class="sd">        comp_ids (list[int]): list of integers to assign as component number (from top to bottom .mod file or .fits header)</span>
<span class="sd">        auto_identify (bool): If true and no comp_ids provided components will automatically be named</span>
<span class="sd">        core_comp_id (int): Component ID of the core component</span>
<span class="sd">        redshift (float): Redshift of the source</span>
<span class="sd">        query_redshift (bool): Choose whether to query redshift automatically from NED</span>
<span class="sd">        M (float): Black hole mass</span>
<span class="sd">        model_save_dir (str): Directory where temporary data for VCAT operations will be stored</span>
<span class="sd">        is_casa_model (bool): If using a CASA .fits model for &#39;model&#39;, set to True</span>
<span class="sd">        is_ehtim_model (bool): If using a ehtim .txt model file for &#39;model&#39;, set to True</span>
<span class="sd">        noise_method (str): Choose method to calculate image noise (&#39;Histogram Fit&#39;, &#39;box&#39;, &#39;Image RMS&#39;, &#39;DIFMAP&#39;)</span>
<span class="sd">        mfit_err_method (str): Choose method to compute modelcomponent errors (&#39;flat&#39;, &#39;Schinzel12&#39;, &#39;Weaver22&#39;)</span>
<span class="sd">        res_lim_method (str): Choose method to compute component resolution limit (&#39;Kovalev05&#39;, &#39;Lobanov05&#39;,&#39;beam&#39;)</span>
<span class="sd">        correct_rician_bias (bool): Choose whether to correct polarization for Rician Bias</span>
<span class="sd">        error (float): Set relative error on the flux density scale</span>
<span class="sd">        fit_comp_polarization (bool): Choose whether to fit polarization of modelfit components</span>
<span class="sd">        fit_comp_pol_errors (bool): Choose whether to determine lin_pol and evpa errors for components</span>
<span class="sd">        difmap_path (str): Path to the folder of your DIFMAP installation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">==</span><span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_inp</span><span class="o">=</span><span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fits_file</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">fits_file</span><span class="o">=</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_inp</span><span class="o">=</span><span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">fits_file</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span> <span class="o">=</span> <span class="n">fits_file</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="o">=</span><span class="n">lin_pol</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evpa</span><span class="o">=</span><span class="n">evpa</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stokes_i</span><span class="o">=</span><span class="n">stokes_i</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="o">=</span><span class="n">uvf_file</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="o">=</span><span class="n">difmap_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">residual_map_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">residual_map</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">noise_method</span><span class="o">=</span><span class="n">noise_method</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">is_casa_model</span><span class="o">=</span><span class="n">is_casa_model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">is_ehtim_model</span><span class="o">=</span><span class="n">is_ehtim_model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">=</span><span class="n">model_save_dir</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">correct_rician_bias</span><span class="o">=</span><span class="n">correct_rician_bias</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol</span> <span class="o">=</span> <span class="n">fit_comp_polarization</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol_errors</span> <span class="o">=</span> <span class="n">fit_comp_pol_errors</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">=</span><span class="n">error</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gain_err</span><span class="o">=</span><span class="n">gain_err</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="o">=</span><span class="n">uvtaper</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="o">=</span><span class="n">uvw</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="o">=</span><span class="n">M</span>
    <span class="k">if</span> <span class="n">ridgeline</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">=</span><span class="n">Ridgeline</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">=</span><span class="n">ridgeline</span>
    <span class="k">if</span> <span class="n">counter_ridgeline</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="o">=</span><span class="n">Ridgeline</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="o">=</span><span class="n">counter_ridgeline</span>


    <span class="k">if</span> <span class="n">fits_file</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="c1">#if no fits file was loaded try to get the dirty image</span>
        <span class="k">if</span> <span class="n">uvf_file</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Only .uvf file given, will create dirty image with npix=1024 and pxsize=0.05!&quot;</span><span class="p">)</span>
            <span class="c1">#get dirty map from uvf file</span>
            <span class="n">get_residual_map</span><span class="p">(</span><span class="n">uvf_file</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">difmap_path</span><span class="o">=</span><span class="n">difmap_path</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span>
                             <span class="n">save_location</span><span class="o">=</span><span class="s2">&quot;/tmp/dirty_image.fits&quot;</span><span class="p">,</span> <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span>
                             <span class="n">npix</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span><span class="n">pxsize</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">do_selfcal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">fits_file</span><span class="o">=</span><span class="s2">&quot;/tmp/dirty_image.fits&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="o">=</span><span class="n">fits_file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="o">=</span><span class="n">fits_file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_fits</span><span class="o">=</span><span class="kc">True</span>

    <span class="c1"># Read clean files in</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">hdu_list</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdu_list</span> <span class="o">=</span> <span class="n">hdu_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_fits</span><span class="o">=</span><span class="kc">False</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_path</span><span class="o">=</span><span class="n">stokes_q</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_path</span><span class="o">=</span><span class="n">stokes_u</span>
    <span class="n">stokes_q_path</span><span class="o">=</span><span class="n">stokes_q</span>
    <span class="n">stokes_u_path</span><span class="o">=</span><span class="n">stokes_u</span>
    <span class="c1">#read stokes data from input files if defined</span>
    <span class="k">if</span> <span class="n">stokes_q</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">q_fits</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stokes_q</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stokes_q</span> <span class="o">=</span> <span class="n">q_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">stokes_q</span> <span class="o">=</span> <span class="n">q_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">q_fits</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">stokes_q</span><span class="o">=</span><span class="n">stokes_q</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stokes_q</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">if</span> <span class="n">stokes_u</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">u_fits</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stokes_u</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stokes_u</span> <span class="o">=</span> <span class="n">u_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">stokes_u</span> <span class="o">=</span> <span class="n">u_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">u_fits</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">stokes_u</span> <span class="o">=</span> <span class="n">stokes_u</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stokes_u</span><span class="o">=</span><span class="p">[]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="o">=</span><span class="n">stokes_u</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="o">=</span><span class="n">stokes_q</span>

    <span class="c1"># Set name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;OBJECT&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">get_date</span><span class="p">(</span><span class="n">fits_file</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">)</span><span class="o">.</span><span class="n">mjd</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">)</span><span class="o">.</span><span class="n">decimalyear</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRVAL3&quot;</span><span class="p">])</span>  <span class="c1"># frequency in Hertz</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FREQ&quot;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="mi">15000000000</span>


    <span class="c1">#get redshift</span>
    <span class="k">if</span> <span class="n">redshift</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">query_redshift</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">Ned</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="s2">&quot;redshifts&quot;</span><span class="p">)[</span><span class="s2">&quot;Published Redshift&quot;</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Redshift for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> automatically determined from NED: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span> <span class="o">=</span> <span class="mf">0.00</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="o">=</span><span class="n">redshift</span>

    <span class="c1"># Unit selection and adjustment</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">])</span>  <span class="c1"># degree per pixel</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;deg&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">&gt;</span> <span class="mf">6.94e-6</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;arcmin&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">60.</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">&gt;</span> <span class="mf">1.157e-7</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">60.</span> <span class="o">*</span> <span class="mf">60.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;arcsec&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">60.</span> <span class="o">*</span> <span class="mf">60.</span> <span class="o">*</span> <span class="mf">1000.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;mas&#39;</span>
    <span class="c1"># FMP suggestion: add microarcseconds for possible scale</span>

    <span class="c1"># Set beam parameters</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># DIFMAP style</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMAJ&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMIN&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BPA&quot;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># TODO check if this is actually working!</span>
            <span class="c1"># CASA style</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># convert to mas</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># convert to mas</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No input beam information!&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span> <span class="o">=</span> <span class="mi">0</span>


    <span class="c1"># Convert Pixel into unit</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">],</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">],</span>
                    <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># NAXIS1: number of pixels at R.A.-axis</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span>
            <span class="s2">&quot;CDELT1&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>  <span class="c1"># CRPIX1: reference pixel, CDELT1: deg/pixel</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">],</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">],</span>
                    <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># NAXIS2: number of pixels at Dec.-axis</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span>
            <span class="s2">&quot;CDELT2&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>  <span class="c1"># CRPIX2: reference pixel, CDELT2: deg/pixel</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">extent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_fits</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_data</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_data</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>


    <span class="c1">#handle model loading</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span> <span class="o">=</span> <span class="n">model</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_fits_file</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_casa_model</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_ehtim_model</span><span class="p">:</span> <span class="c1">#Careful, this may not work for CASA style .fits files!</span>
        <span class="c1">#this means it is a .mod file -&gt; will create .fits file from it</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_model/&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">new_model_fits</span><span class="o">=</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_model/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz&quot;</span>
        <span class="k">if</span> <span class="n">difmap_path</span><span class="o">!=</span><span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">uvf_file</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="c1"># use difmap to load the model and create model .fits file and store it as model_file_path</span>
            <span class="n">fold_with_beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">],</span><span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                           <span class="n">bmaj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">,</span>
                           <span class="n">outname</span><span class="o">=</span><span class="n">new_model_fits</span><span class="p">,</span> <span class="n">n_pixel</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                           <span class="n">mod_files</span><span class="o">=</span><span class="p">[</span><span class="n">model</span><span class="p">],</span><span class="n">clean_mod_files</span><span class="o">=</span><span class="p">[</span><span class="n">model</span><span class="p">],</span> <span class="n">uvf_files</span><span class="o">=</span><span class="p">[</span><span class="n">uvf_file</span><span class="p">],</span> <span class="n">do_selfcal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#TODO does not work for AIPS .fits!!!</span>
            <span class="c1">#copy the clean .fits file and write the model info to the header and store it as model_file_path</span>
            <span class="c1">#get model first:</span>
            <span class="n">model_df</span> <span class="o">=</span> <span class="n">getComponentInfo</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
            <span class="c1">#now modify fits file</span>
            <span class="n">f</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">)</span>
            <span class="c1"># FITS column names</span>
            <span class="n">fits_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FLUX&quot;</span><span class="p">,</span><span class="s2">&quot;DELTAX&quot;</span><span class="p">,</span><span class="s2">&quot;DELTAY&quot;</span><span class="p">,</span><span class="s2">&quot;MAJOR AX&quot;</span><span class="p">,</span><span class="s2">&quot;MINOR AX&quot;</span><span class="p">,</span><span class="s2">&quot;POSANGLE&quot;</span><span class="p">,</span><span class="s2">&quot;TYPE OBJ&quot;</span><span class="p">]</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([</span>
                <span class="p">(</span><span class="s1">&#39;FLUX&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f4&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;DELTAX&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f4&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;DELTAY&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f4&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;MAJOR AX&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f4&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;MINOR AX&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f4&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;POSANGLE&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f4&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;TYPE OBJ&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f4&#39;</span><span class="p">)</span>
                <span class="p">])</span>


            <span class="c1"># Manually map DataFrame columns to FITS structure</span>
            <span class="n">column_mapping</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;FLUX&quot;</span><span class="p">:</span> <span class="s2">&quot;Flux&quot;</span><span class="p">,</span>
                <span class="s2">&quot;DELTAX&quot;</span><span class="p">:</span> <span class="s2">&quot;Delta_x&quot;</span><span class="p">,</span>
                <span class="s2">&quot;DELTAY&quot;</span><span class="p">:</span> <span class="s2">&quot;Delta_y&quot;</span><span class="p">,</span>
                <span class="s2">&quot;MAJOR AX&quot;</span><span class="p">:</span> <span class="s2">&quot;Major_axis&quot;</span><span class="p">,</span>
                <span class="s2">&quot;MINOR AX&quot;</span><span class="p">:</span> <span class="s2">&quot;Minor_axis&quot;</span><span class="p">,</span>
                <span class="s2">&quot;POSANGLE&quot;</span><span class="p">:</span> <span class="s2">&quot;PA&quot;</span><span class="p">,</span>
                <span class="s2">&quot;TYPE OBJ&quot;</span><span class="p">:</span> <span class="s2">&quot;Typ_obj&quot;</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># Ensure correct order and match dtype</span>
            <span class="n">new_data_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column_mapping</span><span class="p">[</span><span class="n">col</span><span class="p">]]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">fits_columns</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">model_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()],</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>  <span class="c1"># Ensure the same dtype as the original FITS table</span>
            <span class="p">)</span>

            <span class="c1"># Overwrite the FITS table with the new structured array</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">new_data_array</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_model_fits</span><span class="o">+</span><span class="s2">&quot;.fits&quot;</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span> <span class="o">=</span> <span class="n">new_model_fits</span> <span class="o">+</span> <span class="s2">&quot;.fits&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span>

    <span class="c1">#overwrite fits image data with stokes_i input if given</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">stokes_i</span><span class="o">==</span><span class="p">[]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">=</span><span class="n">stokes_i</span>

    <span class="c1">#read in polarization input</span>

    <span class="c1"># check if FITS file contains more than just Stokes I</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">only_stokes_i</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">only_stokes_i</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">only_stokes_i</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stokes_q</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stokes_u</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stokes_q</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stokes_u</span><span class="p">)):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">only_stokes_i</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#in this case override the polarization data with the data that was input to Q and U</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">only_stokes_i</span><span class="p">:</span>
        <span class="c1">#DIFMAP Style</span>
        <span class="n">pols</span><span class="o">=</span><span class="mi">1</span>
        <span class="c1"># Check if linpol/evpa/stokes_i have same dimensions!</span>
        <span class="n">dim_wrong</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">pol_from_stokes</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stokes_q</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stokes_u</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stokes_q</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stokes_u</span><span class="p">)):</span>
                <span class="n">dim_wrong</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="o">=</span><span class="n">stokes_q</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="o">=</span><span class="n">stokes_u</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">evpa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">lin_pol</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">evpa</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">lin_pol</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">evpa</span><span class="p">)):</span>
                <span class="n">dim_wrong</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="o">=</span><span class="n">lin_pol</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">evpa</span><span class="o">=</span><span class="n">evpa</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">evpa</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#CASA STYLE</span>
        <span class="n">pols</span><span class="o">=</span><span class="mi">3</span>
        <span class="n">dim_wrong</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="o">=</span><span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="o">=</span><span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_data</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_data</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span>

    <span class="k">if</span> <span class="n">pol_from_stokes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dim_wrong</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evpa</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="p">)</span>
        <span class="c1">#shift to 0-180 (only positive)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evpa</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evpa</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evpa</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evpa</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">difmap_noise</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NOISE&quot;</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">difmap_noise</span> <span class="o">=</span> <span class="mi">0</span>


    <span class="k">try</span><span class="p">:</span>
        <span class="n">q_fits</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stokes_q_path</span><span class="p">)</span>
        <span class="n">u_fits</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stokes_u_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">difmap_pol_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">q_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NOISE&quot;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="nb">float</span><span class="p">(</span><span class="n">u_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NOISE&quot;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">q_fits</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">u_fits</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">difmap_pol_noise</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">#calculate image noise according to the method selected</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calculating Stokes I noise&quot;</span><span class="p">)</span>
    <span class="n">unused</span><span class="p">,</span> <span class="n">levs_i</span> <span class="o">=</span> <span class="n">get_sigma_levs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="n">noise_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_method</span><span class="p">,</span><span class="n">noise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_noise</span><span class="p">)</span> <span class="c1">#get noise for stokes i</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calculating Pol noise&quot;</span><span class="p">)</span>
        <span class="n">unused</span><span class="p">,</span> <span class="n">levs_pol</span> <span class="o">=</span> <span class="n">get_sigma_levs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="n">noise_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_method</span><span class="p">,</span><span class="n">noise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_noise</span><span class="p">)</span> <span class="c1">#get noise for polarization</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">levs_pol</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">levs_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pol_noise</span> <span class="o">=</span> <span class="n">levs_pol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1">#calculate integrated total flux in image</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">integrated_flux_image</span> <span class="o">=</span> <span class="n">JyPerBeam2Jy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>

    <span class="c1">#calculate integrated pol flux in image</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">integrated_pol_flux_image</span> <span class="o">=</span> <span class="n">JyPerBeam2Jy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_casa_model</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ehtim_model</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#TODO basic checks if file is valid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">=</span><span class="n">getComponentInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
            <span class="c1">#write .mod file from .fits input</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_model/&quot;</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="o">=</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_model/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span>
                <span class="n">write_mod_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;FITS file does not contain model extension!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ehtim_model</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_clean&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_q&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_u&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span> <span class="o">=</span> <span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_clean/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span>
        <span class="n">write_mod_file_from_ehtim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span> <span class="o">=</span> <span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_q/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span>
        <span class="n">write_mod_file_from_ehtim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span> <span class="o">=</span> <span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_u/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span>
        <span class="n">write_mod_file_from_ehtim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">getComponentInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span><span class="n">year</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">mjd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span><span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span>

    <span class="k">elif</span> <span class="n">is_casa_model</span><span class="p">:</span>
        <span class="c1">#TODO basic checks if file is valid</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_clean&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_q&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_u&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="o">=</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_clean/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_mod_file_from_casa</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="o">=</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_q/&quot;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_mod_file_from_casa</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="o">=</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_u/&quot;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_mod_file_from_casa</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">getComponentInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_clean&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_q&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_u&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#try to import model which is attached to the main .fits file</span>
        <span class="n">model_i</span> <span class="o">=</span> <span class="n">getComponentInfo</span><span class="p">(</span><span class="n">fits_file</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_i</span> <span class="o">=</span> <span class="n">model_i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="o">=</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_clean/&quot;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span>
        <span class="n">write_mod_file</span><span class="p">(</span><span class="n">model_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span>
        <span class="c1">#load stokes q and u clean models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_q</span><span class="o">=</span><span class="n">getComponentInfo</span><span class="p">(</span><span class="n">stokes_q_path</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="o">=</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_q/&quot;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span>
        <span class="n">write_mod_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_u</span><span class="o">=</span><span class="n">getComponentInfo</span><span class="p">(</span><span class="n">stokes_u_path</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="o">=</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_u/&quot;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span>
        <span class="n">write_mod_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1">#calculate residual map if uvf and modelfile present</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="o">!=</span><span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="o">!=</span><span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_casa_model</span> <span class="ow">and</span>  <span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;residual_maps&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residual_map_path</span> <span class="o">=</span> <span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;residual_maps/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
                                                                                                             <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz_residual.fits&quot;</span>

        <span class="n">get_residual_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">,</span>
                         <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                         <span class="n">save_location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_map_path</span><span class="p">,</span><span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span>
                         <span class="n">npix</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">),</span><span class="n">pxsize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">residual_map</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_map_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>

    <span class="c1">#save modelfit (or clean) components as Component objects</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_inp</span><span class="p">:</span>
        <span class="c1">#only do this if a model was specified explicitely</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="c1">#use provided comp_id</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">comp_id</span><span class="o">=</span><span class="n">comp_ids</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1">#assign automatic comp_id</span>
                <span class="k">if</span> <span class="n">auto_identify</span><span class="p">:</span>
                    <span class="n">comp_id</span><span class="o">=</span><span class="n">ind</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">comp_id</span><span class="o">=-</span><span class="mi">1</span>

            <span class="c1">#check if component is the core component</span>
            <span class="k">if</span> <span class="n">comp_id</span><span class="o">==</span><span class="n">core_comp_id</span><span class="p">:</span>
                <span class="n">is_core</span><span class="o">=</span><span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_core</span><span class="o">=</span><span class="kc">False</span>

            <span class="c1">#calculate component SNR</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="o">!=</span><span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">S_p</span><span class="p">,</span> <span class="n">rms</span> <span class="o">=</span> <span class="n">get_comp_peak_rms</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;Delta_x&quot;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;Delta_y&quot;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">,</span>
                                             <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span> <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">)</span>
                <span class="n">comp_snr</span> <span class="o">=</span> <span class="n">S_p</span><span class="o">/</span><span class="n">rms</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ind</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No .uvfits file or difmap path provided. Calculating modelfit component SNR based on the clean map only.&#39;</span><span class="p">)</span>
                <span class="c1"># TODO: use .fits file from Gaussian modelfit instead of clean map</span>
                <span class="n">S_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pixel_value</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;Delta_x&quot;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                                               <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;Delta_y&quot;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                <span class="n">rms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span>
                <span class="n">comp_snr</span> <span class="o">=</span> <span class="n">S_p</span><span class="o">/</span><span class="n">rms</span>

            <span class="n">component</span><span class="o">=</span><span class="n">Component</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;Delta_x&quot;</span><span class="p">],</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;Delta_y&quot;</span><span class="p">],</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;Major_axis&quot;</span><span class="p">],</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;Minor_axis&quot;</span><span class="p">],</span>
                                <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;PA&quot;</span><span class="p">],</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;Flux&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span><span class="n">Time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;mjd&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decimalyear</span><span class="p">,</span><span class="n">component_number</span><span class="o">=</span><span class="n">comp_id</span><span class="p">,</span>
                                <span class="n">redshift</span><span class="o">=</span><span class="n">redshift</span><span class="p">,</span> <span class="n">is_core</span><span class="o">=</span><span class="n">is_core</span><span class="p">,</span><span class="n">beam_maj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span><span class="n">beam_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span><span class="n">beam_pa</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">,</span>
                                <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="n">noise</span><span class="o">=</span><span class="n">rms</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">snr</span><span class="o">=</span><span class="n">comp_snr</span><span class="p">,</span><span class="n">error_method</span><span class="o">=</span><span class="n">mfit_err_method</span><span class="p">,</span>
                                <span class="n">res_lim_method</span><span class="o">=</span><span class="n">res_lim_method</span><span class="p">,</span><span class="n">gain_err</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gain_err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

        <span class="c1">#set core</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_core_component</span><span class="p">(</span><span class="n">core_comp_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="o">!=</span><span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">fit_comp_polarization</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retrieving polarization information for modelfit components.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_polarization</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fit_comp_polarization</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Trying to fit component polarization, but no uvf file loaded!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not fitting component polarization&quot;</span><span class="p">)</span>


    <span class="n">hdu_list</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1">#calculate cleaned flux density from mod files</span>
    <span class="c1">#first stokes I</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrated_flux_clean</span><span class="o">=</span><span class="n">total_flux_from_mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_clean/&quot;</span>  <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrated_flux_clean</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1">#and then polarization</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">flux_q</span><span class="o">=</span><span class="n">total_flux_from_mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_q/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span>
                                   <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span><span class="p">)</span>
        <span class="n">flux_u</span><span class="o">=</span><span class="n">total_flux_from_mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_u/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span>
                                   <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.mod&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrated_pol_flux_clean</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">flux_u</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">flux_q</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frac_pol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrated_pol_flux_clean</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrated_flux_clean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evpa_average</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">flux_u</span><span class="p">,</span><span class="n">flux_q</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrated_pol_flux_clean</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frac_pol</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">#correct rician bias</span>
    <span class="k">if</span> <span class="n">correct_rician_bias</span><span class="p">:</span>
        <span class="n">lin_pol_sqr</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_noise</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">lin_pol_sqr</span><span class="p">[</span><span class="n">lin_pol_sqr</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lin_pol_sqr</span><span class="p">)</span>

    <span class="c1"># initialize mask</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="c1">#test masking</span>
        <span class="c1">#self.mask[0:200]=np.ones_like(self.Z[0:200],dtype=bool)</span>
        <span class="c1">#self.masking(mask_type=&quot;cut_left&quot;,args=-200)</span>
        <span class="c1">#set mask where Image is None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)]</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Mask input format invalid, Mask reset to no mask.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span>

    <span class="c1"># additional parameters only used for spectral index type data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">is_spix</span><span class="o">=</span><span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">spix</span><span class="o">=</span><span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">spix_vmin</span><span class="o">=-</span><span class="mi">3</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">spix_vmax</span><span class="o">=</span><span class="mi">5</span>

    <span class="c1">#additional parameter only used for rotation measure data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">is_rm</span><span class="o">=</span><span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rm</span><span class="o">=</span><span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rm_vmin</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rm_vmax</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

    <span class="c1"># additional parameter only used for Spectral turnover data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">is_turnover</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">turnover</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">turnover_flux</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">turnover_error</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">turnover_chi_sq</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.align" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">align</span><span class="p">(</span><span class="n">image_data2</span><span class="p">,</span> <span class="n">masked_shift</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;cross_correlation&#39;</span><span class="p">,</span> <span class="n">beam_arg</span><span class="o">=</span><span class="s1">&#39;common&#39;</span><span class="p">,</span> <span class="n">auto_regrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">useDIFMAP</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">comp_ids</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">weight_by_comp_err</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>This function aligns the image to a reference image (image_data2).</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>image_data2</code></b>
                  (<code><a class="autorefs autorefs-internal" title="vcat.image_data.ImageData" href="#vcat.image_data.ImageData">ImageData</a></code>)
              –
              <div class="doc-md-description">
                <p>ImageData object of the reference image</p>
              </div>
            </li>
            <li>
              <b><code>masked_shift</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to consider the image masks for alignment</p>
              </div>
            </li>
            <li>
              <b><code>method</code></b>
              –
              <div class="doc-md-description">
                <p>Choose alignment method (Options: 'cross_correlation', 'brightest', 'modelcomp')</p>
              </div>
            </li>
            <li>
              <b><code>beam_arg</code></b>
                  (<code>str</code>, default:
                      <code>&#39;common&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Choose which common beam to use (Options: 'common', 'max', 'min'), only applied when auto_regrid=True</p>
              </div>
            </li>
            <li>
              <b><code>auto_regrid</code></b>
                  (<code>bool</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to automatically regrid and restore both images to a common beam and image size.</p>
              </div>
            </li>
            <li>
              <b><code>useDIFMAP</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to use DIFMAP for image operations or not.</p>
              </div>
            </li>
            <li>
              <b><code>comp_ids</code></b>
                  (<code>int or list[int]</code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Component IDs to use for the alignment in 'modelcomp' mode.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>image</code></b>(                  <code><a class="autorefs autorefs-internal" title="vcat.image_data.ImageData" href="#vcat.image_data.ImageData">ImageData</a></code>
)              –
              <div class="doc-md-description">
                <p>aligned imaged (possibly also regridded and restored if auto_regrid=True).</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">align</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">image_data2</span><span class="p">,</span><span class="n">masked_shift</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;cross_correlation&quot;</span><span class="p">,</span><span class="n">beam_arg</span><span class="o">=</span><span class="s2">&quot;common&quot;</span><span class="p">,</span> <span class="n">auto_regrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
          <span class="n">useDIFMAP</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">comp_ids</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">weight_by_comp_err</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function aligns the image to a reference image (image_data2).</span>

<span class="sd">    Args:</span>
<span class="sd">        image_data2 (ImageData): ImageData object of the reference image</span>
<span class="sd">        masked_shift (bool): Choose whether to consider the image masks for alignment</span>
<span class="sd">        method: Choose alignment method (Options: &#39;cross_correlation&#39;, &#39;brightest&#39;, &#39;modelcomp&#39;)</span>
<span class="sd">        beam_arg (str): Choose which common beam to use (Options: &#39;common&#39;, &#39;max&#39;, &#39;min&#39;), only applied when auto_regrid=True</span>
<span class="sd">        auto_regrid (bool): Choose whether to automatically regrid and restore both images to a common beam and image size.</span>
<span class="sd">        useDIFMAP (bool): Choose whether to use DIFMAP for image operations or not.</span>
<span class="sd">        comp_ids (int or list[int]): Component IDs to use for the alignment in &#39;modelcomp&#39; mode.</span>

<span class="sd">    Returns:</span>
<span class="sd">        image (ImageData): aligned imaged (possibly also regridded and restored if auto_regrid=True).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">==</span><span class="n">image_data2</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">image_data2</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">!=</span> <span class="n">image_data2</span><span class="o">.</span><span class="n">degpp</span><span class="p">)</span> <span class="ow">or</span> <span class="n">auto_regrid</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">auto_regrid</span><span class="p">:</span>
            <span class="c1"># if this is selected will automatically convolve with common beam and regrid</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Automatically regridding image to minimum pixelsize, smallest FOV and common beam&quot;</span><span class="p">)</span>

            <span class="c1">#determin common image parameters</span>
            <span class="n">pixel_size</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span><span class="n">image_data2</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="n">image_data2</span><span class="o">.</span><span class="n">scale</span><span class="p">])</span>
            <span class="c1">#TODO: change this to maximum FoV? (to make sure no information is lost in any map)</span>
            <span class="c1"># aligning this also with the edit by FMP in image_cube.py regrid function</span>
            <span class="n">min_fov</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span><span class="n">image_data2</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">image_data2</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">])</span>
            <span class="n">npix</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">min_fov</span><span class="o">/</span><span class="n">pixel_size</span><span class="p">)</span>

            <span class="c1">#get common beam</span>
            <span class="n">common_beam</span><span class="o">=</span><span class="n">get_common_beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span><span class="n">image_data2</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">],</span>
                                        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span><span class="n">image_data2</span><span class="o">.</span><span class="n">beam_min</span><span class="p">],</span>
                                        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">,</span><span class="n">image_data2</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">],</span><span class="n">arg</span><span class="o">=</span><span class="n">beam_arg</span><span class="p">)</span>

            <span class="c1">#regrid images</span>
            <span class="n">image_self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># convolve with common beam</span>
            <span class="n">image_self</span> <span class="o">=</span> <span class="n">image_self</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">useDIFMAP</span><span class="o">=</span><span class="n">useDIFMAP</span><span class="p">)</span>
            <span class="n">image_self</span> <span class="o">=</span> <span class="n">image_self</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">common_beam</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">common_beam</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">common_beam</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">useDIFMAP</span><span class="o">=</span><span class="n">useDIFMAP</span><span class="p">)</span>

            <span class="c1"># same for image 2</span>
            <span class="n">image_data2</span> <span class="o">=</span> <span class="n">image_data2</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">useDIFMAP</span><span class="o">=</span><span class="n">useDIFMAP</span><span class="p">)</span>
            <span class="n">image_data2</span> <span class="o">=</span> <span class="n">image_data2</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">common_beam</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">common_beam</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">common_beam</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">useDIFMAP</span><span class="o">=</span><span class="n">useDIFMAP</span><span class="p">)</span>



        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">method</span><span class="o">==</span><span class="s2">&quot;modelcomp&quot;</span> <span class="ow">or</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;model_comp&quot;</span> <span class="ow">or</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;model&quot;</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Images do not have the same npix and pixelsize, please regrid first or use auto_regrid=True.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image_self</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image_self</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;cross_correlation&quot;</span> <span class="ow">or</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;crosscorrelation&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">image_data2</span><span class="o">.</span><span class="n">mask</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">image_self</span><span class="o">.</span><span class="n">mask</span><span class="o">==</span><span class="kc">False</span><span class="p">))</span> <span class="ow">or</span> <span class="n">masked_shift</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>

            <span class="n">shift</span><span class="p">,</span><span class="n">error</span><span class="p">,</span><span class="n">diffphase</span> <span class="o">=</span> <span class="n">phase_cross_correlation</span><span class="p">(</span><span class="n">image_data2</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="n">image_self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="n">upsample_factor</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;will apply shift (x,y): [</span><span class="si">{}</span><span class="s1"> : </span><span class="si">{}</span><span class="s1">] </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span> <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># contrary to the skikit-image documentation, only the shift is returned for masked cross-correlation</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="n">phase_cross_correlation</span><span class="p">(</span><span class="n">image_data2</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="n">image_self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="n">upsample_factor</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">reference_mask</span><span class="o">=</span><span class="n">image_data2</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span><span class="n">moving_mask</span><span class="o">=</span><span class="n">image_self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;will apply shift (x,y): [</span><span class="si">{}</span><span class="s1"> : </span><span class="si">{}</span><span class="s1">] </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span> <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;brightest&quot;</span><span class="p">:</span>
        <span class="c1">#align images on brightest pixel</span>
        <span class="c1">#find brightest pixel of reference image and image</span>
        <span class="n">x_ind</span><span class="p">,</span><span class="n">y_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">image_data2</span><span class="o">.</span><span class="n">Z</span><span class="p">),</span> <span class="n">image_data2</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">x_</span><span class="p">,</span><span class="n">y_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">image_self</span><span class="o">.</span><span class="n">Z</span><span class="p">),</span> <span class="n">image_self</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">shift</span><span class="o">=</span><span class="p">[</span><span class="n">y_ind</span><span class="o">-</span><span class="n">y_</span><span class="p">,</span><span class="n">x_ind</span><span class="o">-</span><span class="n">x_</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;will apply shift (x,y): [</span><span class="si">{}</span><span class="s1"> : </span><span class="si">{}</span><span class="s1">] </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">image_self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span>
                                                             <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">image_self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;modelcomp&quot;</span> <span class="ow">or</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;model_comp&quot;</span> <span class="ow">or</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;model&quot;</span><span class="p">:</span>
        <span class="c1">#get models of both images</span>
        <span class="n">comps1</span><span class="o">=</span><span class="n">image_self</span><span class="o">.</span><span class="n">components</span>
        <span class="n">ref_comps</span><span class="o">=</span><span class="n">image_data2</span><span class="o">.</span><span class="n">components</span>

        <span class="k">if</span> <span class="n">comp_ids</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please specify valid component IDs with &#39;comp_ids=...&#39;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comp_ids</span><span class="o">==</span><span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="c1">#find all possible component ids</span>
                <span class="n">comp_ids</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">image_self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                    <span class="n">comp_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">component_number</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">image_data2</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                    <span class="n">comp_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">component_number</span><span class="p">)</span>

                <span class="n">comp_ids</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">comp_ids</span><span class="p">)</span>

            <span class="n">comp_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">comp_ids</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp_ids</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">comp_ids</span>
            <span class="n">x_shifts</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">y_shifts</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">x_shift_err</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">y_shift_err</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">comp_id</span> <span class="ow">in</span> <span class="n">comp_ids</span><span class="p">:</span>
                <span class="c1">#get component from comps1:</span>
                <span class="n">found</span><span class="o">=</span><span class="kc">False</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">component_number</span><span class="o">==</span><span class="n">comp_id</span><span class="p">:</span>
                        <span class="n">align_comp</span><span class="o">=</span><span class="n">comp</span>
                        <span class="n">found</span><span class="o">=</span><span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                    <span class="n">align_comp</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
                <span class="n">found</span><span class="o">=</span><span class="kc">False</span>
                <span class="k">for</span> <span class="n">ref_comp</span> <span class="ow">in</span> <span class="n">ref_comps</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ref_comp</span><span class="o">.</span><span class="n">component_number</span><span class="o">==</span><span class="n">comp_id</span><span class="p">:</span>
                        <span class="n">align_comp_ref</span><span class="o">=</span><span class="n">ref_comp</span>
                        <span class="n">found</span><span class="o">=</span><span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                    <span class="n">align_comp_ref</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

                <span class="k">if</span> <span class="n">align_comp</span><span class="o">!=</span><span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">align_comp_ref</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="c1">#this means a component with the given comp_id was found in both images</span>
                    <span class="c1">#calculate shift:</span>
                    <span class="n">x1</span><span class="o">=</span><span class="n">align_comp</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span>
                    <span class="n">x_ref</span><span class="o">=</span><span class="n">align_comp_ref</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">image_data2</span><span class="o">.</span><span class="n">scale</span>
                    <span class="n">y1</span><span class="o">=</span><span class="n">align_comp</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span>
                    <span class="n">y_ref</span><span class="o">=</span><span class="n">align_comp_ref</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">image_data2</span><span class="o">.</span><span class="n">scale</span>

                    <span class="n">x_shifts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">x_ref</span><span class="p">)</span>
                    <span class="n">y_shifts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_ref</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span>
                    <span class="n">x_shift_err</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">align_comp</span><span class="o">.</span><span class="n">x_err</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">align_comp_ref</span><span class="o">.</span><span class="n">x_err</span><span class="o">*</span><span class="n">image_data2</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">y_shift_err</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">align_comp</span><span class="o">.</span><span class="n">y_err</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">align_comp_ref</span><span class="o">.</span><span class="n">y_err</span><span class="o">*</span><span class="n">image_data2</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Did no find component with id </span><span class="si">{</span><span class="n">comp_id</span><span class="si">}</span><span class="s2"> in both images, skipping it&quot;</span><span class="p">)</span>

            <span class="c1">#take mean shift if multiple components were used</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No matching components found, will not apply a shift.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">weight_by_comp_err</span><span class="p">:</span>
                    <span class="c1"># Compute weights as inverse variance</span>
                    <span class="n">weights_x</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_shift_err</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                    <span class="n">weights_y</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_shift_err</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

                    <span class="c1"># Weighted mean</span>
                    <span class="n">x_shift_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights_x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights_x</span><span class="p">)</span>
                    <span class="n">y_shift_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights_y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights_y</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x_shift_final</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">)</span>
                    <span class="n">y_shift_final</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">)</span>

                <span class="n">shift</span><span class="o">=</span><span class="p">[</span><span class="n">y_shift_final</span><span class="o">/</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span><span class="n">x_shift_final</span><span class="o">/</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;will apply shift (x,y): [</span><span class="si">{}</span><span class="s1"> : </span><span class="si">{}</span><span class="s1">] </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">image_self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span>
                                                                   <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">image_self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>


    <span class="k">else</span><span class="p">:</span>
        <span class="n">warning</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Please use valid align method (&#39;cross_correlation&#39;,&#39;brightest&#39;).&quot;</span><span class="p">)</span>

    <span class="c1">#shift shifted image</span>
    <span class="k">return</span> <span class="n">image_self</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span><span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">scale</span><span class="o">*</span><span class="n">image_self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span><span class="n">useDIFMAP</span><span class="o">=</span><span class="n">useDIFMAP</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.calculate_opening_angle" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_opening_angle</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">snr_cut</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculates the opening angle for circular Gauss components between the core component and a given component
Args:
    ids (int, list[int]): Component ID of component to calculate the opening angle for</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>angle</code></b>(                  <code>list[float]</code>
)              –
              <div class="doc-md-description">
                <p>Opening angles in degrees</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_opening_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ids</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">snr_cut</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the opening angle for circular Gauss components between the core component and a given component</span>
<span class="sd">    Args:</span>
<span class="sd">        ids (int, list[int]): Component ID of component to calculate the opening angle for</span>

<span class="sd">    Returns:</span>
<span class="sd">        angle (list[float]): Opening angles in degrees</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">ids</span><span class="o">=</span><span class="n">ids</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
        <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ids</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid IDs provided.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ids</span><span class="p">,</span><span class="n">core_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()</span>
            <span class="n">ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">core_id</span><span class="p">)</span>

    <span class="n">core</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_core_component</span><span class="p">()</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span><span class="n">Component</span><span class="p">)</span> <span class="ow">and</span> <span class="n">comp</span><span class="o">.</span><span class="n">resolved</span> <span class="ow">and</span> <span class="n">comp</span><span class="o">.</span><span class="n">snr</span><span class="o">&gt;=</span><span class="n">snr_cut</span><span class="p">:</span>

                <span class="n">comp_dist</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">maj</span><span class="o">*</span><span class="n">comp</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="mi">2</span>
                <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">resolved</span><span class="p">:</span>
                    <span class="n">core_dist</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">maj</span><span class="o">*</span><span class="n">comp</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">core_dist</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">res_lim_maj</span><span class="o">*</span><span class="n">comp</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="mi">2</span>
                <span class="n">delta_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">core</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">comp</span><span class="o">.</span><span class="n">scale</span>
                <span class="n">delta_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">core</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">comp</span><span class="o">.</span><span class="n">scale</span>

<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                #this part allows to also do this calculation with elliptical components, but we should discuss if we want it like this</span>
<span class="sd">                def calculate_theta():</span>
<span class="sd">                    if (delta_y &gt; 0 and delta_x &gt; 0) or (delta_y &gt; 0 and delta_x &lt; 0):</span>
<span class="sd">                        return np.arctan(delta_x / delta_y) / np.pi * 180</span>
<span class="sd">                    elif delta_y &lt; 0 and delta_x &gt; 0:</span>
<span class="sd">                        return np.arctan(delta_x / delta_y) / np.pi * 180 + 180</span>
<span class="sd">                    elif delta_y &lt; 0 and delta_x &lt; 0:</span>
<span class="sd">                        return np.arctan(delta_x / delta_y) / np.pi * 180 - 180</span>
<span class="sd">                    else:</span>
<span class="sd">                        return 0</span>

<span class="sd">                theta = calculate_theta()</span>

<span class="sd">                # check core resolution limit</span>
<span class="sd">                theta_maj, theta_min = get_resolution_limit(self.beam_maj, self.beam_min, self.beam_pa, theta, core.snr,</span>
<span class="sd">                                                            method=res_lim_method, weighting=self.uvw)</span>

<span class="sd">                new_pos=theta-comp.pos+90</span>
<span class="sd">                new_pos_core=theta-core.pos+90</span>

<span class="sd">                line_comp = Line(Point(0, 0), Point(np.cos(new_pos / 180 * np.pi), np.sin(new_pos / 180 * np.pi)))</span>
<span class="sd">                line_core = Line(Point(0, 0), Point(np.cos(new_pos_core / 180 * np.pi), np.sin(new_pos_core / 180 * np.pi)))</span>

<span class="sd">                core_Ellipse=Ellipse(Point(0,0),hradius=core.maj*comp.scale/2,vradius=core.min*comp.scale/2)</span>
<span class="sd">                comp_Ellipse=Ellipse(Point(0,0),hradius=comp.maj*comp.scale/2,vradius=comp.min*comp.scale/2)</span>

<span class="sd">                if core.maj==0 or core.min==0:</span>
<span class="sd">                    core_dist=np.abs(theta_maj/2)</span>
<span class="sd">                else:</span>
<span class="sd">                    p1, p2 = core_Ellipse.intersect(line_core)</span>
<span class="sd">                    core_dist=np.abs(float(p1.distance(p2))/2)</span>
<span class="sd">                p1, p2 = comp_Ellipse.intersect(line_comp)</span>
<span class="sd">                comp_dist=np.abs(float(p1.distance(p2))/2)</span>
<span class="sd">                &quot;&quot;&quot;</span>

                <span class="n">dist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">delta_x</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">delta_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="c1">#calculate opening angle</span>
                <span class="n">angle</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="n">comp_dist</span><span class="o">-</span><span class="n">core_dist</span><span class="p">)</span><span class="o">/</span><span class="n">dist</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="o">*</span><span class="mi">2</span>

                <span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Component </span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">component_number</span><span class="si">}</span><span class="s2"> unresolved, will not calculate opening angle.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Component </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> not found, will skip it.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">angles</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.center" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">center</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;stokes_i&#39;</span><span class="p">,</span> <span class="n">useDIFMAP</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to center the brightest pixel of the image.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>mode</code></b>
              –
              <div class="doc-md-description">
                <p>Choose which map to use ('stokes_i', 'lin_pol','core')</p>
              </div>
            </li>
            <li>
              <b><code>useDIFMAP</code></b>
              –
              <div class="doc-md-description">
                <p>Choose whether to use DIFMAP or not.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>Shifted ImageData object</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;stokes_i&quot;</span><span class="p">,</span><span class="n">useDIFMAP</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to center the brightest pixel of the image.</span>

<span class="sd">    Args:</span>
<span class="sd">        mode: Choose which map to use (&#39;stokes_i&#39;, &#39;lin_pol&#39;,&#39;core&#39;)</span>
<span class="sd">        useDIFMAP: Choose whether to use DIFMAP or not.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Shifted ImageData object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;stokes_i&quot;</span> <span class="ow">or</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;lin_pol&quot;</span> <span class="ow">or</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;linpol&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;stokes_i&quot;</span><span class="p">:</span>
            <span class="n">ref_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span>
        <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;lin_pol&quot;</span> <span class="ow">or</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;linpol&quot;</span><span class="p">:</span>
            <span class="n">ref_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span>

        <span class="c1"># find brightest pixel of reference image and center of current image</span>
        <span class="n">x_ind</span><span class="p">,</span> <span class="n">y_ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">x_</span><span class="p">,</span> <span class="n">y_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">ref_image</span><span class="p">),</span> <span class="n">ref_image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">shift</span> <span class="o">=</span> <span class="p">[</span><span class="n">y_ind</span> <span class="o">-</span> <span class="n">y_</span><span class="p">,</span> <span class="n">x_ind</span> <span class="o">-</span> <span class="n">x_</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;will apply shift (x,y): [</span><span class="si">{}</span><span class="s1"> : </span><span class="si">{}</span><span class="s1">] </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span>
                                                             <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span>
                          <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">,</span> <span class="n">useDIFMAP</span><span class="o">=</span><span class="n">useDIFMAP</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;core&quot;</span><span class="p">:</span>
        <span class="n">core</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_core_component</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">core</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">core</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span><span class="o">-</span><span class="n">core</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">core</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span><span class="n">useDIFMAP</span><span class="o">=</span><span class="n">useDIFMAP</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please pick valid &#39;mode&#39; parameter (&#39;stokes_i&#39;,&#39;lin_pol&#39;,&#39;core&#39;).&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.change_component_ids" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">change_component_ids</span><span class="p">(</span><span class="n">old_ids</span><span class="p">,</span> <span class="n">new_ids</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to assign new component numbers</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>old_ids</code></b>
                  (<code>int or list[int]</code>)
              –
              <div class="doc-md-description">
                <p>Old component IDs</p>
              </div>
            </li>
            <li>
              <b><code>new_ids</code></b>
                  (<code>int or list[int]</code>)
              –
              <div class="doc-md-description">
                <p>New component IDs</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">change_component_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">old_ids</span><span class="p">,</span><span class="n">new_ids</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to assign new component numbers</span>

<span class="sd">    Args:</span>
<span class="sd">        old_ids (int or list[int]): Old component IDs</span>
<span class="sd">        new_ids (int or list[int]): New component IDs</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#handle single value input</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">old_ids</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_ids</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
        <span class="n">old_ids</span><span class="o">=</span><span class="p">[</span><span class="n">old_ids</span><span class="p">]</span>
        <span class="n">new_ids</span><span class="o">=</span><span class="p">[</span><span class="n">new_ids</span><span class="p">]</span>

    <span class="n">old_ids</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">old_ids</span><span class="p">)</span>
    <span class="n">new_ids</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_ids</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">old_ids</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_ids</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">new_ids</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_ids</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Component number specified more than one time in old_ids or new_ids!&quot;</span><span class="p">)</span>

    <span class="c1">#set new component ids</span>
    <span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">component_number</span> <span class="ow">in</span> <span class="n">old_ids</span><span class="p">:</span>
            <span class="n">i</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">old_ids</span><span class="p">)</span><span class="o">==</span><span class="n">comp</span><span class="o">.</span><span class="n">component_number</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">component_number</span><span class="o">=</span><span class="n">new_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">component_number</span> <span class="ow">in</span> <span class="n">new_ids</span><span class="p">:</span>
                <span class="c1">#in that case we will reset the component id to avoid duplication</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">component_number</span><span class="o">=-</span><span class="mi">1</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.copy" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">copy</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create copy of the current ImageData object</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>image</code></b>(                  <code><a class="autorefs autorefs-internal" title="vcat.image_data.ImageData" href="#vcat.image_data.ImageData">ImageData</a></code>
)              –
              <div class="doc-md-description">
                <p>Copied image</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create copy of the current ImageData object</span>

<span class="sd">    Returns:</span>
<span class="sd">        image (ImageData): Copied image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.export" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">export</span><span class="p">(</span><span class="n">outputfile</span><span class="p">,</span> <span class="n">polarization</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to export fits file</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>outputfile</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>Name/path of the intended output file</p>
              </div>
            </li>
            <li>
              <b><code>polarization</code></b>
                  (<code>str</code>, default:
                      <code>&#39;I&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Polarization to export ('I','Q','U')</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outputfile</span><span class="p">,</span><span class="n">polarization</span><span class="o">=</span><span class="s2">&quot;I&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to export fits file</span>

<span class="sd">    Args:</span>
<span class="sd">        outputfile (str): Name/path of the intended output file</span>
<span class="sd">        polarization (str): Polarization to export (&#39;I&#39;,&#39;Q&#39;,&#39;U&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">polarization</span><span class="o">==</span><span class="s2">&quot;I&quot;</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cp </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">outputfile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stokes </span><span class="si">{</span><span class="n">polarization</span><span class="si">}</span><span class="s2"> succesfully exported to </span><span class="si">{</span><span class="n">outputfile</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">polarization</span><span class="o">==</span><span class="s2">&quot;Q&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_path</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stokes </span><span class="si">{</span><span class="n">polarization</span><span class="si">}</span><span class="s2"> succesfully exported to </span><span class="si">{</span><span class="n">outputfile</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cp </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">outputfile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stokes </span><span class="si">{</span><span class="n">polarization</span><span class="si">}</span><span class="s2"> succesfully exported to </span><span class="si">{</span><span class="n">outputfile</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">polarization</span><span class="o">==</span><span class="s2">&quot;U&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_path</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stokes </span><span class="si">{</span><span class="n">polarization</span><span class="si">}</span><span class="s2"> succesfully exported to </span><span class="si">{</span><span class="n">outputfile</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cp </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">outputfile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stokes </span><span class="si">{</span><span class="n">polarization</span><span class="si">}</span><span class="s2"> succesfully exported to </span><span class="si">{</span><span class="n">outputfile</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.fit_collimation_profile" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit_collimation_profile</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">jet</span><span class="o">=</span><span class="s1">&#39;Jet&#39;</span><span class="p">,</span> <span class="n">fit_type</span><span class="o">=</span><span class="s1">&#39;brokenPowerlaw&#39;</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">plot_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fit_r0</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shift_r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="n">plot_markers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to fit a collimation profile to the jet/counterjet</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>method</code></b>
                  (<code>str</code>, default:
                      <code>&#39;model&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Method to use for collimation profile ('model' to use model components, 'ridgeline' to use ridgeline fit)</p>
              </div>
            </li>
            <li>
              <b><code>jet</code></b>
                  (<code>str</code>, default:
                      <code>&#39;Jet&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to do Jet ('Jet'), Counterjet ('Cjet') or both ('Twin')</p>
              </div>
            </li>
            <li>
              <b><code>fit_type</code></b>
                  (<code>str</code>, default:
                      <code>&#39;brokenPowerlaw&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Choose fit_type to use ('brokenPowerlaw' or 'Powerlaw')</p>
              </div>
            </li>
            <li>
              <b><code>x0_bpl</code></b>
                  (<code>list[float]</code>)
              –
              <div class="doc-md-description">
                <p>Start values for fit</p>
              </div>
            </li>
            <li>
              <b><code>plot_data</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to plot the fitted data</p>
              </div>
            </li>
            <li>
              <b><code>plot_fit</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to plot the fit</p>
              </div>
            </li>
            <li>
              <b><code>fit_r0</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to include (r+r0) in fit or just r</p>
              </div>
            </li>
            <li>
              <b><code>shift_r</code></b>
                  (<code>float</code>, default:
                      <code>0</code>
)
              –
              <div class="doc-md-description">
                <p>Shift plot by radius in mas.</p>
              </div>
            </li>
            <li>
              <b><code>plot</code></b>
                  (<code><span title="vcat.plots.jet_profile_plot.JetProfilePlot">JetProfilePlot</span></code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Pass JetProfilePlot to add plots, default will create a new one</p>
              </div>
            </li>
            <li>
              <b><code>show</code></b>
                  (<code>bool</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to show the plot</p>
              </div>
            </li>
            <li>
              <b><code>label</code></b>
                  (<code>str</code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Label for the fitted data/fit</p>
              </div>
            </li>
            <li>
              <b><code>color</code></b>
                  (<code>str</code>, default:
                      <code><span title="vcat.config.plot_colors">plot_colors</span>[0]</code>
)
              –
              <div class="doc-md-description">
                <p>Plot color</p>
              </div>
            </li>
            <li>
              <b><code>marker</code></b>
                  (<code>str</code>, default:
                      <code><span title="vcat.config.plot_markers">plot_markers</span>[0]</code>
)
              –
              <div class="doc-md-description">
                <p>Plot marker</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>plot</code></b>(                  <code><span title="vcat.plots.jet_profile_plot.JetProfilePlot">JetProfilePlot</span></code>
)              –
              <div class="doc-md-description">
                <p>Jet profile plot</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">fit_collimation_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">,</span><span class="n">jet</span><span class="o">=</span><span class="s2">&quot;Jet&quot;</span><span class="p">,</span><span class="n">fit_type</span><span class="o">=</span><span class="s1">&#39;brokenPowerlaw&#39;</span><span class="p">,</span><span class="n">x0</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                            <span class="n">plot_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">plot_fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">fit_r0</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">shift_r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">plot_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">marker</span><span class="o">=</span><span class="n">plot_markers</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to fit a collimation profile to the jet/counterjet</span>

<span class="sd">    Args:</span>
<span class="sd">        method (str): Method to use for collimation profile (&#39;model&#39; to use model components, &#39;ridgeline&#39; to use ridgeline fit)</span>
<span class="sd">        jet (str): Choose whether to do Jet (&#39;Jet&#39;), Counterjet (&#39;Cjet&#39;) or both (&#39;Twin&#39;)</span>
<span class="sd">        fit_type (str): Choose fit_type to use (&#39;brokenPowerlaw&#39; or &#39;Powerlaw&#39;)</span>
<span class="sd">        x0_bpl (list[float]): Start values for fit</span>
<span class="sd">        plot_data (bool): Choose whether to plot the fitted data</span>
<span class="sd">        plot_fit (bool): Choose whether to plot the fit</span>
<span class="sd">        fit_r0 (bool): Choose whether to include (r+r0) in fit or just r</span>
<span class="sd">        shift_r (float): Shift plot by radius in mas.</span>
<span class="sd">        plot (JetProfilePlot): Pass JetProfilePlot to add plots, default will create a new one</span>
<span class="sd">        show (bool): Choose whether to show the plot</span>
<span class="sd">        label (str): Label for the fitted data/fit</span>
<span class="sd">        color (str): Plot color</span>
<span class="sd">        marker (str): Plot marker</span>

<span class="sd">    Returns:</span>
<span class="sd">        plot (JetProfilePlot): Jet profile plot</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fit_fail_jet</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">fit_fail_counterjet</span><span class="o">=</span><span class="kc">False</span>

    <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;model&quot;</span><span class="p">:</span>
        <span class="c1">#TODO make it work also for counterjet</span>
        <span class="c1">#jet info</span>
        <span class="n">dists</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">widths</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">width_errs</span><span class="o">=</span><span class="p">[]</span>

        <span class="c1">#counter jet info</span>
        <span class="n">cdists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cwidths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cwidth_errs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="c1">#if component Jet</span>
            <span class="n">dists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">distance_to_core</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
            <span class="n">widths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">maj</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
            <span class="n">width_errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">maj_err</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
            <span class="c1">#else component counterjet</span>
                <span class="c1">#cdists.append(comp.distance_to_core * self.scale)</span>
                <span class="c1">#cwidths.append(comp.maj * self.scale)</span>
                <span class="c1">#cwidth_errs.append(comp.maj_err * self.scale)</span>

    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;ridgeline&quot;</span><span class="p">:</span>

        <span class="c1">#jet info</span>
        <span class="n">dists</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">.</span><span class="n">dist</span>
        <span class="n">widths</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">.</span><span class="n">width</span>
        <span class="n">width_errs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">.</span><span class="n">width_err</span>

        <span class="c1">#counterjet info</span>
        <span class="n">cdists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="o">.</span><span class="n">dist</span>
        <span class="n">cwidths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="o">.</span><span class="n">width</span>
        <span class="n">cwidth_errs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="o">.</span><span class="n">width_err</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please specify valid &#39;method&#39; for fit_collimation_profile (&#39;model&#39;, &#39;ridgeline&#39;).&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">jet</span><span class="o">==</span><span class="s2">&quot;Jet&quot;</span> <span class="ow">or</span> <span class="n">jet</span><span class="o">==</span><span class="s2">&quot;Twin&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">beta</span><span class="p">,</span> <span class="n">sd_beta</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">fit_width</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">widths</span><span class="p">,</span> <span class="n">width_err</span><span class="o">=</span><span class="n">width_errs</span><span class="p">,</span> <span class="n">dist_err</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                                                 <span class="n">fit_type</span><span class="o">=</span><span class="n">fit_type</span><span class="p">,</span><span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span><span class="n">fit_r0</span><span class="o">=</span><span class="n">fit_r0</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Collimation fit did not work for jet!&quot;</span><span class="p">)</span>
            <span class="n">fit_fail_jet</span><span class="o">=</span><span class="kc">True</span>

    <span class="k">if</span> <span class="n">jet</span><span class="o">==</span><span class="s2">&quot;CJet&quot;</span> <span class="ow">or</span> <span class="n">jet</span><span class="o">==</span><span class="s2">&quot;Twin&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cbeta</span><span class="p">,</span> <span class="n">csd_beta</span><span class="p">,</span> <span class="n">cchi2</span><span class="p">,</span> <span class="n">cout</span> <span class="o">=</span> <span class="n">fit_width</span><span class="p">(</span><span class="n">cdists</span><span class="p">,</span> <span class="n">cwidths</span><span class="p">,</span> <span class="n">width_err</span><span class="o">=</span><span class="n">cwidth_errs</span><span class="p">,</span> <span class="n">dist_err</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                                                 <span class="n">fit_type</span><span class="o">=</span><span class="n">fit_type</span><span class="p">,</span><span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span><span class="n">fit_r0</span><span class="o">=</span><span class="n">fit_r0</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Collimation fit did not work for counter jet!&quot;</span><span class="p">)</span>
            <span class="n">fit_fail_counterjet</span><span class="o">=</span><span class="kc">True</span>

    <span class="k">if</span> <span class="n">plot</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">plot</span><span class="o">=</span><span class="n">JetProfilePlot</span><span class="p">(</span><span class="n">jet</span><span class="o">=</span><span class="n">jet</span><span class="p">,</span><span class="n">redshift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">,</span><span class="n">shift_r</span><span class="o">=</span><span class="n">shift_r</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">plot</span><span class="o">.</span><span class="n">jet</span> <span class="o">!=</span> <span class="n">jet</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Plot has wrong &#39;jet&#39; type.&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Plot is not a valid &#39;JetProfilePlot&#39;.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_data</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">jet</span><span class="o">==</span><span class="s2">&quot;Jet&quot;</span><span class="p">:</span>
            <span class="n">plot</span><span class="o">.</span><span class="n">plot_profile</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span><span class="n">widths</span><span class="p">,</span><span class="n">width_errs</span><span class="p">,</span><span class="n">color</span><span class="p">,</span><span class="n">marker</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">jet</span><span class="o">==</span><span class="s2">&quot;CJet&quot;</span><span class="p">:</span>
            <span class="n">plot</span><span class="o">.</span><span class="n">plot_profile</span><span class="p">(</span><span class="n">cdists</span><span class="p">,</span><span class="n">cwidths</span><span class="p">,</span><span class="n">cwidth_errs</span><span class="p">,</span><span class="n">color</span><span class="p">,</span><span class="n">marker</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot</span><span class="o">.</span><span class="n">plot_profile</span><span class="p">([</span><span class="n">dists</span><span class="p">,</span><span class="n">cdists</span><span class="p">],[</span><span class="n">widths</span><span class="p">,</span><span class="n">cwidths</span><span class="p">],[</span><span class="n">width_errs</span><span class="p">,</span><span class="n">cwidth_errs</span><span class="p">],</span><span class="n">color</span><span class="p">,</span><span class="n">marker</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

    <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">dists</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">dists</span><span class="p">),</span><span class="mi">1000</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_fit</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">jet</span><span class="o">==</span><span class="s2">&quot;Jet&quot;</span> <span class="ow">or</span> <span class="n">jet</span><span class="o">==</span><span class="s2">&quot;Twin&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fit_fail_jet</span><span class="p">:</span>
                <span class="n">plot</span><span class="o">.</span><span class="n">plot_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fit_type</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">sd_beta</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="s2">&quot;Jet&quot;</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span><span class="n">fit_r0</span><span class="o">=</span><span class="n">fit_r0</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jet</span><span class="o">==</span><span class="s2">&quot;CJet&quot;</span> <span class="ow">or</span> <span class="n">jet</span><span class="o">==</span><span class="s2">&quot;Twin&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fit_fail_counterjet</span><span class="p">:</span>
                <span class="n">plot</span><span class="o">.</span><span class="n">plot_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fit_type</span><span class="p">,</span> <span class="n">cbeta</span><span class="p">,</span> <span class="n">csd_beta</span><span class="p">,</span> <span class="n">cchi2</span><span class="p">,</span> <span class="s2">&quot;CJet&quot;</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span><span class="n">fit_r0</span><span class="o">=</span><span class="n">fit_r0</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plot</span><span class="o">.</span><span class="n">plot_legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">plot</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.fit_comp_polarization" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit_comp_polarization</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to fit polarization to existing Stokes I model components. Will use DIFMAP to fit a Stokes Q and
Stokes Q amplitude to the Stokes I components.</p>

            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">fit_comp_polarization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to fit polarization to existing Stokes I model components. Will use DIFMAP to fit a Stokes Q and</span>
<span class="sd">    Stokes Q amplitude to the Stokes I components.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">write_mod_file_from_components</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span><span class="n">export</span><span class="o">=</span><span class="s2">&quot;tmp/model_q.mod&quot;</span><span class="p">,</span><span class="n">adv</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">])</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;cp tmp/model_q.mod tmp/model_u.mod&quot;</span><span class="p">)</span>
    <span class="n">comps_q</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">)</span>
    <span class="n">comps_u</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">)</span>
    <span class="n">comps_q</span><span class="o">=</span><span class="n">modelfit_difmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">,</span><span class="s2">&quot;tmp/model_q.mod&quot;</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="n">difmap_path</span><span class="p">,</span><span class="n">components</span><span class="o">=</span><span class="n">comps_q</span><span class="p">,</span>
                            <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;q&quot;</span><span class="p">,</span><span class="n">do_selfcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">selfcal_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">)</span>
    <span class="n">comps_u</span><span class="o">=</span><span class="n">modelfit_difmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">,</span><span class="s2">&quot;tmp/model_u.mod&quot;</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="n">difmap_path</span><span class="p">,</span><span class="n">components</span><span class="o">=</span><span class="n">comps_u</span><span class="p">,</span>
                            <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;u&quot;</span><span class="p">,</span><span class="n">do_selfcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">selfcal_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comps_q</span><span class="p">)):</span>
            <span class="c1">#we need to check the component association (just to be sure)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">comps_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="o">-</span><span class="n">comp</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1e-4</span><span class="o">/</span><span class="n">comp</span><span class="o">.</span><span class="n">scale</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">comps_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="o">-</span><span class="n">comp</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1e-4</span><span class="o">/</span><span class="n">comp</span><span class="o">.</span><span class="n">scale</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">comps_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">maj</span><span class="o">-</span><span class="n">comp</span><span class="o">.</span><span class="n">maj</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1e-4</span><span class="o">/</span><span class="n">comp</span><span class="o">.</span><span class="n">scale</span><span class="p">:</span>
                <span class="c1">#calculate lin_pol and EVPA from Q and U flux</span>
                <span class="n">lin_pol</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">comps_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">comps_u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">evpa</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">comps_u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span><span class="n">comps_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span>
                <span class="c1">#set lin_pol and evpa of component</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">lin_pol</span> <span class="o">=</span> <span class="n">lin_pol</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">evpa</span> <span class="o">=</span> <span class="n">evpa</span>

                <span class="c1">#get component error in lin pol and evpa</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol_errors</span><span class="p">:</span>
                    <span class="c1">#first get q_flux_err</span>
                    <span class="n">S_p</span><span class="p">,</span> <span class="n">rms</span> <span class="o">=</span> <span class="n">get_comp_peak_rms</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">comp</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">comp</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">,</span> <span class="s2">&quot;tmp/model_q.mod&quot;</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;q&quot;</span><span class="p">,</span>
                                                <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span> <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">)</span>

                    <span class="n">comp_snr_q</span> <span class="o">=</span> <span class="n">S_p</span> <span class="o">/</span> <span class="n">rms</span>

                    <span class="k">if</span> <span class="n">S_p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">S_p</span> <span class="o">=</span> <span class="mf">0.00001</span>
                    <span class="n">sigma_p</span> <span class="o">=</span> <span class="n">rms</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">comp_snr_q</span><span class="p">)</span>

                    <span class="n">sigma_t</span> <span class="o">=</span> <span class="n">sigma_p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">comps_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">S_p</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
                    <span class="n">q_flux_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma_t</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gain_err</span> <span class="o">*</span> <span class="n">comps_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

                    <span class="c1"># get component error in lin pol and evpa</span>
                    <span class="c1">#second get u_flux_err</span>
                    <span class="n">S_p</span><span class="p">,</span> <span class="n">rms</span> <span class="o">=</span> <span class="n">get_comp_peak_rms</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">comp</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">comp</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">,</span> <span class="s2">&quot;tmp/model_u.mod&quot;</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;u&quot;</span><span class="p">,</span>
                                                 <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span> <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">)</span>
                    <span class="n">comp_snr_u</span> <span class="o">=</span> <span class="n">S_p</span> <span class="o">/</span> <span class="n">rms</span>

                    <span class="k">if</span> <span class="n">S_p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">S_p</span> <span class="o">=</span> <span class="mf">0.00001</span>
                    <span class="n">sigma_p</span> <span class="o">=</span> <span class="n">rms</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">comp_snr_u</span><span class="p">)</span>

                    <span class="n">sigma_t</span> <span class="o">=</span> <span class="n">sigma_p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">comps_u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">S_p</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
                    <span class="n">u_flux_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma_t</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gain_err</span> <span class="o">*</span> <span class="n">comps_u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

                    <span class="c1">#calculate EVPA and lin_pol error for component:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">lin_pol_err</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">comps_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">q_flux_err</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">comps_u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">u_flux_err</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">comp</span><span class="o">.</span><span class="n">lin_pol</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">evpa_err</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">comps_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">u_flux_err</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">comps_u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">q_flux_err</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">comp</span><span class="o">.</span><span class="n">lin_pol</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.get_component" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_component</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to get a specific Component.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>id</code></b>
                  (<code>int</code>)
              –
              <div class="doc-md-description">
                <p>ID of the component</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>Component</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to get a specific Component.</span>

<span class="sd">    Args:</span>
<span class="sd">        id (int): ID of the component</span>

<span class="sd">    Returns:</span>
<span class="sd">        Component</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">component_number</span><span class="o">==</span><span class="nb">id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">comp</span>

    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Component with ID </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.get_core_component" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_core_component</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to retrieve the core component.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>comp</code></b>(                  <code><span title="vcat.kinematics.Component">Component</span></code>
)              –
              <div class="doc-md-description">
                <p>Core Component</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_core_component</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to retrieve the core component.</span>

<span class="sd">    Returns:</span>
<span class="sd">        comp (Component): Core Component</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">is_core</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">comp</span>

    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No core component defined.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.get_model_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_model_info</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Helper method to get the current state of the model</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>comps</code></b>(                  <code>list</code>
)              –
              <div class="doc-md-description">
                <p>List of Component IDs and the Core Component ID</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_model_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper method to get the current state of the model</span>

<span class="sd">    Returns:</span>
<span class="sd">        comps (list): List of Component IDs and the Core Component ID</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">comp_ids</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">core_comp_id</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">!=</span><span class="p">[]:</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">comp_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">component_number</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">is_core</span><span class="p">:</span>
                <span class="n">core_comp_id</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">component_number</span>

    <span class="k">return</span> <span class="n">comp_ids</span><span class="p">,</span> <span class="n">core_comp_id</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.get_noise_from_shift" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_noise_from_shift</span><span class="p">(</span><span class="n">shift_factor</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to calculate the image noise by shifting the phase center with DIFMAP</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>shift_factor</code></b>
                  (<code>float</code>, default:
                      <code>20</code>
)
              –
              <div class="doc-md-description">
                <p>Factor of how far times the image size to shift the phase center away.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>noise</code></b>(                  <code>float</code>
)              –
              <div class="doc-md-description">
                <p>Noise value in Jy</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_noise_from_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">shift_factor</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate the image noise by shifting the phase center with DIFMAP</span>

<span class="sd">    Args:</span>
<span class="sd">        shift_factor (float): Factor of how far times the image size to shift the phase center away.</span>

<span class="sd">    Returns:</span>
<span class="sd">        noise (float): Noise value in Jy</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Shift not possible, no .uvf file attached to ImageData!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span>

    <span class="n">size_x</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
    <span class="n">size_y</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

    <span class="c1">#shift data away to get rms</span>
    <span class="n">shifted_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">size_x</span><span class="o">*</span><span class="n">shift_factor</span><span class="p">,</span><span class="n">size_y</span><span class="o">*</span><span class="n">shift_factor</span><span class="p">)</span>

    <span class="n">noise</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">shifted_image</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">noise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.get_peak_distance" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_peak_distance</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to calculate the Distance between Stokes I and Linear Polarization Peak</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>[x_dist,y_dist]: Vector difference between Stokes I and Lin-Pol peak (in mas)</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_peak_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate the Distance between Stokes I and Linear Polarization Peak</span>

<span class="sd">    Returns:</span>
<span class="sd">        [x_dist,y_dist]: Vector difference between Stokes I and Lin-Pol peak (in mas)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#returns distance between stokes I and lin pol peak</span>

    <span class="c1">#find maximum indices for stokes I and lin_pol</span>
    <span class="n">y_i</span><span class="p">,</span> <span class="n">x_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">y_pol</span><span class="p">,</span> <span class="n">x_pol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">x_dist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">x_pol</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">x_i</span><span class="p">]</span>
    <span class="n">y_dist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">y_pol</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">y_i</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">x_dist</span><span class="p">,</span> <span class="n">y_dist</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.get_pixel_value" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_pixel_value</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="s1">&#39;stokes_i&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get value of a specific pixel from an image</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>x</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>X position in mas</p>
              </div>
            </li>
            <li>
              <b><code>y</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Y position in mas</p>
              </div>
            </li>
            <li>
              <b><code>image</code></b>
                  (<code>str</code>, default:
                      <code>&#39;stokes_i&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Select Image to get value from ('stokes_i','stokes_q',"stokes_u","lin_pol","evpa")</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:</p>

            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_pixel_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">image</span><span class="o">=</span><span class="s2">&quot;stokes_i&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get value of a specific pixel from an image</span>

<span class="sd">    Args:</span>
<span class="sd">        x (float): X position in mas</span>
<span class="sd">        y (float): Y position in mas</span>
<span class="sd">        image (str): Select Image to get value from (&#39;stokes_i&#39;,&#39;stokes_q&#39;,&quot;stokes_u&quot;,&quot;lin_pol&quot;,&quot;evpa&quot;)</span>

<span class="sd">    Returns:</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Xind</span><span class="o">=</span><span class="n">closest_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
    <span class="n">Yind</span><span class="o">=</span><span class="n">closest_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;stokes_i&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">[</span><span class="n">Yind</span><span class="p">,</span><span class="n">Xind</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;stokes_q&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="p">[</span><span class="n">Yind</span><span class="p">,</span><span class="n">Xind</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;stokes_q&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="p">[</span><span class="n">Yind</span><span class="p">,</span><span class="n">Xind</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;stokes_u&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="p">[</span><span class="n">Yind</span><span class="p">,</span><span class="n">Xind</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;lin_pol&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="p">[</span><span class="n">Yind</span><span class="p">,</span><span class="n">Xind</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;evpa&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">evpa</span><span class="p">[</span><span class="n">Yind</span><span class="p">,</span><span class="n">Xind</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.get_profile" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_profile</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="s1">&#39;stokes_i&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to obtain a line profile of the image.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>point1</code></b>
                  (<code>list[float]</code>)
              –
              <div class="doc-md-description">
                <p>Starting Point of the profile [x1,y1] (in mas)</p>
              </div>
            </li>
            <li>
              <b><code>point2</code></b>
                  (<code>list[float]</code>)
              –
              <div class="doc-md-description">
                <p>End Point of the profile [x2,y2] (in mas)</p>
              </div>
            </li>
            <li>
              <b><code>show</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to display a plot of the profile</p>
              </div>
            </li>
            <li>
              <b><code>image</code></b>
                  (<code>bool</code>, default:
                      <code>&#39;stokes_i&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Choose map to use ('stokes_i','lin_pol','evpa','spix','rm')</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>x_values, intensity_profile: Array of the Distance from point1 to point2 and the profile</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">point1</span><span class="p">,</span><span class="n">point2</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">image</span><span class="o">=</span><span class="s2">&quot;stokes_i&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to obtain a line profile of the image.</span>

<span class="sd">    Args:</span>
<span class="sd">        point1 (list[float]): Starting Point of the profile [x1,y1] (in mas)</span>
<span class="sd">        point2 (list[float]): End Point of the profile [x2,y2] (in mas)</span>
<span class="sd">        show (bool): Choose whether to display a plot of the profile</span>
<span class="sd">        image (bool): Choose map to use (&#39;stokes_i&#39;,&#39;lin_pol&#39;,&#39;evpa&#39;,&#39;spix&#39;,&#39;rm&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        x_values, intensity_profile: Array of the Distance from point1 to point2 and the profile</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#get index of slice ends</span>
    <span class="n">x_ind1</span> <span class="o">=</span> <span class="n">closest_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span><span class="n">point1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y_ind1</span> <span class="o">=</span> <span class="n">closest_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span><span class="n">point1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">x_ind2</span> <span class="o">=</span> <span class="n">closest_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">point2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y_ind2</span> <span class="o">=</span> <span class="n">closest_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">point2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1">#select image to get slice from</span>
    <span class="k">if</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;stokes_i&quot;</span><span class="p">:</span>
        <span class="n">image_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span>
    <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;lin_pol&quot;</span><span class="p">:</span>
        <span class="n">image_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span>
    <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;evpa&quot;</span><span class="p">:</span>
        <span class="n">image_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evpa</span>
    <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;spix&quot;</span><span class="p">:</span>
        <span class="n">image_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spix</span>
    <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;rm&quot;</span><span class="p">:</span>
        <span class="n">image_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rm</span>
    <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;frac_pol&quot;</span><span class="p">:</span>
        <span class="n">image_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lin_pol</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span>
    <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;stokes_q&quot;</span><span class="p">:</span>
        <span class="n">image_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span>
    <span class="k">elif</span> <span class="n">image</span><span class="o">==</span><span class="s2">&quot;stokes_u&quot;</span><span class="p">:</span>
        <span class="n">image_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Please specify valid &#39;image&#39; parameter, image=&#39;</span><span class="si">{</span><span class="n">image</span><span class="si">}</span><span class="s2">&#39; not supported.&quot;</span><span class="p">)</span>

    <span class="n">intensity_profile</span><span class="o">=</span><span class="n">profile_line</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="p">(</span><span class="n">y_ind1</span><span class="p">,</span><span class="n">x_ind1</span><span class="p">),</span> <span class="p">(</span><span class="n">y_ind2</span><span class="p">,</span><span class="n">x_ind2</span><span class="p">))</span>

    <span class="c1">#calculate distance between points</span>
    <span class="n">dist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">point2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">point1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">point2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">point1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1">#get x_values of intensity_profile</span>
    <span class="n">x_values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">intensity_profile</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span><span class="n">intensity_profile</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distance from Point 1 [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Flux Density [Jy/beam]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">x_values</span><span class="p">,</span> <span class="n">intensity_profile</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.get_ridgeline" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_ridgeline</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;slices&#39;</span><span class="p">,</span> <span class="n">angle_for_slices</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">auto_rotate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">jet_angle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">cut_radial</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">cut_final</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">counterjet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">j_len</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">start_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">chi_sq_val</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span> <span class="n">err_FWHM</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to calculate the Ridgeline (and Counter-Ridgeline) of an image.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>method</code></b>
                  (<code>str</code>, default:
                      <code>&#39;slices&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Select method to use ('slices', 'polar')</p>
              </div>
            </li>
            <li>
              <b><code>angle_for_slices</code></b>
                  (<code>float</code>, default:
                      <code>0</code>
)
              –
              <div class="doc-md-description">
                <p>Choose angle for the slices method</p>
              </div>
            </li>
            <li>
              <b><code>auto_rotate</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>For the 'slices' method, choose whether to automatically detect the jet direction</p>
              </div>
            </li>
            <li>
              <b><code>jet_angle</code></b>
                  (<code>float</code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>If auto_rotate=False, provide the jet_angle in degrees for the 'slices' method</p>
              </div>
            </li>
            <li>
              <b><code>cut_radial</code></b>
                  (<code>float</code>, default:
                      <code>5.0</code>
)
              –
              <div class="doc-md-description">
                <p>radial SNR Cut for the 'slices' method</p>
              </div>
            </li>
            <li>
              <b><code>cut_final</code></b>
                  (<code>float</code>, default:
                      <code>10.0</code>
)
              –
              <div class="doc-md-description">
                <p>final SNR cut for the 'slices' method</p>
              </div>
            </li>
            <li>
              <b><code>counterjet</code></b>
                  (<code>bool</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to also fit a counterjet</p>
              </div>
            </li>
            <li>
              <b><code>width</code></b>
                  (<code>int</code>, default:
                      <code>40</code>
)
              –
              <div class="doc-md-description">
                <p>Jet width in to consider for 'slices' method (in pixel)</p>
              </div>
            </li>
            <li>
              <b><code>j_len</code></b>
                  (<code>int</code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Jet length to consider for 'slices' method (in pixel)</p>
              </div>
            </li>
            <li>
              <b><code>start_radius</code></b>
                  (<code>float</code>, default:
                      <code>0</code>
)
              –
              <div class="doc-md-description">
                <p>Start radius for polar method (in mas)</p>
              </div>
            </li>
            <li>
              <b><code>chi_sq_val</code></b>
                  (<code>float</code>, default:
                      <code>100.0</code>
)
              –
              <div class="doc-md-description">
                <p>Chi-squared cut for fits.</p>
              </div>
            </li>
            <li>
              <b><code>err_FWHM</code></b>
                  (<code>float</code>, default:
                      <code>0.1</code>
)
              –
              <div class="doc-md-description">
                <p>Relative error of the FWHM to consider for fits</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>ridgelines</code></b>(                  <code>list</code>
)              –
              <div class="doc-md-description">
                <p>Ridgeline and Counter-Ridgeline objects</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_ridgeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;slices&quot;</span><span class="p">,</span><span class="n">angle_for_slices</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">auto_rotate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">jet_angle</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                  <span class="n">cut_radial</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">cut_final</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span><span class="n">counterjet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">j_len</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">start_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">end_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">chi_sq_val</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span><span class="n">err_FWHM</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate the Ridgeline (and Counter-Ridgeline) of an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        method (str): Select method to use (&#39;slices&#39;, &#39;polar&#39;)</span>
<span class="sd">        angle_for_slices (float): Choose angle for the slices method</span>
<span class="sd">        auto_rotate (bool): For the &#39;slices&#39; method, choose whether to automatically detect the jet direction</span>
<span class="sd">        jet_angle (float): If auto_rotate=False, provide the jet_angle in degrees for the &#39;slices&#39; method</span>
<span class="sd">        cut_radial (float): radial SNR Cut for the &#39;slices&#39; method</span>
<span class="sd">        cut_final (float): final SNR cut for the &#39;slices&#39; method</span>
<span class="sd">        counterjet (bool): Choose whether to also fit a counterjet</span>
<span class="sd">        width (int): Jet width in to consider for &#39;slices&#39; method (in pixel)</span>
<span class="sd">        j_len (int): Jet length to consider for &#39;slices&#39; method (in pixel)</span>
<span class="sd">        start_radius (float): Start radius for polar method (in mas)</span>
<span class="sd">        chi_sq_val (float): Chi-squared cut for fits.</span>
<span class="sd">        err_FWHM (float): Relative error of the FWHM to consider for fits</span>

<span class="sd">    Returns:</span>
<span class="sd">        ridgelines (list): Ridgeline and Counter-Ridgeline objects</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;slices&quot;</span><span class="p">:</span>
        <span class="c1">#this is Lucas method with an additional option to auto_rotate.</span>
        <span class="n">image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">auto_rotate</span><span class="p">:</span>
            <span class="c1">#convert image to polar coordinates</span>
            <span class="n">R</span><span class="p">,</span> <span class="n">Theta</span><span class="p">,</span> <span class="n">Z_polar</span> <span class="o">=</span> <span class="n">convert_image_to_polar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>
            <span class="c1">#Integrate over the radius to find jet direction:</span>
            <span class="n">integrated_jet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Theta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="n">integrated_jet</span><span class="o">+=</span><span class="n">Z_polar</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">R</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="c1">#correct for rdTheta in integration</span>
            <span class="c1">#plt.plot(Theta[:,0],integrated_jet)</span>
            <span class="c1">#plt.show()</span>
            <span class="c1">#find maximum flux</span>
            <span class="n">max_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">integrated_jet</span><span class="p">)</span>
            <span class="n">jet_direction</span><span class="o">=</span><span class="n">Theta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="n">max_ind</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Automatically determined jet direction </span><span class="si">{</span><span class="n">jet_direction</span><span class="si">}</span><span class="s2">°.&quot;</span><span class="p">)</span>
            <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="o">-</span><span class="n">jet_direction</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">jet_angle</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="o">-</span><span class="n">jet_angle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Will assume the jet was already rotated to position angle 0°.&quot;</span><span class="p">)</span>

        <span class="c1"># TODO need to CONVERT IT TO Jy/px????</span>
        <span class="n">image_data</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">Z</span>

        <span class="c1">#if not j_len given, will use full image - 10 pixels at the edge</span>
        <span class="k">if</span> <span class="n">j_len</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">j_len</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1">#get ridgeline</span>
        <span class="n">ridgeline</span><span class="o">=</span><span class="n">Ridgeline</span><span class="p">()</span><span class="o">.</span><span class="n">get_ridgeline_luca</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">],</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span><span class="n">angle_for_slices</span><span class="o">=</span><span class="n">angle_for_slices</span><span class="p">,</span><span class="n">cut_radial</span><span class="o">=</span><span class="n">cut_radial</span><span class="p">,</span>
                                                 <span class="n">cut_final</span><span class="o">=</span><span class="n">cut_final</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span><span class="n">j_len</span><span class="o">=</span><span class="n">j_len</span><span class="p">,</span><span class="n">chi_sq_val</span><span class="o">=</span><span class="n">chi_sq_val</span><span class="p">,</span><span class="n">err_FWHM</span><span class="o">=</span><span class="n">err_FWHM</span><span class="p">)</span>
        <span class="n">image</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">=</span><span class="n">ridgeline</span>

        <span class="k">if</span> <span class="n">counterjet</span><span class="p">:</span>
            <span class="n">counter_ridgeline</span><span class="o">=</span><span class="n">Ridgeline</span><span class="p">()</span><span class="o">.</span><span class="n">get_ridgeline_luca</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">],</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span><span class="n">counterjet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">angle_for_slices</span><span class="o">=</span><span class="n">angle_for_slices</span><span class="p">,</span><span class="n">cut_radial</span><span class="o">=</span><span class="n">cut_radial</span><span class="p">,</span>
                                                 <span class="n">cut_final</span><span class="o">=</span><span class="n">cut_final</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span><span class="n">j_len</span><span class="o">=</span><span class="n">j_len</span><span class="p">,</span><span class="n">chi_sq_val</span><span class="o">=</span><span class="n">chi_sq_val</span><span class="p">,</span><span class="n">err_FWHM</span><span class="o">=</span><span class="n">err_FWHM</span><span class="p">)</span>

            <span class="n">image</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="o">=</span><span class="n">counter_ridgeline</span>

        <span class="k">if</span> <span class="n">auto_rotate</span><span class="p">:</span>
            <span class="c1"># rotate image back</span>
            <span class="n">image</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">jet_direction</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">jet_angle</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">jet_angle</span><span class="p">)</span>
        <span class="c1"># set new ridgeline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">ridgeline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">counter_ridgeline</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span>

    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;polar&quot;</span><span class="p">:</span>
        <span class="c1">#convert image to polar coordinates</span>
        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">auto_rotate</span><span class="p">:</span>
            <span class="c1"># convert image to polar coordinates</span>
            <span class="n">R</span><span class="p">,</span> <span class="n">Theta</span><span class="p">,</span> <span class="n">Z_polar</span> <span class="o">=</span> <span class="n">convert_image_to_polar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>
            <span class="c1"># Integrate over the radius to find jet direction:</span>
            <span class="n">integrated_jet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Theta</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="n">integrated_jet</span> <span class="o">+=</span> <span class="n">Z_polar</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">R</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>  <span class="c1"># correct for rdTheta in integration</span>
            <span class="c1"># plt.plot(Theta[:,0],integrated_jet)</span>
            <span class="c1"># plt.show()</span>
            <span class="c1"># find maximum flux</span>
            <span class="n">max_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">integrated_jet</span><span class="p">)</span>
            <span class="n">jet_direction</span> <span class="o">=</span> <span class="n">Theta</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">][</span><span class="n">max_ind</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Automatically determined jet direction </span><span class="si">{</span><span class="n">jet_direction</span><span class="si">}</span><span class="s2">°.&quot;</span><span class="p">)</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="o">-</span><span class="n">jet_direction</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">jet_angle</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="o">-</span><span class="n">jet_angle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Will assume the jet was already rotated to position angle 0°.&quot;</span><span class="p">)</span>

        <span class="n">R</span><span class="p">,</span> <span class="n">Theta</span><span class="p">,</span> <span class="n">Z_polar</span> <span class="o">=</span> <span class="n">convert_image_to_polar</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>

        <span class="n">ridgeline</span><span class="o">=</span><span class="n">Ridgeline</span><span class="p">()</span><span class="o">.</span><span class="n">get_ridgeline_polar</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">Theta</span><span class="p">,</span><span class="n">Z_polar</span><span class="p">,</span><span class="bp">self</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
                                                  <span class="n">start_radius</span><span class="o">=</span><span class="n">start_radius</span><span class="p">,</span><span class="n">end_radius</span><span class="o">=</span><span class="n">end_radius</span><span class="p">)</span>

        <span class="n">image</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">=</span><span class="n">ridgeline</span>

        <span class="k">if</span> <span class="n">auto_rotate</span><span class="p">:</span>
            <span class="c1"># rotate image back</span>
            <span class="n">image</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">jet_direction</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">jet_angle</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">jet_angle</span><span class="p">)</span>
        <span class="c1"># set new ridgeline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">ridgeline</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span>

    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;polar_gauss&quot;</span><span class="p">:</span>
        <span class="c1">#convert image to polar coordinates</span>
        <span class="n">R</span><span class="p">,</span> <span class="n">Theta</span><span class="p">,</span> <span class="n">Z_polar</span> <span class="o">=</span> <span class="n">convert_image_to_polar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>

        <span class="n">ridgeline</span><span class="o">=</span><span class="n">Ridgeline</span><span class="p">()</span><span class="o">.</span><span class="n">get_ridgeline_polar</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">Theta</span><span class="p">,</span><span class="n">Z_polar</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
                                                  <span class="n">start_radius</span><span class="o">=</span><span class="n">start_radius</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">=</span><span class="n">ridgeline</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please select valid ridgeline method (&#39;polar&#39;, &#39;slices&#39;).&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.jet_to_counterjet_profile" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">jet_to_counterjet_profile</span><span class="p">(</span><span class="n">savefig</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to plot the jet-to-counterjet ratio</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>savefig</code></b>
                  (<code>str</code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>File path to store the plot</p>
              </div>
            </li>
            <li>
              <b><code>show</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to display the plot</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">jet_to_counterjet_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">savefig</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to plot the jet-to-counterjet ratio</span>

<span class="sd">    Args:</span>
<span class="sd">        savefig (str): File path to store the plot</span>
<span class="sd">        show (bool): Choose whether to display the plot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">.</span><span class="n">jet_to_counterjet_profile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="p">,</span><span class="n">savefig</span><span class="o">=</span><span class="n">savefig</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.masking" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">masking</span><span class="p">(</span><span class="n">mask_type</span><span class="o">=</span><span class="s1">&#39;ellipse&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">invert_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to mask ImageData object.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>mask_type</code></b>
              –
              <div class="doc-md-description">
                <p>'npix_x','cut_left','cut_right','radius','ellipse','flux_cut'</p>
              </div>
            </li>
            <li>
              <b><code>args</code></b>
              –
              <div class="doc-md-description">
                <p>the arguments for the mask
'npix_x': args=[npix_x,npixy]
'cut_left': args = cut_left
'cut_right': args = cut_right
'radius': args = radius
'ellipse': args = {'e_args': [e_maj,e_min,e_pa], 'e_xoffset': xoff, 'e_yoffset': yoff} all in the image intrinsic unit
'flux_cut: args = flux cut
    Flags everything above flux_cut times peak brightness</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">masking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_type</span><span class="o">=</span><span class="s1">&#39;ellipse&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">invert_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to mask ImageData object.</span>

<span class="sd">    Args:</span>
<span class="sd">        mask_type: &#39;npix_x&#39;,&#39;cut_left&#39;,&#39;cut_right&#39;,&#39;radius&#39;,&#39;ellipse&#39;,&#39;flux_cut&#39;</span>
<span class="sd">        args: the arguments for the mask</span>
<span class="sd">            &#39;npix_x&#39;: args=[npix_x,npixy]</span>
<span class="sd">            &#39;cut_left&#39;: args = cut_left</span>
<span class="sd">            &#39;cut_right&#39;: args = cut_right</span>
<span class="sd">            &#39;radius&#39;: args = radius</span>
<span class="sd">            &#39;ellipse&#39;: args = {&#39;e_args&#39;: [e_maj,e_min,e_pa], &#39;e_xoffset&#39;: xoff, &#39;e_yoffset&#39;: yoff} all in the image intrinsic unit</span>
<span class="sd">            &#39;flux_cut: args = flux cut</span>
<span class="sd">                Flags everything above flux_cut times peak brightness</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># cut out inner, optically thick part of the image</span>
    <span class="k">if</span> <span class="n">mask_type</span> <span class="o">==</span> <span class="s1">&#39;npix_x&#39;</span><span class="p">:</span>
        <span class="n">npix_x</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">npix_y</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">px_min_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">npix_x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">px_max_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">npix_x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">px_min_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">npix_y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">px_max_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">npix_y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">px_range_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">px_min_x</span><span class="p">,</span> <span class="n">px_max_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">px_range_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">px_min_y</span><span class="p">,</span> <span class="n">px_max_y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">px_range_y</span><span class="p">,</span> <span class="n">px_range_x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">mask_type</span> <span class="o">==</span> <span class="s1">&#39;cut_left&#39;</span><span class="p">:</span>
        <span class="n">cut_left</span> <span class="o">=</span> <span class="n">args</span>
        <span class="n">px_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">+</span> <span class="n">cut_left</span><span class="p">)</span>
        <span class="n">px_range_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">px_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[:,</span> <span class="n">px_range_x</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">mask_type</span> <span class="o">==</span> <span class="s1">&#39;cut_right&#39;</span><span class="p">:</span>
        <span class="n">cut_right</span> <span class="o">=</span> <span class="n">args</span>
        <span class="n">px_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">cut_right</span><span class="p">)</span>
        <span class="n">px_range_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">px_max</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[:,</span> <span class="n">px_range_x</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">mask_type</span> <span class="o">==</span> <span class="s1">&#39;radius&#39;</span><span class="p">:</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">args</span>
        <span class="n">rr</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">disk</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">radius</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">rr</span><span class="p">,</span> <span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">mask_type</span> <span class="o">==</span> <span class="s1">&#39;ellipse&#39;</span><span class="p">:</span>
        <span class="n">e_maj</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;e_args&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">e_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;e_args&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">e_pa</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;e_args&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">e_xoffset</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;e_xoffset&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">)</span>
        <span class="n">e_yoffset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;e_yoffset&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">e_xoffset</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">e_yoffset</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">e_xoffset</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">e_yoffset</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">e_pa</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">e_pa</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e_pa</span> <span class="o">=</span> <span class="n">e_pa</span>
        <span class="n">rr</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">ellipse</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">e_maj</span><span class="p">,</span> <span class="n">e_min</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=-</span><span class="n">e_pa</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">rr</span><span class="p">,</span> <span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">mask_type</span> <span class="o">==</span> <span class="s1">&#39;flux_cut&#39;</span><span class="p">:</span>
        <span class="n">flux_cut</span> <span class="o">=</span> <span class="n">args</span>
        <span class="c1"># mask everything above flux_cut times the peak brightness</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">&gt;</span><span class="n">flux_cut</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">mask_type</span> <span class="o">==</span> <span class="s1">&#39;reset&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">invert_mask</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.plot_uv" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_uv</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to plot the uv-coverage, if a .uvf-file is provided.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>fig</code></b>
                  (<code>Matplotlib Figure</code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Optional input of matplotlib fig</p>
              </div>
            </li>
            <li>
              <b><code>ax</code></b>
                  (<code>Matplotlib Ax</code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Optional input of matplotlib ax</p>
              </div>
            </li>
            <li>
              <b><code>savefig</code></b>
                  (<code>string</code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Path to export the plot</p>
              </div>
            </li>
            <li>
              <b><code>show</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to show the plot or not</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>fig, ax</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">plot_uv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">savefig</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to plot the uv-coverage, if a .uvf-file is provided.</span>

<span class="sd">    Args:</span>
<span class="sd">        fig (Matplotlib Figure): Optional input of matplotlib fig</span>
<span class="sd">        ax (Matplotlib Ax): Optional input of matplotlib ax</span>
<span class="sd">        savefig (string): Path to export the plot</span>
<span class="sd">        show (bool): Choose whether to show the plot or not</span>

<span class="sd">    Returns:</span>
<span class="sd">        fig, ax</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">fig</span><span class="o">==</span><span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="n">ax</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">)</span>
        <span class="n">u_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">v_array</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">u_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">v_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;FREQ&quot;</span> <span class="ow">in</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CTYPE&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]:</span>
                    <span class="n">freq_ghz</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRVAL&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span> <span class="o">/</span> <span class="mf">1e9</span>  <span class="c1"># Frequency in GHz</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="c1"># plot it</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">freq_ghz</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">u_array</span><span class="p">),</span> <span class="n">freq_ghz</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v_array</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="n">freq_ghz</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">u_array</span><span class="p">),</span> <span class="o">-</span><span class="n">freq_ghz</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v_array</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;U (10⁶ $\lambda$)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;V (10⁶ $\lambda$)&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">savefig</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.regrid" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">regrid</span><span class="p">(</span><span class="n">npix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">useDIFMAP</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mask_outside</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>This method regrids the image in full polarization</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>npix</code></b>
                  (<code>int</code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Number of pixels in ONE direction</p>
              </div>
            </li>
            <li>
              <b><code>pixel_size</code></b>
                  (<code>float</code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Size of pixel in image scale units (usually mas)</p>
              </div>
            </li>
            <li>
              <b><code>useDIFMAP</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to regrid using DIFMAP or not</p>
              </div>
            </li>
            <li>
              <b><code>mask_outside</code></b>
                  (<code>bool</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether new image ares created through regridding will be masked automatically (bool)</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>regridded ImageData object</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">regrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">npix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">pixel_size</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">useDIFMAP</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mask_outside</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method regrids the image in full polarization</span>

<span class="sd">    Args:</span>
<span class="sd">        npix (int): Number of pixels in ONE direction</span>
<span class="sd">        pixel_size (float): Size of pixel in image scale units (usually mas)</span>
<span class="sd">        useDIFMAP (bool): Choose whether to regrid using DIFMAP or not</span>
<span class="sd">        mask_outside (bool): Choose whether new image ares created through regridding will be masked automatically (bool)</span>

<span class="sd">    Returns:</span>
<span class="sd">        regridded ImageData object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Regridding Image&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">==</span><span class="n">npix</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span><span class="o">==</span><span class="n">npix</span> <span class="ow">and</span> <span class="n">pixel_size</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="n">n2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>

    <span class="c1"># Original grid (centered)</span>
    <span class="n">x_old</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">n2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
    <span class="n">y_old</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">n1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

    <span class="c1"># New grid (centered)</span>
    <span class="n">x_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">npix</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">pixel_size</span>
    <span class="n">y_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">npix</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">pixel_size</span>

    <span class="c1"># Generate new grid coordinates</span>
    <span class="n">X_new</span><span class="p">,</span> <span class="n">Y_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_new</span><span class="p">,</span> <span class="n">y_new</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Y_new</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">X_new</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># define interpolator</span>
    <span class="k">def</span> <span class="nf">interpolator</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">interpolator</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">((</span><span class="n">y_old</span><span class="p">,</span> <span class="n">x_old</span><span class="p">),</span> <span class="n">image</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                               <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">interpolator</span>

    <span class="c1"># regrid mask</span>
    <span class="k">if</span> <span class="n">mask_outside</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">fill_value</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span>


    <span class="n">new_mask</span> <span class="o">=</span> <span class="n">interpolator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">fill_value</span><span class="p">)(</span><span class="n">points</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>  <span class="c1"># flags new points automatically</span>
    <span class="n">new_mask</span><span class="p">[</span><span class="n">new_mask</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">new_mask</span><span class="p">[</span><span class="n">new_mask</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="o">==</span><span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="n">useDIFMAP</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
        <span class="c1"># Interpolate values at new grid points</span>
        <span class="n">new_image_i</span> <span class="o">=</span> <span class="n">interpolator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)(</span><span class="n">points</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>

        <span class="c1">#try polarization</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_image_q</span> <span class="o">=</span> <span class="n">interpolator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="p">)(</span><span class="n">points</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>
            <span class="n">new_image_u</span> <span class="o">=</span> <span class="n">interpolator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="p">)(</span><span class="n">points</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to regrid polarization, probably no polarization loaded&quot;</span><span class="p">)</span>


        <span class="c1"># write outputs to the fits files</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">only_stokes_i</span><span class="p">:</span>
            <span class="c1"># this means DIFMAP style fits image</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1">#overwrite image data</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">))</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_i</span>
                <span class="n">new_stokes_i_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_clean/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span> <span class="c1">#This is a bug fix that is needed for some .fits files, otherwise writeto throws an error</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1">#modify header parameters to new npix and pixelsize</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">npix</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">npix</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">]</span><span class="o">=-</span><span class="n">pixel_size</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT2&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">pixel_size</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="n">npix</span><span class="p">)</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="n">npix</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_i_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="c1"># overwrite image data</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">))</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_q</span>
                    <span class="n">new_stokes_q_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_q/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>  <span class="c1"># This is a bug fix that is needed for some .fits files, otherwise writeto throws an error</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1"># modify header parameters to new npix and pixelsize</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npix</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npix</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">pixel_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">npix</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">npix</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_q_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_stokes_q_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>


            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="c1"># overwrite image data</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">))</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_u</span>
                    <span class="n">new_stokes_u_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_u/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>  <span class="c1"># This is a bug fix that is needed for some .fits files, otherwise writeto throws an error</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1"># modify header parameters to new npix and</span>
                    <span class="c1"># pixelsize</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npix</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npix</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">pixel_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">npix</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">npix</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_u_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_stokes_u_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># CASA style</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">)</span>
            <span class="c1"># overwrite image data</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">))</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_i</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_q</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_u</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npix</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npix</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">pixel_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">npix</span><span class="p">)</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">npix</span><span class="p">)</span>
            <span class="n">new_stokes_i_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_clean/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_i_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
            <span class="n">new_stokes_q_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
            <span class="n">new_stokes_u_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

        <span class="c1">#if model loaded try regridding as well</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">new_image_model</span> <span class="o">=</span> <span class="n">interpolator</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])(</span><span class="n">points</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span><span class="n">npix</span><span class="p">)</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">))</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_model</span>
                        <span class="n">new_model_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_model/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>  <span class="c1"># This is a bug fix that is needed for some .fits files, otherwise writeto throws an error</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npix</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npix</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">pixel_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="n">npix</span><span class="p">)</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="n">npix</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_model_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_model_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_model_fits</span><span class="o">=</span><span class="n">new_stokes_i_fits</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Model not regridded, probably no model loaded.&quot;</span><span class="p">)</span>
            <span class="n">new_model_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">npix</span><span class="o">=</span><span class="n">npix</span><span class="o">*</span><span class="mi">2</span> <span class="c1">#DIFMAP npix convention</span>
        <span class="c1">#Using DIFMAP</span>
        <span class="c1"># restore Stokes I</span>
        <span class="n">new_stokes_i_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.mod&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">fold_with_beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">],</span> <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                       <span class="n">bmaj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                       <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_clean&quot;</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="n">new_stokes_i_fits</span><span class="p">,</span>
                       <span class="n">n_pixel</span><span class="o">=</span><span class="n">npix</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="n">pixel_size</span><span class="p">,</span>
                       <span class="n">mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">],</span><span class="n">clean_mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">],</span> <span class="n">uvf_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">],</span>
                       <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span><span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

        <span class="n">new_stokes_i_fits</span> <span class="o">+=</span> <span class="s2">&quot;.fits&quot;</span>

        <span class="c1"># try to restore modelfit if it is there</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">:</span>
                <span class="n">new_model_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.mod&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="n">fold_with_beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">],</span> <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                               <span class="n">bmaj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_model&quot;</span><span class="p">,</span>
                               <span class="n">outname</span><span class="o">=</span><span class="n">new_model_fits</span><span class="p">,</span>
                               <span class="n">n_pixel</span><span class="o">=</span><span class="n">npix</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="n">pixel_size</span><span class="p">,</span>
                               <span class="n">mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="p">],</span><span class="n">clean_mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">],</span> <span class="n">uvf_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">],</span>
                               <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span><span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

                <span class="n">new_model_fits</span> <span class="o">+=</span> <span class="s2">&quot;.fits&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_model_fits</span> <span class="o">=</span> <span class="n">new_stokes_i_fits</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">new_model_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># try to restore polarization as well if it is there</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_stokes_q_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.mod&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">new_stokes_u_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.mod&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="n">fold_with_beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">],</span> <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                           <span class="n">bmaj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_q&quot;</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="n">new_stokes_q_fits</span><span class="p">,</span>
                           <span class="n">n_pixel</span><span class="o">=</span><span class="n">npix</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="n">pixel_size</span><span class="p">,</span>
                           <span class="n">mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="p">],</span><span class="n">clean_mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">],</span> <span class="n">uvf_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">],</span>
                           <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span><span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

            <span class="n">new_stokes_q_fits</span> <span class="o">+=</span> <span class="s2">&quot;.fits&quot;</span>

            <span class="n">fold_with_beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">],</span> <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                           <span class="n">bmaj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_u&quot;</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="n">new_stokes_u_fits</span><span class="p">,</span>
                           <span class="n">n_pixel</span><span class="o">=</span><span class="n">npix</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="n">pixel_size</span><span class="p">,</span>
                           <span class="n">mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="p">],</span> <span class="n">clean_mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">],</span><span class="n">uvf_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">],</span>
                           <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span><span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

            <span class="n">new_stokes_u_fits</span> <span class="o">+=</span> <span class="s2">&quot;.fits&quot;</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">new_stokes_q_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">new_stokes_u_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_inp</span><span class="p">:</span>
        <span class="n">new_model_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">return</span> <span class="n">ImageData</span><span class="p">(</span><span class="n">fits_file</span><span class="o">=</span><span class="n">new_stokes_i_fits</span><span class="p">,</span>
                     <span class="n">uvf_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">,</span>
                     <span class="n">stokes_q</span><span class="o">=</span><span class="n">new_stokes_q_fits</span><span class="p">,</span>
                     <span class="n">stokes_u</span><span class="o">=</span><span class="n">new_stokes_u_fits</span><span class="p">,</span>
                     <span class="n">mask</span><span class="o">=</span><span class="n">new_mask</span><span class="p">,</span>
                     <span class="n">ridgeline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="p">,</span>
                     <span class="n">redshift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">,</span>
                     <span class="n">counter_ridgeline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="p">,</span>
                     <span class="n">noise_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_method</span><span class="p">,</span>
                     <span class="n">model_save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="p">,</span>
                     <span class="n">model</span><span class="o">=</span><span class="n">new_model_fits</span><span class="p">,</span>
                     <span class="n">correct_rician_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">correct_rician_bias</span><span class="p">,</span>
                     <span class="n">comp_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">core_comp_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span>
                     <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                     <span class="n">fit_comp_polarization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol</span><span class="p">,</span>
                     <span class="n">fit_comp_pol_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol_errors</span><span class="p">,</span>
                     <span class="n">uvw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span>
                     <span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.remove_component" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">remove_component</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to remove a selected component from the Stokes I image</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>id</code></b>
                  (<code>int</code>)
              –
              <div class="doc-md-description">
                <p>Component id to remove</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">remove_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to remove a selected component from the Stokes I image</span>

<span class="sd">    Args:</span>
<span class="sd">        id (int): Component id to remove</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
        <span class="nb">id</span><span class="o">=</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please enter valid component id (int or list[int])!&quot;</span><span class="p">)</span>

    <span class="n">comps_to_remove</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">id</span><span class="p">:</span>
        <span class="n">comps_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

    <span class="c1">#TODO rewrite to work without ehtim</span>
    <span class="kn">import</span> <span class="nn">ehtim</span> <span class="k">as</span> <span class="nn">eh</span>
    <span class="n">mod</span><span class="o">=</span><span class="n">eh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps_to_remove</span><span class="p">:</span>
        <span class="n">mod</span><span class="o">=</span><span class="n">mod</span><span class="o">.</span><span class="n">add_gauss</span><span class="p">(</span><span class="n">F0</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span>
                          <span class="n">FWHM_maj</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">maj</span><span class="o">*</span><span class="n">comp</span><span class="o">.</span><span class="n">scale</span><span class="o">*</span><span class="n">eh</span><span class="o">.</span><span class="n">RADPERUAS</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span>
                          <span class="n">FWHM_min</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">min</span><span class="o">*</span><span class="n">comp</span><span class="o">.</span><span class="n">scale</span><span class="o">*</span><span class="n">eh</span><span class="o">.</span><span class="n">RADPERUAS</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span>
                          <span class="n">PA</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">pos</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                          <span class="n">x0</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">x</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                          <span class="n">y0</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">y</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

    <span class="n">im</span><span class="o">=</span><span class="n">mod</span><span class="o">.</span><span class="n">make_image</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">))</span><span class="o">*</span><span class="mf">1e3</span><span class="o">*</span><span class="n">eh</span><span class="o">.</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">))</span>
    <span class="n">im</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">blur_gauss</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">])</span>

    <span class="n">image</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span>
    <span class="n">image</span><span class="o">=</span><span class="n">Jy2JyPerBeam</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
    <span class="n">image</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1">#subtract core from stokes I image</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span><span class="o">-</span><span class="n">image</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.restore" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">restore</span><span class="p">(</span><span class="n">bmaj</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">posa</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">npix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">useDIFMAP</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mask_outside</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>This allows you to restore the ImageData object with a custom beam either with DIFMAP or just the image itself</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>bmaj</code></b>
                  (<code>float</code>, default:
                      <code>-1</code>
)
              –
              <div class="doc-md-description">
                <p>Beam major axis (in mas)</p>
              </div>
            </li>
            <li>
              <b><code>bmin</code></b>
                  (<code>float</code>, default:
                      <code>-1</code>
)
              –
              <div class="doc-md-description">
                <p>Beam minor axis (in mas)</p>
              </div>
            </li>
            <li>
              <b><code>posa</code></b>
                  (<code>float</code>, default:
                      <code>-1</code>
)
              –
              <div class="doc-md-description">
                <p>Beam position angle (in deg)</p>
              </div>
            </li>
            <li>
              <b><code>shift_x</code></b>
                  (<code>float</code>, default:
                      <code>0</code>
)
              –
              <div class="doc-md-description">
                <p>Shift in mas in x-direction</p>
              </div>
            </li>
            <li>
              <b><code>shift_y</code></b>
                  (<code>float</code>, default:
                      <code>0</code>
)
              –
              <div class="doc-md-description">
                <p>Shift in mas in y-direction</p>
              </div>
            </li>
            <li>
              <b><code>npix</code></b>
                  (<code>int</code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Number of pixels in one image direction</p>
              </div>
            </li>
            <li>
              <b><code>pixel_size</code></b>
                  (<code>float</code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>pixel size in mas</p>
              </div>
            </li>
            <li>
              <b><code>useDIFMAP</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to use DIFMAP for the restoring or not</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>image</code></b>(                  <code><a class="autorefs autorefs-internal" title="vcat.image_data.ImageData" href="#vcat.image_data.ImageData">ImageData</a></code>
)              –
              <div class="doc-md-description">
                <p>New ImageData object</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">bmaj</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">bmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">posa</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">shift_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">shift_y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">npix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">pixel_size</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">useDIFMAP</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mask_outside</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This allows you to restore the ImageData object with a custom beam either with DIFMAP or just the image itself</span>

<span class="sd">    Args:</span>
<span class="sd">        bmaj (float): Beam major axis (in mas)</span>
<span class="sd">        bmin (float): Beam minor axis (in mas)</span>
<span class="sd">        posa (float): Beam position angle (in deg)</span>
<span class="sd">        shift_x (float): Shift in mas in x-direction</span>
<span class="sd">        shift_y (float): Shift in mas in y-direction</span>
<span class="sd">        npix (int): Number of pixels in one image direction</span>
<span class="sd">        pixel_size (float): pixel size in mas</span>
<span class="sd">        useDIFMAP (bool): Choose whether to use DIFMAP for the restoring or not</span>

<span class="sd">    Returns:</span>
<span class="sd">        image (ImageData): New ImageData object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">bmaj</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">bmaj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span>
    <span class="k">if</span> <span class="n">bmin</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">bmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span>
    <span class="k">if</span> <span class="n">posa</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">posa</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span>


    <span class="c1">#TODO basic sanity check if uvf file is present and if polarization is there</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="o">==</span><span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="n">useDIFMAP</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
        <span class="c1">#this means there is no valid .uvf file or we don&#39;t want to use DIFMAP</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No .uvf file attached or useDIFMAP=False selected, will do simple shift of image only&quot;</span><span class="p">)</span>

        <span class="c1"># shift in degree</span>
        <span class="n">shift_x_deg</span> <span class="o">=</span> <span class="n">shift_x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
        <span class="n">shift_y_deg</span> <span class="o">=</span> <span class="n">shift_y</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="c1"># calculate shift to pixel increments:</span>
        <span class="n">shift_x</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">shift_x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">)</span>
        <span class="n">shift_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">shift_y</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">)</span>

        <span class="c1">#shift the image mask</span>
        <span class="n">input_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>  <span class="c1"># before it was np.fft.fftn(img)</span>
        <span class="n">offset_image</span> <span class="o">=</span> <span class="n">fourier_shift</span><span class="p">(</span><span class="n">input_</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="p">[</span><span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">])</span>
        <span class="n">imgalign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">offset_image</span><span class="p">)</span>  <span class="c1"># again before ifftn</span>
        <span class="n">new_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">imgalign</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span>

        <span class="c1"># shift image directly</span>
        <span class="n">input_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>  <span class="c1"># before it was np.fft.fftn(img)</span>
        <span class="n">offset_image</span> <span class="o">=</span> <span class="n">fourier_shift</span><span class="p">(</span><span class="n">input_</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="p">[</span><span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">])</span>
        <span class="n">imgalign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">offset_image</span><span class="p">)</span>  <span class="c1"># again before ifftn</span>
        <span class="n">new_image_i</span> <span class="o">=</span> <span class="n">imgalign</span><span class="o">.</span><span class="n">real</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bmaj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bmin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">posa</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1">#convert to jansky per pixel</span>
            <span class="n">new_image_i</span> <span class="o">=</span> <span class="n">JyPerBeam2Jy</span><span class="p">(</span><span class="n">new_image_i</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
            <span class="n">new_image_i</span> <span class="o">=</span> <span class="n">convolve_with_elliptical_gaussian</span><span class="p">(</span><span class="n">new_image_i</span><span class="p">,</span> <span class="n">bmaj</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))),</span>
                                                         <span class="n">bmin</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))),</span> <span class="n">posa</span><span class="p">)</span>
            <span class="c1">#convert to jansky per (new) beam</span>
            <span class="n">new_image_i</span> <span class="o">=</span> <span class="n">Jy2JyPerBeam</span><span class="p">(</span><span class="n">new_image_i</span><span class="p">,</span><span class="n">bmaj</span><span class="p">,</span><span class="n">bmin</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
        <span class="c1"># try polarization</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">input_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="p">)</span>  <span class="c1"># before it was np.fft.fftn(img)</span>
            <span class="n">offset_image</span> <span class="o">=</span> <span class="n">fourier_shift</span><span class="p">(</span><span class="n">input_</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="p">[</span><span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">])</span>
            <span class="n">imgalign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">offset_image</span><span class="p">)</span>  <span class="c1"># again before ifftn</span>
            <span class="n">new_image_q</span> <span class="o">=</span> <span class="n">imgalign</span><span class="o">.</span><span class="n">real</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bmaj</span><span class="o">==-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bmin</span> <span class="o">==-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">posa</span><span class="o">==-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">new_image_q</span> <span class="o">=</span> <span class="n">JyPerBeam2Jy</span><span class="p">(</span><span class="n">new_image_q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                <span class="n">new_image_q</span> <span class="o">=</span> <span class="n">convolve_with_elliptical_gaussian</span><span class="p">(</span><span class="n">new_image_q</span><span class="p">,</span>
                                                                <span class="n">bmaj</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))),</span>
                                                                <span class="n">bmin</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))),</span><span class="n">posa</span><span class="p">)</span>
                <span class="c1"># convert to jansky per (new) beam</span>
                <span class="n">new_image_q</span> <span class="o">=</span> <span class="n">Jy2JyPerBeam</span><span class="p">(</span><span class="n">new_image_q</span><span class="p">,</span> <span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>

            <span class="n">input_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="p">)</span>  <span class="c1"># before it was np.fft.fftn(img)</span>
            <span class="n">offset_image</span> <span class="o">=</span> <span class="n">fourier_shift</span><span class="p">(</span><span class="n">input_</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="p">[</span><span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">])</span>
            <span class="n">imgalign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">offset_image</span><span class="p">)</span>  <span class="c1"># again before ifftn</span>
            <span class="n">new_image_u</span> <span class="o">=</span> <span class="n">imgalign</span><span class="o">.</span><span class="n">real</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bmaj</span><span class="o">==-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bmin</span> <span class="o">==-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">posa</span><span class="o">==-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">new_image_u</span> <span class="o">=</span> <span class="n">JyPerBeam2Jy</span><span class="p">(</span><span class="n">new_image_u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                <span class="n">new_image_u</span><span class="o">=</span> <span class="n">convolve_with_elliptical_gaussian</span><span class="p">(</span><span class="n">new_image_u</span><span class="p">,</span><span class="n">bmaj</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))),</span>
                                                                <span class="n">bmin</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))),</span><span class="n">posa</span><span class="p">)</span>
                <span class="c1"># convert to jansky per (new) beam</span>
                <span class="n">new_image_u</span> <span class="o">=</span> <span class="n">Jy2JyPerBeam</span><span class="p">(</span><span class="n">new_image_u</span><span class="p">,</span> <span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">new_image_q</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">new_image_u</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">new_stokes_u_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">new_stokes_q_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1">#write outputs to the fitsfiles</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">only_stokes_i</span><span class="p">:</span>
            <span class="c1"># this means DIFMAP style fits image</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_i</span>
                <span class="n">new_stokes_i_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_clean/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>
                    <span class="c1">#shift model/clean components</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAX&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift_x_deg</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAY&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift_y_deg</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bmaj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bmin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">posa</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="c1">#Overwrite beam parameters in header</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMAJ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmaj</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmin</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BPA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">posa</span>
                <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_i_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_q</span>
                    <span class="n">new_stokes_q_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_q/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>
                        <span class="c1"># shift model/clean components</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAX&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift_x_deg</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAY&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift_y_deg</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bmaj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bmin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">posa</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="c1"># Overwrite beam parameters in header</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMAJ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmaj</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmin</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BPA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">posa</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_q_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_u</span>
                    <span class="n">new_stokes_u_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_u/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>
                        <span class="c1"># shift model/clean components</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAX&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift_x_deg</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAY&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift_y_deg</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bmaj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bmin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">posa</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="c1"># Overwrite beam parameters in header</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMAJ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmaj</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmin</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BPA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">posa</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_u_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># CASA style</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">)</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_i</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_q</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_u</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bmaj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bmin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">posa</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="c1"># Overwrite beam parameters in header</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMAJ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmaj</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmin</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BPA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">posa</span>
            <span class="n">new_stokes_i_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_clean/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_i_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">new_stokes_q_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
            <span class="n">new_stokes_u_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

        <span class="c1"># if model loaded try shifting model image as well</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">:</span>
                <span class="n">input_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span>
                    <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>  <span class="c1"># before it was np.fft.fftn(img)</span>
                <span class="n">offset_image</span> <span class="o">=</span> <span class="n">fourier_shift</span><span class="p">(</span><span class="n">input_</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="p">[</span><span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">])</span>
                <span class="n">imgalign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">offset_image</span><span class="p">)</span>  <span class="c1"># again before ifftn</span>
                <span class="n">new_image_model</span> <span class="o">=</span> <span class="n">imgalign</span><span class="o">.</span><span class="n">real</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bmaj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bmin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">posa</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">new_image_model</span> <span class="o">=</span> <span class="n">JyPerBeam2Jy</span><span class="p">(</span><span class="n">new_image_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_maj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_min</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                    <span class="n">new_image_model</span> <span class="o">=</span> <span class="n">convolve_with_elliptical_gaussian</span><span class="p">(</span><span class="n">new_image_model</span><span class="p">,</span>
                                                                        <span class="n">bmaj</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))),</span>
                                                                        <span class="n">bmin</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))),</span>
                                                                        <span class="n">posa</span><span class="p">)</span>
                    <span class="c1"># convert to jansky per (new) beam</span>
                    <span class="n">new_image_model</span> <span class="o">=</span> <span class="n">Jy2JyPerBeam</span><span class="p">(</span><span class="n">new_image_model</span><span class="p">,</span> <span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>

                <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_model</span>
                    <span class="n">new_model_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_model/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAX&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift_x_deg</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAY&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift_y_deg</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bmaj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bmin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">posa</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMAJ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmaj</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BMIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmin</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BPA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">posa</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_model_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_model_fits</span> <span class="o">=</span> <span class="n">new_stokes_i_fits</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">new_image_model</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">new_model_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">new_uvf_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#This means we have a valid .uvf file and we will use DIFMAP for shifting and restoring</span>
        <span class="c1"># calculate shift to pixel increments:</span>
        <span class="n">shift_x_pix</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">shift_x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">)</span>
        <span class="n">shift_y_pix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">shift_y</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="p">)</span>

        <span class="c1">#first let&#39;s shift the mask</span>
        <span class="c1"># shift the image mask</span>
        <span class="n">input_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>  <span class="c1"># before it was np.fft.fftn(img)</span>
        <span class="n">offset_image</span> <span class="o">=</span> <span class="n">fourier_shift</span><span class="p">(</span><span class="n">input_</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="p">[</span><span class="n">shift_y_pix</span><span class="p">,</span> <span class="n">shift_x_pix</span><span class="p">])</span>
        <span class="n">imgalign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">offset_image</span><span class="p">)</span>  <span class="c1"># again before ifftn</span>
        <span class="n">new_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">imgalign</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span>

        <span class="c1">#restore Stokes I</span>
        <span class="n">new_stokes_i_fits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.mod&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">fold_with_beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">],</span><span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                <span class="n">bmaj</span><span class="o">=</span><span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=</span><span class="n">bmin</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="n">posa</span><span class="p">,</span><span class="n">shift_x</span><span class="o">=</span><span class="n">shift_x</span><span class="p">,</span><span class="n">shift_y</span><span class="o">=</span><span class="n">shift_y</span><span class="p">,</span>
                <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span><span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_clean&quot;</span><span class="p">,</span><span class="n">outname</span><span class="o">=</span><span class="n">new_stokes_i_fits</span><span class="p">,</span>
                <span class="n">n_pixel</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">pixel_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                <span class="n">mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">],</span><span class="n">clean_mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">],</span>
                <span class="n">uvf_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">],</span><span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span><span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

        <span class="n">new_stokes_i_fits</span><span class="o">+=</span><span class="s2">&quot;.fits&quot;</span>

        <span class="c1">#try to restore modelfit if it is there</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">:</span>
                <span class="n">new_model_fits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.mod&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="n">fold_with_beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">],</span> <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                    <span class="n">bmaj</span><span class="o">=</span><span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=</span><span class="n">bmin</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="n">posa</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="n">shift_y</span><span class="p">,</span>
                    <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_model&quot;</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="n">new_model_fits</span><span class="p">,</span>
                    <span class="n">n_pixel</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">pixel_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                    <span class="n">mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="p">],</span> <span class="n">clean_mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">],</span> <span class="n">uvf_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">],</span>
                    <span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span><span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

                <span class="n">new_model_fits</span><span class="o">+=</span><span class="s2">&quot;.fits&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_model_fits</span><span class="o">=</span><span class="n">new_stokes_i_fits</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">new_model_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

        <span class="c1">#try to restore polarization as well if it is there</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_stokes_q_fits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.mod&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">new_stokes_u_fits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.mod&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>


            <span class="n">fold_with_beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">],</span><span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                <span class="n">bmaj</span><span class="o">=</span><span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=</span><span class="n">bmin</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="n">posa</span><span class="p">,</span><span class="n">shift_x</span><span class="o">=</span><span class="n">shift_x</span><span class="p">,</span><span class="n">shift_y</span><span class="o">=</span><span class="n">shift_y</span><span class="p">,</span>
                <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;q&quot;</span><span class="p">,</span><span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_q&quot;</span><span class="p">,</span><span class="n">outname</span><span class="o">=</span><span class="n">new_stokes_q_fits</span><span class="p">,</span>
                <span class="n">n_pixel</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">pixel_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                <span class="n">mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="p">],</span><span class="n">clean_mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">],</span>
                           <span class="n">uvf_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">],</span><span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span><span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

            <span class="n">new_stokes_q_fits</span><span class="o">+=</span><span class="s2">&quot;.fits&quot;</span>

            <span class="n">fold_with_beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">],</span><span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                <span class="n">bmaj</span><span class="o">=</span><span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=</span><span class="n">bmin</span><span class="p">,</span> <span class="n">posa</span><span class="o">=</span><span class="n">posa</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="n">shift_x</span><span class="p">,</span><span class="n">shift_y</span><span class="o">=</span><span class="n">shift_y</span><span class="p">,</span>
                <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;u&quot;</span><span class="p">,</span><span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="o">+</span><span class="s2">&quot;mod_files_u&quot;</span><span class="p">,</span><span class="n">outname</span><span class="o">=</span><span class="n">new_stokes_u_fits</span><span class="p">,</span>
                <span class="n">n_pixel</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">pixel_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degpp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                <span class="n">mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="p">],</span><span class="n">clean_mod_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">],</span>
                           <span class="n">uvf_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">],</span><span class="n">weighting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span><span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

            <span class="n">new_stokes_u_fits</span><span class="o">+=</span><span class="s2">&quot;.fits&quot;</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">new_stokes_q_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
            <span class="n">new_stokes_u_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

        <span class="n">new_uvf_file</span><span class="o">=</span><span class="n">new_stokes_i_fits</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.fits&quot;</span><span class="p">,</span><span class="s2">&quot;.uvf&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_inp</span><span class="p">:</span>
        <span class="n">new_model_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">return</span> <span class="n">ImageData</span><span class="p">(</span><span class="n">fits_file</span><span class="o">=</span><span class="n">new_stokes_i_fits</span><span class="p">,</span>
                     <span class="n">uvf_file</span><span class="o">=</span><span class="n">new_uvf_file</span><span class="p">,</span>
                     <span class="n">stokes_q</span><span class="o">=</span><span class="n">new_stokes_q_fits</span><span class="p">,</span>
                     <span class="n">stokes_u</span><span class="o">=</span><span class="n">new_stokes_u_fits</span><span class="p">,</span>
                     <span class="n">mask</span><span class="o">=</span><span class="n">new_mask</span><span class="p">,</span>
                     <span class="n">ridgeline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="p">,</span>
                     <span class="n">redshift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">,</span>
                     <span class="n">counter_ridgeline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="p">,</span>
                     <span class="n">noise_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_method</span><span class="p">,</span>
                     <span class="n">model_save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="p">,</span>
                     <span class="n">model</span><span class="o">=</span><span class="n">new_model_fits</span><span class="p">,</span>
                     <span class="n">correct_rician_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">correct_rician_bias</span><span class="p">,</span>
                     <span class="n">comp_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">core_comp_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span>
                     <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                     <span class="n">fit_comp_polarization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol</span><span class="p">,</span>
                     <span class="n">fit_comp_pol_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol_errors</span><span class="p">,</span>
                     <span class="n">uvw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span>
                     <span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.rotate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">rotate</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">useDIFMAP</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to rotate ImageData Object (note: EVPAs are currently not rotated!)</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>angle</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Rotation angle in degrees (North through East)</p>
              </div>
            </li>
            <li>
              <b><code>useDIFMAP</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to use DIFMAP or not</p>
              </div>
            </li>
            <li>
              <b><code>reshape</code></b>
                  (<code>bool</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>If useDIFMAP=False, choose whether to reshape the image size to avoid empty areas.</p>
              </div>
            </li>
            <li>
              <b><code>order</code></b>
                  (<code>int</code>, default:
                      <code>1</code>
)
              –
              <div class="doc-md-description">
                <p>Order parameter for scipy.ndimage.rotate function</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>image</code></b>(                  <code><a class="autorefs autorefs-internal" title="vcat.image_data.ImageData" href="#vcat.image_data.ImageData">ImageData</a></code>
)              –
              <div class="doc-md-description">
                <p>rotated ImageData object</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">angle</span><span class="p">,</span><span class="n">useDIFMAP</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to rotate ImageData Object (note: EVPAs are currently not rotated!)</span>

<span class="sd">    Args:</span>
<span class="sd">        angle (float): Rotation angle in degrees (North through East)</span>
<span class="sd">        useDIFMAP (bool): Choose whether to use DIFMAP or not</span>
<span class="sd">        reshape (bool): If useDIFMAP=False, choose whether to reshape the image size to avoid empty areas.</span>
<span class="sd">        order (int): Order parameter for scipy.ndimage.rotate function</span>

<span class="sd">    Returns:</span>
<span class="sd">        image (ImageData): rotated ImageData object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#rotate mask</span>
    <span class="n">new_mask</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span><span class="o">-</span><span class="n">angle</span><span class="p">,</span><span class="n">reshape</span><span class="o">=</span><span class="n">reshape</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1">#make sure values are valid</span>
    <span class="n">new_mask</span><span class="p">[</span><span class="n">new_mask</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">new_mask</span><span class="p">[</span><span class="n">new_mask</span> <span class="o">&gt;=</span> <span class="mf">0.1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1">#rotate uvf file</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">new_uvf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_clean/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.uvf&quot;</span>

        <span class="n">rotate_uvf_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">,</span> <span class="o">-</span><span class="n">angle</span><span class="p">,</span> <span class="n">new_uvf</span><span class="p">)</span>

    <span class="c1">#rotate ridgeline</span>
    <span class="n">x_new</span><span class="p">,</span><span class="n">y_new</span><span class="o">=</span><span class="n">rotate_points</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">.</span><span class="n">X_ridg</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">.</span><span class="n">Y_ridg</span><span class="p">),</span> <span class="o">-</span><span class="n">angle</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">.</span><span class="n">X_ridg</span><span class="o">=</span><span class="n">x_new</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="o">.</span><span class="n">Y_ridg</span><span class="o">=</span><span class="n">y_new</span>

    <span class="c1">#rotate counterridgeline</span>
    <span class="n">x_new</span><span class="p">,</span> <span class="n">y_new</span> <span class="o">=</span> <span class="n">rotate_points</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="o">.</span><span class="n">X_ridg</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="o">.</span><span class="n">Y_ridg</span><span class="p">),</span> <span class="o">-</span><span class="n">angle</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="o">.</span><span class="n">X_ridg</span> <span class="o">=</span> <span class="n">x_new</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="o">.</span><span class="n">Y_ridg</span> <span class="o">=</span> <span class="n">y_new</span>

    <span class="c1">#do actual image rotations</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="o">==</span><span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">useDIFMAP</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No .uvf file attached or useDIFMAP=False selected, will do simple shift of image only&quot;</span><span class="p">)</span>

        <span class="n">new_image_i</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="o">-</span><span class="n">angle</span><span class="p">,</span><span class="n">reshape</span><span class="o">=</span><span class="n">reshape</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_image_q</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="p">,</span><span class="o">-</span><span class="n">angle</span><span class="p">,</span><span class="n">reshape</span><span class="o">=</span><span class="n">reshape</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
            <span class="n">new_image_u</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="p">,</span><span class="o">-</span><span class="n">angle</span><span class="p">,</span><span class="n">reshape</span><span class="o">=</span><span class="n">reshape</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to rotate polarization, probably no polarization loaded&quot;</span><span class="p">)</span>

        <span class="c1"># write outputs to the fits files</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">only_stokes_i</span><span class="p">:</span>
            <span class="c1"># this means DIFMAP style fits image</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1"># overwrite image data</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_i</span>
                <span class="n">new_stokes_i_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_clean/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>
                    <span class="n">new_x</span><span class="p">,</span><span class="n">new_y</span><span class="o">=</span><span class="n">rotate_points</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAX&quot;</span><span class="p">],</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAY&quot;</span><span class="p">],</span><span class="o">-</span><span class="n">angle</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DELTAX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_x</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DELTAY&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">new_y</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BPA&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">angle</span>
                <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_i_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="c1"># overwrite image data</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_q</span>
                    <span class="n">new_stokes_q_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_q/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>
                        <span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span> <span class="o">=</span> <span class="n">rotate_points</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAX&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAY&quot;</span><span class="p">],</span> <span class="o">-</span><span class="n">angle</span><span class="p">)</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DELTAX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_x</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DELTAY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_y</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BPA&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">angle</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_q_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_stokes_q_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="c1"># overwrite image data</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_u</span>
                    <span class="n">new_stokes_u_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_u/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>
                        <span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span> <span class="o">=</span> <span class="n">rotate_points</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAX&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAY&quot;</span><span class="p">],</span> <span class="o">-</span><span class="n">angle</span><span class="p">)</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DELTAX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_x</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DELTAY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_y</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BPA&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">angle</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_u_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_stokes_u_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># CASA style</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">)</span>
            <span class="c1"># overwrite image data</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_i</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_q</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_u</span>
            <span class="n">new_stokes_i_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_clean/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BPA&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">angle</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_stokes_i_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
            <span class="n">new_stokes_q_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">new_stokes_u_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># if model loaded try rotating as well</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>

                    <span class="n">new_image_model</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="o">-</span><span class="n">angle</span><span class="p">,</span><span class="n">reshape</span><span class="o">=</span><span class="n">reshape</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

                    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_image_model</span>
                        <span class="n">new_model_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span> <span class="o">+</span> <span class="s2">&quot;mod_files_model/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;GHz.fits&quot;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XTENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BINTABLE&#39;</span>
                            <span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span> <span class="o">=</span> <span class="n">rotate_points</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAX&quot;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DELTAY&quot;</span><span class="p">],</span> <span class="o">-</span><span class="n">angle</span><span class="p">)</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DELTAX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_x</span>
                            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DELTAY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_y</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BPA&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">angle</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_model_fits</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_model_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_model_fits</span> <span class="o">=</span> <span class="n">new_stokes_i_fits</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Model not regridded, probably no model loaded.&quot;</span><span class="p">)</span>
            <span class="n">new_model_fits</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_inp</span><span class="p">:</span>
            <span class="n">new_model_fits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">beam_pa</span><span class="o">+=</span><span class="n">angle</span>

        <span class="n">newImageData</span><span class="o">=</span> <span class="n">ImageData</span><span class="p">(</span><span class="n">fits_file</span><span class="o">=</span><span class="n">new_stokes_i_fits</span><span class="p">,</span>
                     <span class="n">uvf_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">,</span>
                     <span class="n">stokes_q</span><span class="o">=</span><span class="n">new_stokes_q_fits</span><span class="p">,</span>
                     <span class="n">stokes_u</span><span class="o">=</span><span class="n">new_stokes_u_fits</span><span class="p">,</span>
                     <span class="n">mask</span><span class="o">=</span><span class="n">new_mask</span><span class="p">,</span>
                     <span class="n">redshift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">,</span>
                     <span class="n">ridgeline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="p">,</span>
                     <span class="n">counter_ridgeline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="p">,</span>
                     <span class="n">noise_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_method</span><span class="p">,</span>
                     <span class="n">model_save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="p">,</span>
                     <span class="n">model</span><span class="o">=</span><span class="n">new_model_fits</span><span class="p">,</span>
                     <span class="n">correct_rician_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">correct_rician_bias</span><span class="p">,</span>
                     <span class="n">comp_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">core_comp_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span>
                     <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                     <span class="n">fit_comp_polarization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol</span><span class="p">,</span>
                     <span class="n">fit_comp_pol_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol_errors</span><span class="p">,</span>
                     <span class="n">uvw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span>
                     <span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_inp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

        <span class="n">newImageData</span><span class="o">=</span><span class="n">ImageData</span><span class="p">(</span><span class="n">fits_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_file</span><span class="p">,</span>
                     <span class="n">uvf_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvf_file</span><span class="p">,</span>
                     <span class="n">stokes_q</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_path</span><span class="p">,</span>
                     <span class="n">stokes_u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_path</span><span class="p">,</span>
                     <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span>
                     <span class="n">redshift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">,</span>
                     <span class="n">ridgeline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ridgeline</span><span class="p">,</span>
                     <span class="n">counter_ridgeline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">counter_ridgeline</span><span class="p">,</span>
                     <span class="n">noise_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_method</span><span class="p">,</span>
                     <span class="n">model_save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_dir</span><span class="p">,</span>
                     <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file_path</span><span class="p">,</span>
                     <span class="n">correct_rician_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">correct_rician_bias</span><span class="p">,</span>
                     <span class="n">comp_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">core_comp_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span>
                     <span class="n">difmap_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">difmap_path</span><span class="p">,</span>
                     <span class="n">fit_comp_polarization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol</span><span class="p">,</span>
                     <span class="n">fit_comp_pol_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_comp_pol_errors</span><span class="p">,</span>
                     <span class="n">uvw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvw</span><span class="p">,</span>
                     <span class="n">uvtaper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">)</span>

        <span class="n">rotate_mod_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">,</span><span class="n">angle</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_i_mod_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rotate_mod_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="p">,</span><span class="n">angle</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_q_mod_file</span><span class="p">)</span>
            <span class="n">rotate_mod_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="p">,</span><span class="n">angle</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes_u_mod_file</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Could not rotate polarization, probably not loaded.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rotate_mod_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="p">,</span><span class="n">angle</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">model_mod_file</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Could not rotate model, probably not loaded.&quot;</span><span class="p">)</span>

        <span class="n">newImageData</span><span class="o">.</span><span class="n">uvf_file</span><span class="o">=</span><span class="n">new_uvf</span>
        <span class="n">newImageData</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="n">new_mask</span>
        <span class="n">newImageData</span><span class="o">.</span><span class="n">beam_pa</span><span class="o">+=</span><span class="n">angle</span>

        <span class="n">newImageData</span><span class="o">=</span><span class="n">newImageData</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">newImageData</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.set_core_component" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_core_component</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to set the core component</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>id</code></b>
                  (<code>int</code>)
              –
              <div class="doc-md-description">
                <p>Component ID of the core component</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">set_core_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to set the core component</span>

<span class="sd">    Args:</span>
<span class="sd">        id (int): Component ID of the core component</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">core_ind</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">component_number</span><span class="o">==</span><span class="nb">id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">is_core</span><span class="o">=</span><span class="kc">True</span>
            <span class="n">core_ind</span><span class="o">=</span><span class="n">ind</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">is_core</span><span class="o">=</span><span class="kc">False</span>

    <span class="k">if</span> <span class="n">core_ind</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No component with ID </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> found, no core currently set!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#recalculate core distances for every component</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">):</span>
            <span class="n">core</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">core_ind</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_distance_to_core</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">core</span><span class="o">.</span><span class="n">x_err</span><span class="p">,</span><span class="n">core</span><span class="o">.</span><span class="n">y_err</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.shift" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">shift</span><span class="p">(</span><span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">,</span> <span class="n">useDIFMAP</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to shift the image in RA and Dec.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>shift_x</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Shift in Right Ascension (in mas)</p>
              </div>
            </li>
            <li>
              <b><code>shift_y</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Shift in Declination (in mas)</p>
              </div>
            </li>
            <li>
              <b><code>npix</code></b>
                  (<code>int</code>)
              –
              <div class="doc-md-description">
                <p>Option to change the number of pixels in ONE direction.</p>
              </div>
            </li>
            <li>
              <b><code>pixel_size</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Option to change the pixel size (in mas)</p>
              </div>
            </li>
            <li>
              <b><code>useDIFMAP</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Choose whether to use DIFMAP for shifting or not.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>image</code></b>(                  <code><a class="autorefs autorefs-internal" title="vcat.image_data.ImageData" href="#vcat.image_data.ImageData">ImageData</a></code>
)              –
              <div class="doc-md-description">
                <p>shifted ImageData object</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">shift_x</span><span class="p">,</span><span class="n">shift_y</span><span class="p">,</span><span class="n">useDIFMAP</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to shift the image in RA and Dec.</span>

<span class="sd">    Args:</span>
<span class="sd">        shift_x (float): Shift in Right Ascension (in mas)</span>
<span class="sd">        shift_y (float): Shift in Declination (in mas)</span>
<span class="sd">        npix (int): Option to change the number of pixels in ONE direction.</span>
<span class="sd">        pixel_size (float): Option to change the pixel size (in mas)</span>
<span class="sd">        useDIFMAP (bool): Choose whether to use DIFMAP for shifting or not.</span>

<span class="sd">    Returns:</span>
<span class="sd">        image (ImageData): shifted ImageData object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#We can just call the restore() function without doing the restore steps</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">shift_x</span><span class="p">,</span><span class="n">shift_y</span><span class="p">,</span><span class="n">useDIFMAP</span><span class="o">=</span><span class="n">useDIFMAP</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No shift possible, something went wrong!&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vcat.image_data.ImageData.write_mod_file_from_casa" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_mod_file_from_casa</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="s1">&#39;export.mod&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Writes a .mod file from a CASA exported .fits model file.
Args:
    file_path: File path to a .fits model file as exported from a CASA .model file (e.g. with exportfits() in CASA)
    channel: Choose the Stokes channel to use (options: "i","q","u","v")
    export: File path where to write the .mod file</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>Nothing, but writes a .mod file to export</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/image_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">write_mod_file_from_casa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span><span class="n">export</span><span class="o">=</span><span class="s2">&quot;export.mod&quot;</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Writes a .mod file from a CASA exported .fits model file.</span>
<span class="sd">        Args:</span>
<span class="sd">            file_path: File path to a .fits model file as exported from a CASA .model file (e.g. with exportfits() in CASA)</span>
<span class="sd">            channel: Choose the Stokes channel to use (options: &quot;i&quot;,&quot;q&quot;,&quot;u&quot;,&quot;v&quot;)</span>
<span class="sd">            export: File path where to write the .mod file</span>

<span class="sd">        Returns:</span>
<span class="sd">            Nothing, but writes a .mod file to export</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">channel</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
        <span class="n">clean_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span>
    <span class="k">elif</span> <span class="n">channel</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
        <span class="n">clean_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_q</span>
    <span class="k">elif</span> <span class="n">channel</span> <span class="o">==</span> <span class="s2">&quot;u&quot;</span><span class="p">:</span>
        <span class="n">clean_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_u</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please enter a valid channel (i,q,u)&quot;</span><span class="p">)</span>

    <span class="c1"># read out clean components from pixel map</span>
    <span class="n">delta_x</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">delta_y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">zeros</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">clean_map</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">delta_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                <span class="n">delta_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                <span class="n">flux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clean_map</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="n">zeros</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># create model_df</span>
    <span class="n">model_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;Flux&#39;</span><span class="p">:</span> <span class="n">flux</span><span class="p">,</span>
         <span class="s1">&#39;Delta_x&#39;</span><span class="p">:</span> <span class="n">delta_x</span><span class="p">,</span>
         <span class="s1">&#39;Delta_y&#39;</span><span class="p">:</span> <span class="n">delta_y</span><span class="p">,</span>
         <span class="s1">&#39;Major_axis&#39;</span><span class="p">:</span> <span class="n">zeros</span><span class="p">,</span>
         <span class="s1">&#39;Minor_axis&#39;</span><span class="p">:</span> <span class="n">zeros</span><span class="p">,</span>
         <span class="s1">&#39;PA&#39;</span><span class="p">:</span> <span class="n">zeros</span><span class="p">,</span>
         <span class="s1">&#39;Typ_obj&#39;</span><span class="p">:</span> <span class="n">zeros</span>
         <span class="p">})</span>

    <span class="c1"># create mod file</span>
    <span class="n">write_mod_file</span><span class="p">(</span><span class="n">model_df</span><span class="p">,</span> <span class="n">export</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.Jy2JyPerBeam" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">Jy2JyPerBeam</span><span class="p">(</span><span class="n">jpp</span><span class="p">,</span> <span class="n">b_maj</span><span class="p">,</span> <span class="n">b_min</span><span class="p">,</span> <span class="n">px_inc</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Converts Jy/px to Jy/beam</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>jpp</code></b>
              –
              <div class="doc-md-description">
                <p>Jansky per pixel</p>
              </div>
            </li>
            <li>
              <b><code>b_maj</code></b>
              –
              <div class="doc-md-description">
                <p>Major Axis</p>
              </div>
            </li>
            <li>
              <b><code>b_min</code></b>
              –
              <div class="doc-md-description">
                <p>Minor Axis</p>
              </div>
            </li>
            <li>
              <b><code>px_inc</code></b>
              –
              <div class="doc-md-description">
                <p>pixel size</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>jpb</code></b>              –
              <div class="doc-md-description">
                <p>Jansky per pixel value</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">Jy2JyPerBeam</span><span class="p">(</span><span class="n">jpp</span><span class="p">,</span><span class="n">b_maj</span><span class="p">,</span><span class="n">b_min</span><span class="p">,</span><span class="n">px_inc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts Jy/px to Jy/beam</span>

<span class="sd">        Args:</span>
<span class="sd">            jpp: Jansky per pixel</span>
<span class="sd">            b_maj: Major Axis</span>
<span class="sd">            b_min: Minor Axis</span>
<span class="sd">            px_inc: pixel size</span>

<span class="sd">        Returns:</span>
<span class="sd">            jpb: Jansky per pixel value</span>

<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">jpp</span><span class="o">*</span><span class="n">PXPERBEAM</span><span class="p">(</span><span class="n">b_maj</span><span class="p">,</span><span class="n">b_min</span><span class="p">,</span><span class="n">px_inc</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.JyPerBeam2Jy" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">JyPerBeam2Jy</span><span class="p">(</span><span class="n">jpb</span><span class="p">,</span> <span class="n">b_maj</span><span class="p">,</span> <span class="n">b_min</span><span class="p">,</span> <span class="n">px_inc</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Converts Jy/beam to Jy</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>jbp</code></b>
              –
              <div class="doc-md-description">
                <p>Jansky per beam value</p>
              </div>
            </li>
            <li>
              <b><code>b_maj</code></b>
              –
              <div class="doc-md-description">
                <p>Major Axis</p>
              </div>
            </li>
            <li>
              <b><code>b_min</code></b>
              –
              <div class="doc-md-description">
                <p>Minor Axis</p>
              </div>
            </li>
            <li>
              <b><code>px_inc</code></b>
              –
              <div class="doc-md-description">
                <p>pixel size</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>jy</code></b>              –
              <div class="doc-md-description">
                <p>Jansky value</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">JyPerBeam2Jy</span><span class="p">(</span><span class="n">jpb</span><span class="p">,</span><span class="n">b_maj</span><span class="p">,</span><span class="n">b_min</span><span class="p">,</span><span class="n">px_inc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts Jy/beam to Jy</span>

<span class="sd">    Args:</span>
<span class="sd">        jbp: Jansky per beam value</span>
<span class="sd">        b_maj: Major Axis</span>
<span class="sd">        b_min: Minor Axis</span>
<span class="sd">        px_inc: pixel size</span>

<span class="sd">    Returns:</span>
<span class="sd">        jy: Jansky value</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">jpb</span><span class="o">/</span><span class="n">PXPERBEAM</span><span class="p">(</span><span class="n">b_maj</span><span class="p">,</span><span class="n">b_min</span><span class="p">,</span><span class="n">px_inc</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.PXPERBEAM" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">PXPERBEAM</span><span class="p">(</span><span class="n">b_maj</span><span class="p">,</span> <span class="n">b_min</span><span class="p">,</span> <span class="n">px_inc</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>calculates the pixels per beam.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>b_maj</code></b>
              –
              <div class="doc-md-description">
                <p>major axis</p>
              </div>
            </li>
            <li>
              <b><code>b_min</code></b>
              –
              <div class="doc-md-description">
                <p>minor axis</p>
              </div>
            </li>
            <li>
              <b><code>px_inc</code></b>
              –
              <div class="doc-md-description">
                <p>pixel size</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>ppb</code></b>              –
              <div class="doc-md-description">
                <p>pixels per beam</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">PXPERBEAM</span><span class="p">(</span><span class="n">b_maj</span><span class="p">,</span><span class="n">b_min</span><span class="p">,</span><span class="n">px_inc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;calculates the pixels per beam.</span>

<span class="sd">    Args:</span>
<span class="sd">        b_maj: major axis</span>
<span class="sd">        b_min: minor axis</span>
<span class="sd">        px_inc: pixel size</span>

<span class="sd">    Returns:</span>
<span class="sd">        ppb: pixels per beam</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">beam_area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">b_min</span><span class="o">*</span><span class="n">b_maj</span>
    <span class="n">PXPERBEAM</span> <span class="o">=</span> <span class="n">beam_area</span><span class="o">/</span><span class="p">(</span><span class="n">px_inc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">PXPERBEAM</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.calculate_beam_width" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_beam_width</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">beam_maj</span><span class="p">,</span> <span class="n">beam_min</span><span class="p">,</span> <span class="n">beam_pa</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Calculate width of a beam at a certain angle</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>angle</code></b>
              –
              <div class="doc-md-description">
                <p>Angle in degrees</p>
              </div>
            </li>
            <li>
              <b><code>beam_maj</code></b>
              –
              <div class="doc-md-description">
                <p>Beam major axis length</p>
              </div>
            </li>
            <li>
              <b><code>beam_min</code></b>
              –
              <div class="doc-md-description">
                <p>beam minor axis length</p>
              </div>
            </li>
            <li>
              <b><code>beam_pa</code></b>
              –
              <div class="doc-md-description">
                <p>beam position angle in degrees</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>beam_width</code></b>              –
              <div class="doc-md-description">
                <p>Width at the given angle</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_beam_width</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">beam_maj</span><span class="p">,</span> <span class="n">beam_min</span><span class="p">,</span> <span class="n">beam_pa</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate width of a beam at a certain angle</span>

<span class="sd">    Args:</span>
<span class="sd">        angle: Angle in degrees</span>
<span class="sd">        beam_maj: Beam major axis length</span>
<span class="sd">        beam_min: beam minor axis length</span>
<span class="sd">        beam_pa: beam position angle in degrees</span>

<span class="sd">    Returns:</span>
<span class="sd">        beam_width: Width at the given angle</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_pos</span><span class="o">=</span><span class="n">beam_pa</span><span class="o">-</span><span class="n">angle</span>

    <span class="n">beam</span> <span class="o">=</span> <span class="n">Ellipse</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">hradius</span><span class="o">=</span><span class="n">beam_maj</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">vradius</span><span class="o">=</span><span class="n">beam_min</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">Line</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">new_pos</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">new_pos</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)))</span>
    <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">width</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">p2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">width</span>
    <span class="k">return</span> <span class="n">width</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.convolve_with_elliptical_gaussian" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">convolve_with_elliptical_gaussian</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Convolves a 2D image with an elliptical Gaussian kernel.</p>

            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">convolve_with_elliptical_gaussian</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convolves a 2D image with an elliptical Gaussian kernel.&quot;&quot;&quot;</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">elliptical_gaussian_kernel</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
    <span class="n">convolved</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">convolved</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.elliptical_gaussian_kernel" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">elliptical_gaussian_kernel</span><span class="p">(</span><span class="n">size_x</span><span class="p">,</span> <span class="n">size_y</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Generate an elliptical Gaussian kernel with rotation.</p>

            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">elliptical_gaussian_kernel</span><span class="p">(</span><span class="n">size_x</span><span class="p">,</span> <span class="n">size_y</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate an elliptical Gaussian kernel with rotation.&quot;&quot;&quot;</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">size_y</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">size_y</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">size_y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">size_x</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">size_x</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">size_x</span><span class="p">))</span>

    <span class="c1"># Rotation matrix</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">x_rot</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">y_rot</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>

    <span class="c1"># Elliptical Gaussian formula</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x_rot</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma_x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">y_rot</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma_y</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">g</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>  <span class="c1"># Normalize the kernel</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.fit_width" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit_width</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">width_err</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dist_err</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit_type</span><span class="o">=</span><span class="s1">&#39;brokenPowerlaw&#39;</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit_r0</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Fit a power-law or broken-powerlaw to jet width</p>

            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">fit_width</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="n">width</span><span class="p">,</span>
                <span class="n">width_err</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">dist_err</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">fit_type</span><span class="o">=</span><span class="s1">&#39;brokenPowerlaw&#39;</span><span class="p">,</span>
                <span class="n">x0</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">fit_r0</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Fit a power-law or broken-powerlaw to jet width&#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">x0</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fit_type</span><span class="o">==</span><span class="s1">&#39;brokenPowerlaw&#39;</span> <span class="ow">and</span> <span class="n">fit_r0</span><span class="p">:</span>
            <span class="n">x0</span><span class="o">=</span><span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">fit_type</span><span class="o">==</span><span class="s1">&#39;brokenPowerlaw&#39;</span><span class="p">:</span>
            <span class="n">x0</span><span class="o">=</span><span class="p">[</span><span class="mf">0.3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">fit_type</span><span class="o">==</span><span class="s2">&quot;Powerlaw&quot;</span> <span class="ow">and</span> <span class="n">fit_r0</span><span class="p">:</span>
            <span class="n">x0</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">fit_type</span><span class="o">==</span><span class="s2">&quot;Powerlaw&quot;</span><span class="p">:</span>
            <span class="n">x0</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please select valid fit_type (&#39;Powerlaw&#39;, &#39;brokenPowerlaw&#39;)&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s1">&#39;Powerlaw&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dist_err</span><span class="p">:</span>
            <span class="n">beta</span><span class="p">,</span><span class="n">sd_beta</span><span class="p">,</span><span class="n">chi2</span><span class="p">,</span><span class="n">out</span> <span class="o">=</span> <span class="n">fit_pl</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="n">width</span><span class="p">,</span><span class="n">width_err</span><span class="p">,</span><span class="n">sx</span><span class="o">=</span><span class="n">dist_err</span><span class="p">,</span><span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span><span class="n">fit_r0</span><span class="o">=</span><span class="n">fit_r0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta</span><span class="p">,</span><span class="n">sd_beta</span><span class="p">,</span><span class="n">chi2</span><span class="p">,</span><span class="n">out</span> <span class="o">=</span> <span class="n">fit_pl</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="n">width</span><span class="p">,</span><span class="n">width_err</span><span class="p">,</span><span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span><span class="n">fit_r0</span><span class="o">=</span><span class="n">fit_r0</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">fit_type</span><span class="o">==</span><span class="s1">&#39;brokenPowerlaw&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dist_err</span><span class="p">:</span>
            <span class="n">beta</span><span class="p">,</span><span class="n">sd_beta</span><span class="p">,</span><span class="n">chi2</span><span class="p">,</span><span class="n">out</span> <span class="o">=</span> <span class="n">fit_bpl</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="n">width</span><span class="p">,</span><span class="n">width_err</span><span class="p">,</span><span class="n">sx</span><span class="o">=</span><span class="n">dist_err</span><span class="p">,</span><span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span><span class="n">fit_r0</span><span class="o">=</span><span class="n">fit_r0</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta</span><span class="p">,</span><span class="n">sd_beta</span><span class="p">,</span><span class="n">chi2</span><span class="p">,</span><span class="n">out</span> <span class="o">=</span> <span class="n">fit_bpl</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="n">width</span><span class="p">,</span><span class="n">width_err</span><span class="p">,</span><span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span><span class="n">fit_r0</span><span class="o">=</span><span class="n">fit_r0</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">beta</span><span class="p">,</span> <span class="n">sd_beta</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.func_turn" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">func_turn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">i0</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">alpha0</span><span class="p">,</span> <span class="n">alphat</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Turnover frequency function.</p>

            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">func_turn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">i0</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">alpha0</span><span class="p">,</span> <span class="n">alphat</span> <span class="o">=</span> <span class="mf">2.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Turnover frequency function.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">i0</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">turn</span><span class="p">)</span><span class="o">**</span><span class="n">alphat</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">turn</span> <span class="o">/</span> <span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">alphat</span> <span class="o">-</span> <span class="n">alpha0</span><span class="p">)))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.getComponentInfo" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">getComponentInfo</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Imports component info from a modelfit .fits or .mod file.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>filename</code></b>
              –
              <div class="doc-md-description">
                <p>Path to a modelfit (or clean) .fits or .mod file</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>output</code></b>(                  <code>DataFrame</code>
)              –
              <div class="doc-md-description">
                <p>Model data (Flux, Delta_x, Delta_y, Major Axis, Minor Axis, PA, Typ_obj)</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">getComponentInfo</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span><span class="n">year</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">mjd</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">date</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Imports component info from a modelfit .fits or .mod file.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename: Path to a modelfit (or clean) .fits or .mod file</span>

<span class="sd">    Returns:</span>
<span class="sd">        output (DataFrame): Model data (Flux, Delta_x, Delta_y, Major Axis, Minor Axis, PA, Typ_obj)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">is_fits_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="c1">#read in fits file</span>
        <span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">hdu_list</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">comp_data</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;FITS file does not contain model.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">comp_data1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">comp_data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">comp_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">mjd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">date1</span> <span class="o">=</span> <span class="n">get_date</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">date1</span><span class="p">)</span>
        <span class="n">tjyear</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">jyear</span>
        <span class="n">tmjd</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">mjd</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comp_data</span><span class="p">)):</span>
            <span class="n">comp_data1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">comp_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">date1</span><span class="p">)</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">tjyear</span><span class="p">)</span>
            <span class="n">mjd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mjd</span><span class="p">,</span> <span class="n">tmjd</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#DIFMAP STYLE</span>
            <span class="n">comp_data1_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">comp_data1</span><span class="p">,</span>
                                         <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Flux&quot;</span><span class="p">,</span> <span class="s2">&quot;Delta_x&quot;</span><span class="p">,</span> <span class="s2">&quot;Delta_y&quot;</span><span class="p">,</span> <span class="s2">&quot;Major_axis&quot;</span><span class="p">,</span> <span class="s2">&quot;Minor_axis&quot;</span><span class="p">,</span> <span class="s2">&quot;PA&quot;</span><span class="p">,</span>
                                                  <span class="s2">&quot;Typ_obj&quot;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1">#AIPS STYLE</span>
            <span class="n">comp_data1_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">comp_data1</span><span class="p">,</span>
                                         <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Flux&quot;</span><span class="p">,</span><span class="s2">&quot;Delta_x&quot;</span><span class="p">,</span><span class="s2">&quot;Delta_y&quot;</span><span class="p">])</span>
            <span class="n">comp_data1_df</span><span class="p">[</span><span class="s2">&quot;Major_axis&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">comp_data1_df</span><span class="p">[</span><span class="s2">&quot;Minor_axis&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">comp_data1_df</span><span class="p">[</span><span class="s2">&quot;PA&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">comp_data1_df</span><span class="p">[</span><span class="s2">&quot;Typ_obj&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>

        <span class="n">comp_data1_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span>
        <span class="n">comp_data1_df</span><span class="p">[</span><span class="s2">&quot;Year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">year</span>
        <span class="n">comp_data1_df</span><span class="p">[</span><span class="s2">&quot;mjd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mjd</span>
        <span class="n">comp_data1_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Delta_x&quot;</span><span class="p">,</span> <span class="s2">&quot;Delta_y&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">data_df</span> <span class="o">=</span> <span class="n">comp_data1_df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data_df</span><span class="p">,</span> <span class="n">comp_data1_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;tmp&quot;</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1">#write Radius, ratio and Angle also to database</span>
        <span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;Delta_x&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;Delta_y&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>

        <span class="c1"># Function to calculate &#39;theta&#39;</span>
        <span class="k">def</span> <span class="nf">calculate_theta</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Delta_y&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Delta_x&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Delta_y&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Delta_x&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Delta_x&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Delta_y&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">180</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Delta_y&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Delta_x&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Delta_x&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Delta_y&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">+</span> <span class="mi">180</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Delta_y&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Delta_x&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Delta_x&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Delta_y&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">-</span> <span class="mi">180</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="c1"># Apply function to calculate &#39;theta&#39;</span>
        <span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">calculate_theta</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Calculate &#39;ratio&#39;</span>
        <span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Minor_axis&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Major_axis&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Major_axis&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                                     <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#will assume that the file is a .mod file</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">maj</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">typ_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">):</span>
                    <span class="n">linepart</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">linepart</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)))</span>
                    <span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">linepart</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)))</span>
                    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">linepart</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)))</span>
                    <span class="c1">#other parameters might not be there, try</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">maj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maj</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">linepart</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)))</span>
                        <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">linepart</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)))</span>
                        <span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">linepart</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)))</span>
                        <span class="n">typ_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">typ_obj</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># in this case it is a gaussian model component</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">maj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maj</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">typ_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">typ_obj</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#in this case it is a clean component</span>
        <span class="c1">#import completed now calculate additional parameters:</span>
        <span class="n">delta_x</span><span class="o">=</span><span class="n">radius</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span>
        <span class="n">delta_y</span><span class="o">=</span><span class="n">radius</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span>
        <span class="n">maj</span><span class="o">=</span><span class="n">maj</span><span class="o">/</span><span class="n">scale</span>
        <span class="nb">min</span><span class="o">=</span><span class="n">ratio</span><span class="o">*</span><span class="n">maj</span>

        <span class="c1">#create data_df</span>
        <span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;ratio&#39;</span><span class="p">:</span> <span class="n">ratio</span><span class="p">,</span> <span class="s1">&#39;Minor_axis&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">,</span> <span class="s1">&#39;Major_axis&#39;</span><span class="p">:</span> <span class="n">maj</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="n">theta</span><span class="p">,</span> <span class="s1">&#39;Delta_y&#39;</span><span class="p">:</span> <span class="n">delta_y</span><span class="p">,</span>
                                <span class="s1">&#39;Delta_x&#39;</span><span class="p">:</span> <span class="n">delta_x</span> <span class="p">,</span><span class="s2">&quot;Flux&quot;</span><span class="p">:</span> <span class="n">flux</span><span class="p">,</span> <span class="s2">&quot;PA&quot;</span><span class="p">:</span> <span class="n">pa</span><span class="p">,</span> <span class="s2">&quot;Typ_obj&quot;</span><span class="p">:</span> <span class="n">typ_obj</span><span class="p">})</span>

        <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;mjd&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">mjd</span>
        <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;Year&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">year</span>
        <span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">date</span>

    <span class="k">return</span> <span class="n">data_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.getMinVolEllipse" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">getMinVolEllipse</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Find the minimum volume ellipsoid which holds all the points</p>
<p>Based on work by Nima Moshtagh
http://www.mathworks.com/matlabcentral/fileexchange/9542
and also by looking at:
http://cctbx.sourceforge.net/current/python/scitbx.math.minimum_covering_ellipsoid.html
Which is based on the first reference anyway!</p>
<p>Here, P is a numpy array of 2 dimensional points like this:
P = [[x,y], &lt;-- one point per line
     [x,y],
     [x,y]]</p>
<p>Returns:
(center, radii, rotation): output</p>

            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">getMinVolEllipse</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Find the minimum volume ellipsoid which holds all the points</span>

<span class="sd">        Based on work by Nima Moshtagh</span>
<span class="sd">        http://www.mathworks.com/matlabcentral/fileexchange/9542</span>
<span class="sd">        and also by looking at:</span>
<span class="sd">        http://cctbx.sourceforge.net/current/python/scitbx.math.minimum_covering_ellipsoid.html</span>
<span class="sd">        Which is based on the first reference anyway!</span>

<span class="sd">        Here, P is a numpy array of 2 dimensional points like this:</span>
<span class="sd">        P = [[x,y], &lt;-- one point per line</span>
<span class="sd">             [x,y],</span>
<span class="sd">             [x,y]]</span>

<span class="sd">        Returns:</span>
<span class="sd">        (center, radii, rotation): output</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="c1"># Q will be our working array</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)])</span>
        <span class="n">QT</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># initializations</span>
        <span class="n">err</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">tolerance</span>
        <span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

        <span class="c1"># Khachiyan Algorithm</span>
        <span class="k">while</span> <span class="n">err</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">:</span>
            <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">QT</span><span class="p">))</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">QT</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">V</span><span class="p">),</span> <span class="n">Q</span><span class="p">)))</span>    <span class="c1"># M the diagonal vector of an NxN matrix</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
            <span class="n">maximum</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">step_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">maximum</span> <span class="o">-</span> <span class="n">d</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">d</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">maximum</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">))</span>
            <span class="n">new_u</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">step_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span>
            <span class="n">new_u</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">step_size</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">new_u</span> <span class="o">-</span> <span class="n">u</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">new_u</span>

        <span class="c1"># center of the ellipse</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>

        <span class="c1"># the A matrix for the ellipse</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">P</span><span class="p">))</span> <span class="o">-</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">center</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">center</span><span class="p">])</span>
                       <span class="p">)</span> <span class="o">/</span> <span class="n">d</span>
        <span class="c1"># Get the values we&#39;d like to return</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">rotation</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">rotation</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.get_common_beam" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_common_beam</span><span class="p">(</span><span class="n">majs</span><span class="p">,</span> <span class="n">mins</span><span class="p">,</span> <span class="n">posas</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="s1">&#39;common&#39;</span><span class="p">,</span> <span class="n">ppe</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">plot_beams</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Derive the beam to be used for the maps to be aligned.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>majs</code></b>
              –
              <div class="doc-md-description">
                <p>List of Major Axis Values</p>
              </div>
            </li>
            <li>
              <b><code>mins</code></b>
              –
              <div class="doc-md-description">
                <p>List of Minor Axis Values</p>
              </div>
            </li>
            <li>
              <b><code>posas</code></b>
              –
              <div class="doc-md-description">
                <p>List of Position Angles (in degrees)</p>
              </div>
            </li>
            <li>
              <b><code>arg</code></b>
              –
              <div class="doc-md-description">
                <p>Type of algorithm to use ("mean", "max", "median", "circ", "common")</p>
              </div>
            </li>
            <li>
              <b><code>ppe</code></b>
              –
              <div class="doc-md-description">
                <p>Points per Ellipse for "common" algorithm</p>
              </div>
            </li>
            <li>
              <b><code>tolerance</code></b>
              –
              <div class="doc-md-description">
                <p>Tolerance parameter for "common" algorithm</p>
              </div>
            </li>
            <li>
              <b><code>plot_beams</code></b>
              –
              <div class="doc-md-description">
                <p>Boolean to choose if a diagnostic plot of all beams and the common beam should be displayed</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>[maj, min, pos]: List with new major and minor axis and position angle</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_common_beam</span><span class="p">(</span><span class="n">majs</span><span class="p">,</span><span class="n">mins</span><span class="p">,</span><span class="n">posas</span><span class="p">,</span><span class="n">arg</span><span class="o">=</span><span class="s1">&#39;common&#39;</span><span class="p">,</span><span class="n">ppe</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">tolerance</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span><span class="n">plot_beams</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Derive the beam to be used for the maps to be aligned.</span>

<span class="sd">    Args:</span>
<span class="sd">        majs: List of Major Axis Values</span>
<span class="sd">        mins: List of Minor Axis Values</span>
<span class="sd">        posas: List of Position Angles (in degrees)</span>
<span class="sd">        arg: Type of algorithm to use (&quot;mean&quot;, &quot;max&quot;, &quot;median&quot;, &quot;circ&quot;, &quot;common&quot;)</span>
<span class="sd">        ppe: Points per Ellipse for &quot;common&quot; algorithm</span>
<span class="sd">        tolerance: Tolerance parameter for &quot;common&quot; algorithm</span>
<span class="sd">        plot_beams: Boolean to choose if a diagnostic plot of all beams and the common beam should be displayed</span>

<span class="sd">    Returns:</span>
<span class="sd">        [maj, min, pos]: List with new major and minor axis and position angle</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">arg</span><span class="o">==</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">_maj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">majs</span><span class="p">)</span>
        <span class="n">_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mins</span><span class="p">)</span>
        <span class="n">_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">posas</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Will use mean beam.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">arg</span><span class="o">==</span><span class="s1">&#39;max&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">majs</span><span class="p">)</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">mins</span><span class="p">):</span>
            <span class="n">beam_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">majs</span><span class="p">)</span>
            <span class="n">_maj</span> <span class="o">=</span> <span class="n">majs</span><span class="p">[</span><span class="n">beam_ind</span><span class="p">]</span>
            <span class="n">_min</span> <span class="o">=</span> <span class="n">mins</span><span class="p">[</span><span class="n">beam_ind</span><span class="p">]</span>
            <span class="n">_pos</span> <span class="o">=</span> <span class="n">posas</span><span class="p">[</span><span class="n">beam_ind</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;could not derive max beam, defaulting to common beam.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">get_common_beam</span><span class="p">(</span><span class="n">majs</span><span class="p">,</span><span class="n">mins</span><span class="p">,</span><span class="n">posas</span><span class="p">,</span><span class="n">arg</span><span class="o">=</span><span class="s2">&quot;common&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Will use max beam.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">arg</span><span class="o">==</span><span class="s1">&#39;median&#39;</span><span class="p">:</span>
        <span class="n">_maj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">majs</span><span class="p">)</span>
        <span class="n">_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">mins</span><span class="p">)</span>
        <span class="n">_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">posas</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Will use median beam.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
        <span class="n">_maj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">majs</span><span class="p">)</span>
        <span class="n">_min</span> <span class="o">=</span> <span class="n">_maj</span>
        <span class="n">_pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s1">&#39;common&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">plot_beams</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">()</span>

        <span class="n">sample_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">ppe</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">majs</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">majs</span><span class="p">)):</span>
            <span class="n">bmaj</span> <span class="o">=</span> <span class="n">majs</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">bmin</span> <span class="o">=</span> <span class="n">mins</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">posa</span> <span class="o">=</span> <span class="n">posas</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">majs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="p">,</span> <span class="n">posa</span>

            <span class="c1"># sample ellipse points</span>
            <span class="n">ellipse_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">ppe</span><span class="p">)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="o">-</span><span class="n">bmin</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ellipse_angles</span><span class="p">)</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">bmaj</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ellipse_angles</span><span class="p">)</span>

            <span class="c1"># rotate them according to position angle</span>
            <span class="n">X_rot</span> <span class="o">=</span> <span class="n">X</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">posa</span><span class="p">)</span> <span class="o">-</span> <span class="n">Y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">posa</span><span class="p">)</span>
            <span class="n">Y_rot</span> <span class="o">=</span> <span class="n">X</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">posa</span><span class="p">)</span> <span class="o">+</span> <span class="n">Y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">posa</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ppe</span><span class="p">):</span>
                <span class="n">sample_points</span><span class="p">[</span><span class="n">ind</span> <span class="o">*</span> <span class="n">ppe</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">X_rot</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Y_rot</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">plot_beams</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X_rot</span><span class="p">,</span> <span class="n">Y_rot</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>

        <span class="c1"># find minimum ellipse</span>
        <span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">rotation</span><span class="p">)</span> <span class="o">=</span> <span class="n">getMinVolEllipse</span><span class="p">(</span><span class="n">sample_points</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="n">tolerance</span><span class="p">)</span>

        <span class="c1"># find out bmaj, bmin and posa</span>
        <span class="n">bmaj_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bmaj_ind</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bmaj</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">radii</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">bmin</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">radii</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">posa</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">rotation</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">-</span> <span class="mi">90</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bmaj</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">radii</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">bmin</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">radii</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">posa</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">rotation</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">180</span>

        <span class="c1"># make posa from -90 to +90</span>
        <span class="k">if</span> <span class="n">posa</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
            <span class="n">posa</span> <span class="o">=</span> <span class="n">posa</span> <span class="o">-</span> <span class="mi">180</span>
        <span class="k">elif</span> <span class="n">posa</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">90</span><span class="p">:</span>
            <span class="n">posa</span> <span class="o">=</span> <span class="n">posa</span> <span class="o">+</span> <span class="mi">180</span>

        <span class="c1"># plot ellipsoid</span>
        <span class="k">if</span> <span class="n">plot_beams</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">patches</span>
            <span class="n">ellipse</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Ellipse</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">bmin</span><span class="p">,</span> <span class="n">bmaj</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">posa</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">ellipse</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">_maj</span> <span class="o">=</span> <span class="n">bmaj</span>
        <span class="n">_min</span> <span class="o">=</span> <span class="n">bmin</span>
        <span class="n">_pos</span> <span class="o">=</span> <span class="n">posa</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please use a valid arg value (&#39;common&#39;, &#39;max&#39;, &#39;median&#39;, &#39;mean&#39;, &#39;circ&#39;)&quot;</span><span class="p">)</span>


    <span class="n">common_beam</span><span class="o">=</span><span class="p">[</span><span class="n">_maj</span><span class="p">,</span><span class="n">_min</span><span class="p">,</span><span class="n">_pos</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> beam calculated: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="n">common_beam</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">common_beam</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.get_comp_peak_rms" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_comp_peak_rms</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fits_file</span><span class="p">,</span> <span class="n">uvf_file</span><span class="p">,</span> <span class="n">mfit_file</span><span class="p">,</span> <span class="n">stokes_i_mod_file</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">weighting</span><span class="o">=</span><span class="n">uvw</span><span class="p">,</span> <span class="n">rms_box</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">difmap_path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Short program to read in a .fits image and corresponding .uvfits
and .mfit file (containing Gaussian modelfits) from difmap, to estimate the
uncertainties of the modelfit components based on the image plane. This
implementation here is the best way approximating what is described in
Schinzel+ 2012, in which each component is handled individually.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>x</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Center position in mas</p>
              </div>
            </li>
            <li>
              <b><code>y</code></b>
                  (<code>float</code>)
              –
              <div class="doc-md-description">
                <p>Center position in mas</p>
              </div>
            </li>
            <li>
              <b><code>fits_file</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>Path to the .fits image file.</p>
              </div>
            </li>
            <li>
              <b><code>uvf_file</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>Path to the .uvfits file containing the visibilities.</p>
              </div>
            </li>
            <li>
              <b><code>mfit_file</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>Path to the text file containing the Gaussian modelfit components from difmap.</p>
              </div>
            </li>
            <li>
              <b><code>resmap_file</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>Path to the residual map (output)</p>
              </div>
            </li>
            <li>
              <b><code>weighting</code></b>
                  (<code>list[int]</code>, default:
                      <code><span title="vcat.config.uvw">uvw</span></code>
)
              –
              <div class="doc-md-description">
                <p>DIFMAP uv-weighting (default: [0,-1])</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>S_p</code></b>(                  <code>list</code>
)              –
              <div class="doc-md-description">
                <p>List with peak flux densities for each component in mJy/beam.</p>
              </div>
            </li>
            <li>
<b><code>rms</code></b>(                  <code>list</code>
)              –
              <div class="doc-md-description">
                <p>List with residual image root-mean square for each
component in mJy/beam.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_comp_peak_rms</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fits_file</span><span class="p">,</span> <span class="n">uvf_file</span><span class="p">,</span> <span class="n">mfit_file</span><span class="p">,</span> <span class="n">stokes_i_mod_file</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span><span class="n">weighting</span><span class="o">=</span><span class="n">uvw</span><span class="p">,</span> <span class="n">rms_box</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">difmap_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Short program to read in a .fits image and corresponding .uvfits</span>
<span class="sd">    and .mfit file (containing Gaussian modelfits) from difmap, to estimate the</span>
<span class="sd">    uncertainties of the modelfit components based on the image plane. This</span>
<span class="sd">    implementation here is the best way approximating what is described in</span>
<span class="sd">    Schinzel+ 2012, in which each component is handled individually.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (float): Center position in mas</span>
<span class="sd">        y (float): Center position in mas</span>
<span class="sd">        fits_file (str): Path to the .fits image file.</span>
<span class="sd">        uvf_file (str): Path to the .uvfits file containing the visibilities.</span>
<span class="sd">        mfit_file (str): Path to the text file containing the Gaussian modelfit components from difmap.</span>
<span class="sd">        resmap_file (str): Path to the residual map (output)</span>
<span class="sd">        weighting (list[int]): DIFMAP uv-weighting (default: [0,-1])</span>

<span class="sd">    Returns:</span>
<span class="sd">        S_p (list): List with peak flux densities for each component in mJy/beam.</span>
<span class="sd">        rms (list): List with residual image root-mean square for each</span>
<span class="sd">          component in mJy/beam.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># add difmap to PATH</span>
    <span class="k">if</span> <span class="n">difmap_path</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">difmap_path</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]:</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">difmap_path</span><span class="p">)</span>

    <span class="c1"># remove potential difmap boot files (we don&#39;t need them)</span>
    <span class="n">env</span><span class="p">[</span><span class="s2">&quot;DIFMAP_LOGIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># Initialize difmap call</span>
    <span class="n">child</span> <span class="o">=</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="s1">&#39;difmap&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
    <span class="n">child</span><span class="o">.</span><span class="n">expect_exact</span><span class="p">(</span><span class="s1">&#39;0&gt;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_difmap_command</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="n">prompt</span><span class="o">=</span><span class="s1">&#39;0&gt;&#39;</span><span class="p">):</span>
        <span class="n">child</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">child</span><span class="o">.</span><span class="n">expect_exact</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># print(&#39;Using .fits and .uvf file&#39;)</span>
    <span class="n">ms_x</span><span class="p">,</span> <span class="n">ps_x</span><span class="p">,</span> <span class="n">ms_y</span><span class="p">,</span> <span class="n">ps_y</span> <span class="o">=</span> <span class="n">get_ms_ps</span><span class="p">(</span><span class="n">fits_file</span><span class="p">)</span>


    <span class="n">send_difmap_command</span><span class="p">(</span><span class="s1">&#39;observe &#39;</span> <span class="o">+</span> <span class="n">uvf_file</span><span class="p">)</span>
    <span class="n">send_difmap_command</span><span class="p">(</span><span class="s1">&#39;select I&#39;</span><span class="p">)</span>
    <span class="n">send_difmap_command</span><span class="p">(</span><span class="s1">&#39;uvw &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">weighting</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">weighting</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>    <span class="c1"># use natural weighting as default</span>
    <span class="n">send_difmap_command</span><span class="p">(</span><span class="s1">&#39;rmod &#39;</span> <span class="o">+</span> <span class="n">stokes_i_mod_file</span><span class="p">)</span>
    <span class="n">send_difmap_command</span><span class="p">(</span><span class="s1">&#39;selfcal&#39;</span><span class="p">)</span> <span class="c1">#this is required in case the map is shifted (difmap does not store phase shifts!)</span>
    <span class="n">send_difmap_command</span><span class="p">(</span><span class="s1">&#39;select &#39;</span> <span class="o">+</span>  <span class="n">channel</span><span class="p">)</span>
    <span class="n">send_difmap_command</span><span class="p">(</span><span class="s1">&#39;rmod &#39;</span> <span class="o">+</span> <span class="n">mfit_file</span><span class="p">)</span>
    <span class="n">send_difmap_command</span><span class="p">(</span><span class="s2">&quot;selfcal&quot;</span><span class="p">)</span>
    <span class="n">send_difmap_command</span><span class="p">(</span><span class="s1">&#39;mapsize &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ms_x</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ps_x</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ms_y</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ps_y</span><span class="p">))</span>
    <span class="n">send_difmap_command</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;wdmap tmp/resmap_model.fits&#39;</span><span class="p">)</span>
    <span class="n">ra</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">dec</span> <span class="o">=</span> <span class="n">y</span>

    <span class="n">send_difmap_command</span><span class="p">(</span><span class="s1">&#39;dev /NULL&#39;</span><span class="p">)</span>
    <span class="n">send_difmap_command</span><span class="p">(</span><span class="s1">&#39;mapl cln&#39;</span><span class="p">)</span>
    <span class="n">send_difmap_command</span><span class="p">(</span><span class="s1">&#39;addwin &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ra</span><span class="o">-</span><span class="mf">0.1</span><span class="o">*</span><span class="n">ps_x</span><span class="p">)</span>
                             <span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ra</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="n">ps_x</span><span class="p">)</span>
                             <span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dec</span><span class="o">-</span><span class="mf">0.1</span><span class="o">*</span><span class="n">ps_y</span><span class="p">)</span>
                             <span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dec</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="n">ps_y</span><span class="p">))</span>
    <span class="n">send_difmap_command</span><span class="p">(</span><span class="s1">&#39;winmod true&#39;</span><span class="p">)</span>
    <span class="n">send_difmap_command</span><span class="p">(</span><span class="s1">&#39;mapl map&#39;</span><span class="p">)</span>
    <span class="n">send_difmap_command</span><span class="p">(</span><span class="s1">&#39;print mapvalue(&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
                                     <span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf difmap.log*&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">str_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">before</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">str_</span> <span class="o">==</span><span class="s1">&#39;.&#39;</span><span class="p">:</span>
                <span class="n">j_end</span> <span class="o">=</span> <span class="n">j</span>
                <span class="k">break</span>
        <span class="n">S_p</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">before</span><span class="p">[</span><span class="o">-</span><span class="n">j_end</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not read off peak flux density for component.&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">before</span><span class="p">)</span>
        <span class="n">S_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">rms</span> <span class="o">=</span> <span class="n">get_noise_from_residual_map</span><span class="p">(</span><span class="s2">&quot;tmp/resmap_model.fits&quot;</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">rms_box</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">S_p</span><span class="p">,</span> <span class="n">rms</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.get_date" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_date</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Returns the date of an observation from a .fits file.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>filename</code></b>
              –
              <div class="doc-md-description">
                <p>Path to the .fits file</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>Date in the format year-month-day</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_date</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the date of an observation from a .fits file.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename: Path to the .fits file</span>

<span class="sd">    Returns:</span>
<span class="sd">        Date in the format year-month-day</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">hdu_list</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Plot date</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATE-OBS&quot;</span><span class="p">]</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">day</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">day</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">month</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">month</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="mi">45</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="n">year</span> <span class="o">=</span> <span class="s2">&quot;19&quot;</span> <span class="o">+</span> <span class="n">time</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">46</span><span class="p">:</span>
                    <span class="n">year</span> <span class="o">=</span> <span class="s2">&quot;20&quot;</span> <span class="o">+</span> <span class="n">time</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">year</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">year</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">month</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">day</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;MJD&quot;</span><span class="p">]</span>
        <span class="n">date</span><span class="o">=</span><span class="n">Time</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;mjd&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">date</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.get_noise_from_residual_map" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_noise_from_residual_map</span><span class="p">(</span><span class="n">residual_fits</span><span class="p">,</span> <span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">rms_box</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;std&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>calculates the noise from the residual map in a given box</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>residual_fits</code></b>
              –
              <div class="doc-md-description">
                <p>Path to .fits file with residual map</p>
              </div>
            </li>
            <li>
              <b><code>center_x</code></b>
              –
              <div class="doc-md-description">
                <p>X-center of the box to use for noise calculation in mas</p>
              </div>
            </li>
            <li>
              <b><code>center_y</code></b>
              –
              <div class="doc-md-description">
                <p>Y-center of the box to use for noise calculation in mas</p>
              </div>
            </li>
            <li>
              <b><code>rms_box</code></b>
              –
              <div class="doc-md-description">
                <p>Width of the box in pixels</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>noise</code></b>(                  <code>float</code>
)              –
              <div class="doc-md-description">
                <p>Noise in the given box from the residual map</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_noise_from_residual_map</span><span class="p">(</span><span class="n">residual_fits</span><span class="p">,</span> <span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">rms_box</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;std&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;calculates the noise from the residual map in a given box</span>

<span class="sd">    Args:</span>
<span class="sd">        residual_fits: Path to .fits file with residual map</span>
<span class="sd">        center_x: X-center of the box to use for noise calculation in mas</span>
<span class="sd">        center_y: Y-center of the box to use for noise calculation in mas</span>
<span class="sd">        rms_box: Width of the box in pixels</span>

<span class="sd">    Returns:</span>
<span class="sd">        noise (float): Noise in the given box from the residual map</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ms_x</span><span class="p">,</span> <span class="n">ps_x</span><span class="p">,</span> <span class="n">ms_y</span><span class="p">,</span> <span class="n">ps_y</span> <span class="o">=</span> <span class="n">get_ms_ps</span><span class="p">(</span><span class="n">residual_fits</span><span class="p">)</span>
    <span class="n">resMAP_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">residual_fits</span><span class="p">)</span>
    <span class="n">resMAP_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">resMAP_data</span><span class="p">)</span>
    <span class="n">xdim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">resMAP_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ydim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">resMAP_data</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;std&quot;</span><span class="p">:</span>
        <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">resMAP_data</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">ydim</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">center_y</span> <span class="o">/</span> <span class="n">ps_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">rms_box</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                                 <span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">ydim</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">center_y</span> <span class="o">/</span> <span class="n">ps_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">rms_box</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                     <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">xdim</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">center_x</span> <span class="o">/</span> <span class="n">ps_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">rms_box</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                     <span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">xdim</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">center_x</span> <span class="o">/</span> <span class="n">ps_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">rms_box</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)])</span>
    <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;aver&quot;</span><span class="p">:</span>
        <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">resMAP_data</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">ydim</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">center_y</span> <span class="o">/</span> <span class="n">ps_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">rms_box</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                                 <span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">ydim</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">center_y</span> <span class="o">/</span> <span class="n">ps_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">rms_box</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                     <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">xdim</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">center_x</span> <span class="o">/</span> <span class="n">ps_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">rms_box</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                     <span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">xdim</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">center_x</span> <span class="o">/</span> <span class="n">ps_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">rms_box</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">rms</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.get_residual_map" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_residual_map</span><span class="p">(</span><span class="n">uvf_file</span><span class="p">,</span> <span class="n">mod_file</span><span class="p">,</span> <span class="n">clean_mod_file</span><span class="p">,</span> <span class="n">difmap_path</span><span class="o">=</span><span class="n">difmap_path</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">save_location</span><span class="o">=</span><span class="s1">&#39;residual.fits&#39;</span><span class="p">,</span> <span class="n">weighting</span><span class="o">=</span><span class="n">uvw</span><span class="p">,</span> <span class="n">npix</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">pxsize</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">do_selfcal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>calculates residual map and stores it as .fits file.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>uvf_file</code></b>
              –
              <div class="doc-md-description">
                <p>Path to a .uvf file</p>
              </div>
            </li>
            <li>
              <b><code>mod_file</code></b>
              –
              <div class="doc-md-description">
                <p>Path to a .mod file</p>
              </div>
            </li>
            <li>
              <b><code>difmap_path</code></b>
              –
              <div class="doc-md-description">
                <p>Path to the DIFMAP executable</p>
              </div>
            </li>
            <li>
              <b><code>save_location</code></b>
              –
              <div class="doc-md-description">
                <p>Path where to store the residual map .fits file</p>
              </div>
            </li>
            <li>
              <b><code>npix</code></b>
              –
              <div class="doc-md-description">
                <p>Number of pixels to use</p>
              </div>
            </li>
            <li>
              <b><code>pxsize</code></b>
              –
              <div class="doc-md-description">
                <p>Pixel Size (usually in mas)</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>Nothing, but writes a .fits file including the residual map</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_residual_map</span><span class="p">(</span><span class="n">uvf_file</span><span class="p">,</span><span class="n">mod_file</span><span class="p">,</span> <span class="n">clean_mod_file</span><span class="p">,</span> <span class="n">difmap_path</span><span class="o">=</span><span class="n">difmap_path</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">save_location</span><span class="o">=</span><span class="s2">&quot;residual.fits&quot;</span><span class="p">,</span> <span class="n">weighting</span><span class="o">=</span><span class="n">uvw</span><span class="p">,</span>
                     <span class="n">npix</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span><span class="n">pxsize</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">do_selfcal</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; calculates residual map and stores it as .fits file.</span>

<span class="sd">    Args:</span>
<span class="sd">        uvf_file: Path to a .uvf file</span>
<span class="sd">        mod_file: Path to a .mod file</span>
<span class="sd">        difmap_path: Path to the DIFMAP executable</span>
<span class="sd">        save_location: Path where to store the residual map .fits file</span>
<span class="sd">        npix: Number of pixels to use</span>
<span class="sd">        pxsize: Pixel Size (usually in mas)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing, but writes a .fits file including the residual map</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># add difmap to PATH</span>
    <span class="k">if</span> <span class="n">difmap_path</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">difmap_path</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]:</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">difmap_path</span><span class="p">)</span>

    <span class="c1">#remove potential difmap boot files (we don&#39;t need them)</span>
    <span class="n">env</span><span class="p">[</span><span class="s2">&quot;DIFMAP_LOGIN&quot;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="c1"># Initialize difmap call</span>
    <span class="n">child</span> <span class="o">=</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="s1">&#39;difmap&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
    <span class="n">child</span><span class="o">.</span><span class="n">expect_exact</span><span class="p">(</span><span class="s2">&quot;0&gt;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_difmap_command</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;0&gt;&quot;</span><span class="p">):</span>
        <span class="n">child</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">child</span><span class="o">.</span><span class="n">expect_exact</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">send_difmap_command</span><span class="p">(</span><span class="s2">&quot;obs &quot;</span><span class="o">+</span><span class="n">uvf_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">do_selfcal</span><span class="p">:</span>
        <span class="n">send_difmap_command</span><span class="p">(</span><span class="s2">&quot;select i&quot;</span><span class="p">)</span>
        <span class="n">send_difmap_command</span><span class="p">(</span><span class="s2">&quot;rmod &quot;</span> <span class="o">+</span> <span class="n">clean_mod_file</span><span class="p">)</span>
        <span class="n">send_difmap_command</span><span class="p">(</span><span class="s2">&quot;selfcal&quot;</span><span class="p">)</span>
    <span class="n">send_difmap_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">send_difmap_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rmod </span><span class="si">{</span><span class="n">mod_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">send_difmap_command</span><span class="p">(</span><span class="s1">&#39;uvw &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">weighting</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">weighting</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># use natural weighting</span>
    <span class="n">send_difmap_command</span><span class="p">(</span><span class="s2">&quot;maps &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pxsize</span><span class="p">))</span>
    <span class="n">send_difmap_command</span><span class="p">(</span><span class="s2">&quot;wdmap &quot;</span> <span class="o">+</span> <span class="n">save_location</span><span class="p">)</span> <span class="c1">#save the residual map to a fits file</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf difmap.log*&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.get_uvf_frequency" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_uvf_frequency</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Extracts frequency from the FITS header by finding the correct CVALX.</p>

            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_uvf_frequency</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extracts frequency from the FITS header by finding the correct CVALX.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdu_list</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>  <span class="c1"># Check CTYPE1 to CTYPE99 (assuming X is within this range)</span>
            <span class="n">ctype_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;CTYPE</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">cval_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;CRVAL</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">ctype_key</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="s2">&quot;FREQ&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">[</span><span class="n">ctype_key</span><span class="p">]:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">cval_key</span><span class="p">])</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frequency keyword not found in </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.mas2pc" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mas2pc</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>To convert mas to parsec.</p>
<p>Uses either a redshift (z) or a distance (d) to compute the conversion from mas to parsec.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>z</code></b>
                  (<code>float</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>redshift</p>
              </div>
            </li>
            <li>
              <b><code>d</code></b>
                  (<code>float</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>distance</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>result</code></b>(                  <code>float</code>
)              –
              <div class="doc-md-description">
                <p>the conversion between mas and parsec.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">mas2pc</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;To convert mas to parsec.</span>

<span class="sd">    Uses either a redshift (z) or a distance (d) to compute the conversion from mas to parsec.</span>

<span class="sd">    Args:</span>
<span class="sd">        z (float): redshift</span>
<span class="sd">        d (float): distance</span>

<span class="sd">    Returns:</span>
<span class="sd">        result (float): the conversion between mas and parsec.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cosmo</span><span class="o">=</span><span class="n">FlatLambdaCDM</span><span class="p">(</span><span class="n">H0</span><span class="o">=</span><span class="n">H0</span><span class="p">,</span><span class="n">Om0</span><span class="o">=</span><span class="n">Om0</span><span class="p">)</span> <span class="c1">#Planck Collaboration 2020</span>

    <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
        <span class="n">D</span><span class="o">=</span><span class="n">d</span><span class="o">*</span><span class="mf">1e6</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">parsec</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">D</span><span class="o">=</span><span class="n">cosmo</span><span class="o">.</span><span class="n">angular_diameter_distance</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">D</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="o">/</span><span class="mf">3.6e6</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">parsec</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.plot_pixel_fit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_pixel_fit</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">brightness</span><span class="p">,</span> <span class="n">err_brightness</span><span class="p">,</span> <span class="n">fitted_func</span><span class="p">,</span> <span class="n">pixel</span><span class="p">,</span> <span class="n">popt</span><span class="p">,</span> <span class="n">peak_brightness</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Plot the data points and fitted function for a specific pixel.</p>

            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">plot_pixel_fit</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">brightness</span><span class="p">,</span> <span class="n">err_brightness</span><span class="p">,</span> <span class="n">fitted_func</span><span class="p">,</span> <span class="n">pixel</span><span class="p">,</span> <span class="n">popt</span><span class="p">,</span> <span class="n">peak_brightness</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot the data points and fitted function for a specific pixel.&quot;&quot;&quot;</span>
    <span class="n">x_smooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">frequencies</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">frequencies</span><span class="p">),</span> <span class="mi">10000</span><span class="p">)</span>  <span class="c1"># High-resolution x-axis</span>
    <span class="n">y_smooth</span> <span class="o">=</span> <span class="n">func_turn</span><span class="p">(</span><span class="n">x_smooth</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>  <span class="c1"># Fitted function for high-res x-axis</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">brightness</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">err_brightness</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data Points&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_smooth</span><span class="p">,</span> <span class="n">y_smooth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Fitted Function</span><span class="se">\n</span><span class="s1">Peak: </span><span class="si">{</span><span class="n">peak_brightness</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> GHz&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency [GHz]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Brightness [Jy/beam]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Pixel (</span><span class="si">{</span><span class="n">pixel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">pixel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="c1">#plt.savefig(f&#39;pixel_fit_{pixel[1]}_{pixel[0]}.pdf&#39;, format=&#39;pdf&#39;, dpi=300, bbox_inches=&#39;tight&#39;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.rotate_points" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">rotate_points</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">angle_deg</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Rotate points (x, y) by angle (in degrees) around the origin.</p>

            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">rotate_points</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">angle_deg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Rotate points (x, y) by angle (in degrees) around the origin. &quot;&quot;&quot;</span>
    <span class="n">angle_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle_deg</span><span class="p">)</span>  <span class="c1"># Convert degrees to radians</span>
    <span class="n">cos_theta</span><span class="p">,</span> <span class="n">sin_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">)</span>

    <span class="c1"># Apply rotation matrix</span>
    <span class="n">x_new</span> <span class="o">=</span> <span class="n">cos_theta</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">sin_theta</span> <span class="o">*</span> <span class="n">y</span>
    <span class="n">y_new</span> <span class="o">=</span> <span class="n">sin_theta</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">cos_theta</span> <span class="o">*</span> <span class="n">y</span>

    <span class="k">return</span> <span class="n">x_new</span><span class="p">,</span> <span class="n">y_new</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.set_figsize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_figsize</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">subplots</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ratio</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Set aesthetic figure dimensions to avoid scaling in latex.
Taken from https://jwalton.info/Embed-Publication-Matplotlib-Latex/</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>width</code></b>
                  (<code>float or string</code>)
              –
              <div class="doc-md-description">
                <p>Width in pts, or string of predined document type</p>
              </div>
            </li>
            <li>
              <b><code>fraction</code></b>
                  (<code>(float, optional)</code>, default:
                      <code>1</code>
)
              –
              <div class="doc-md-description">
                <p>Fraction of the width which you wish the figure to occupy</p>
              </div>
            </li>
            <li>
              <b><code>subplots</code></b>
                  (<code>tuple(int</code>, default:
                      <code>(1, 1)</code>
)
              –
              <div class="doc-md-description">
                <p>The number of rows and columns of subplots</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>fig_dim</code></b>(                  <code>tuple</code>
)              –
              <div class="doc-md-description">
                <p>Dimensions of figure in inches</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">set_figsize</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subplots</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">ratio</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Set aesthetic figure dimensions to avoid scaling in latex.</span>
<span class="sd">    Taken from https://jwalton.info/Embed-Publication-Matplotlib-Latex/</span>

<span class="sd">    Args:</span>
<span class="sd">        width (float or string): Width in pts, or string of predined document type</span>
<span class="sd">        fraction (float,optional): Fraction of the width which you wish the figure to occupy</span>
<span class="sd">        subplots (tuple(int)): The number of rows and columns of subplots</span>

<span class="sd">    Returns:</span>
<span class="sd">        fig_dim (tuple): Dimensions of figure in inches</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">if</span> <span class="n">width</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">width</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fraction</span><span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">width</span> <span class="o">==</span><span class="s1">&#39;aanda&#39;</span><span class="p">:</span>
        <span class="n">width_pt</span> <span class="o">=</span> <span class="mf">256.0748</span>
    <span class="k">elif</span> <span class="n">width</span> <span class="o">==</span><span class="s1">&#39;aanda*&#39;</span><span class="p">:</span>
        <span class="n">width_pt</span> <span class="o">=</span> <span class="mf">523.5307</span>
    <span class="k">elif</span> <span class="n">width</span> <span class="o">==</span> <span class="s1">&#39;beamer&#39;</span><span class="p">:</span>
        <span class="n">width_pt</span> <span class="o">=</span> <span class="mi">342</span>
    <span class="k">elif</span> <span class="n">width</span> <span class="o">==</span> <span class="s1">&#39;screen&#39;</span><span class="p">:</span>
        <span class="n">width_pt</span> <span class="o">=</span> <span class="mi">600</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">width_pt</span> <span class="o">=</span> <span class="n">width</span>
    <span class="c1"># Width of figure</span>
    <span class="n">fig_width_pt</span> <span class="o">=</span> <span class="n">width_pt</span> <span class="o">*</span> <span class="n">fraction</span>

    <span class="c1"># Convert from pt to inches</span>
    <span class="n">inches_per_pt</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">72.27</span>

    <span class="c1"># Golden ratio to set aesthetic figure height</span>
    <span class="n">golden_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ratio</span><span class="p">:</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">golden_ratio</span>

    <span class="c1"># Figure width in inches</span>
    <span class="n">fig_width_in</span> <span class="o">=</span> <span class="n">fig_width_pt</span> <span class="o">*</span> <span class="n">inches_per_pt</span>
    <span class="c1"># Figure height in inches</span>
    <span class="n">fig_height_in</span> <span class="o">=</span> <span class="n">fig_width_in</span> <span class="o">*</span> <span class="n">ratio</span><span class="o">*</span> <span class="p">(</span><span class="n">subplots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">subplots</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">fig_width_in</span><span class="p">,</span> <span class="n">fig_height_in</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.total_flux_from_mod" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">total_flux_from_mod</span><span class="p">(</span><span class="n">mod_file</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>needs a mod_file as input an returns the total flux</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>mod_file</code></b>
              –
              <div class="doc-md-description">
                <p>Path to a .mod file</p>
              </div>
            </li>
            <li>
              <b><code>squared</code></b>
              –
              <div class="doc-md-description">
                <p>If true, returns the sum of the squared fluxes (useful for polarization)</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>The total flux in the .mod file (usually in mJy, depending on the .mod file)</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">total_flux_from_mod</span><span class="p">(</span><span class="n">mod_file</span><span class="p">,</span><span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;needs a mod_file as input an returns the total flux</span>

<span class="sd">    Args:</span>
<span class="sd">        mod_file: Path to a .mod file</span>
<span class="sd">        squared: If true, returns the sum of the squared fluxes (useful for polarization)</span>

<span class="sd">    Returns:</span>
<span class="sd">        The total flux in the .mod file (usually in mJy, depending on the .mod file)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lines</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">mod_file</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">total_flux</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">):</span>
            <span class="n">linepart</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">squared</span><span class="p">:</span>
                <span class="n">total_flux</span><span class="o">+=</span><span class="nb">float</span><span class="p">(</span><span class="n">linepart</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">total_flux</span><span class="o">+=</span><span class="nb">float</span><span class="p">(</span><span class="n">linepart</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">total_flux</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.wrap_evpas" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">wrap_evpas</span><span class="p">(</span><span class="n">evpas</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Checks for EVPA changes &gt;90 or &lt;-90 degreees and wraps them</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>evpas</code></b>
                  (<code>list[float]</code>)
              –
              <div class="doc-md-description">
                <p>List of EVPA values in degrees</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>evpas</code></b>(                  <code>list[float]</code>
)              –
              <div class="doc-md-description">
                <p>List of wrapped EVPAs</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">wrap_evpas</span><span class="p">(</span><span class="n">evpas</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks for EVPA changes &gt;90 or &lt;-90 degreees and wraps them</span>

<span class="sd">    Args:</span>
<span class="sd">        evpas (list[float]): List of EVPA values in degrees</span>

<span class="sd">    Returns:</span>
<span class="sd">        evpas (list[float]): List of wrapped EVPAs</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">evpas</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">evpas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">evpas</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">evpas</span><span class="p">)):</span>
                    <span class="n">evpas</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">180</span>
            <span class="k">if</span> <span class="n">evpas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">evpas</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">90</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">evpas</span><span class="p">)):</span>
                    <span class="n">evpas</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">180</span>
    <span class="k">return</span> <span class="n">evpas</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.write_mod_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_mod_file</span><span class="p">(</span><span class="n">model_df</span><span class="p">,</span> <span class="n">writepath</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">adv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>writes a .mod file given an input DataFrame with component info.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>model_df</code></b>
              –
              <div class="doc-md-description">
                <p>DataFrame with model component info (e.g. generated by getComponentInfo())</p>
              </div>
            </li>
            <li>
              <b><code>writepath</code></b>
              –
              <div class="doc-md-description">
                <p>Filepath where to write the .mod file</p>
              </div>
            </li>
            <li>
              <b><code>freq</code></b>
              –
              <div class="doc-md-description">
                <p>Frequency of the observation in GHz</p>
              </div>
            </li>
            <li>
              <b><code>scale</code></b>
              –
              <div class="doc-md-description">
                <p>Conversion of the image scale to degrees (default milli-arc-seconds -&gt; 60<em>60</em>1000)</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>Nothing, but writes a .mod file to writepath</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">write_mod_file</span><span class="p">(</span><span class="n">model_df</span><span class="p">,</span><span class="n">writepath</span><span class="p">,</span><span class="n">freq</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span><span class="n">adv</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;writes a .mod file given an input DataFrame with component info.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_df: DataFrame with model component info (e.g. generated by getComponentInfo())</span>
<span class="sd">        writepath: Filepath where to write the .mod file</span>
<span class="sd">        freq: Frequency of the observation in GHz</span>
<span class="sd">        scale: Conversion of the image scale to degrees (default milli-arc-seconds -&gt; 60*60*1000)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing, but writes a .mod file to writepath</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model_df</span><span class="p">[</span><span class="s2">&quot;Flux&quot;</span><span class="p">])</span>
    <span class="n">delta_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model_df</span><span class="p">[</span><span class="s2">&quot;Delta_x&quot;</span><span class="p">])</span>
    <span class="n">delta_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model_df</span><span class="p">[</span><span class="s2">&quot;Delta_y&quot;</span><span class="p">])</span>
    <span class="n">maj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model_df</span><span class="p">[</span><span class="s2">&quot;Major_axis&quot;</span><span class="p">])</span>
    <span class="nb">min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model_df</span><span class="p">[</span><span class="s2">&quot;Minor_axis&quot;</span><span class="p">])</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model_df</span><span class="p">[</span><span class="s2">&quot;PA&quot;</span><span class="p">])</span>
    <span class="n">typ_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model_df</span><span class="p">[</span><span class="s2">&quot;Typ_obj&quot;</span><span class="p">])</span>

    <span class="n">original_stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">writepath</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="n">radius</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">theta</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">ratio</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flux</span><span class="p">)):</span>
        <span class="n">radius</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">delta_x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">delta_y</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">delta_y</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">delta_x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">delta_y</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">delta_x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">theta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">delta_x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">/</span><span class="n">delta_y</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">delta_y</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">delta_x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">theta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">delta_x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">/</span><span class="n">delta_y</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="o">+</span><span class="mi">180</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">delta_y</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">delta_x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">theta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">delta_x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">/</span> <span class="n">delta_y</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">-</span> <span class="mi">180</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">delta_x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">delta_y</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">theta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">delta_x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">delta_y</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">theta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">delta_x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">delta_y</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">theta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">180</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">theta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maj</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">ratio_val</span><span class="o">=</span><span class="nb">min</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">/</span><span class="n">maj</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ratio_val</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1">#swap maj and min if needed</span>
                <span class="n">m</span><span class="o">=</span><span class="n">maj</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">maj</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">=</span><span class="nb">min</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="nb">min</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">=</span><span class="n">m</span>
                <span class="n">pos</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">=</span><span class="n">pos</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">+</span><span class="mi">90</span>
            <span class="n">ratio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">/</span><span class="n">maj</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ratio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1">#sort by flux</span>
    <span class="n">argsort</span><span class="o">=</span><span class="n">flux</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">flux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">flux</span><span class="p">)[</span><span class="n">argsort</span><span class="p">]</span>
    <span class="n">radius</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">radius</span><span class="p">)[</span><span class="n">argsort</span><span class="p">]</span>
    <span class="n">theta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">theta</span><span class="p">)[</span><span class="n">argsort</span><span class="p">]</span>
    <span class="n">maj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">maj</span><span class="p">)[</span><span class="n">argsort</span><span class="p">]</span>
    <span class="n">ratio</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ratio</span><span class="p">)[</span><span class="n">argsort</span><span class="p">]</span>
    <span class="n">pos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos</span><span class="p">)[</span><span class="n">argsort</span><span class="p">]</span>
    <span class="n">typ_obj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">typ_obj</span><span class="p">)[</span><span class="n">argsort</span><span class="p">]</span>

    <span class="c1">#check if we need to add &quot;v&quot; to the components to make them fittable</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adv</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">ad</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">ads</span> <span class="ow">in</span> <span class="n">adv</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ads</span><span class="p">:</span>
                <span class="n">ad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">adv</span><span class="p">)</span><span class="o">!=</span><span class="mi">6</span><span class="p">:</span>
            <span class="c1">#make sure ad has seven elements</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">adv</span><span class="p">)):</span>
                <span class="n">ad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">adv</span><span class="p">:</span>
        <span class="n">ad</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">,</span><span class="s2">&quot;v&quot;</span><span class="p">,</span><span class="s2">&quot;v&quot;</span><span class="p">,</span><span class="s2">&quot;v&quot;</span><span class="p">,</span><span class="s2">&quot;v&quot;</span><span class="p">,</span><span class="s2">&quot;v&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ad</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flux</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{:.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span><span class="o">+</span><span class="n">ad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;   &quot;</span><span class="o">+</span>
              <span class="s2">&quot;</span><span class="si">{:.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">radius</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span><span class="o">+</span><span class="n">ad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;    &quot;</span><span class="o">+</span>
              <span class="s2">&quot;</span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span><span class="o">+</span><span class="n">ad</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;   &quot;</span><span class="o">+</span>
              <span class="s2">&quot;</span><span class="si">{:.7f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maj</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">*</span><span class="n">scale</span><span class="p">)</span><span class="o">+</span><span class="n">ad</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;    &quot;</span><span class="o">+</span>
              <span class="s2">&quot;</span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ratio</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span><span class="o">+</span><span class="n">ad</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;   &quot;</span><span class="o">+</span>
              <span class="s2">&quot;</span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span><span class="o">+</span><span class="n">ad</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;  &quot;</span><span class="o">+</span>
              <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">typ_obj</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span>
              <span class="s2">&quot;</span><span class="si">{:.5E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;   0&quot;</span><span class="p">)</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">original_stdout</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.write_mod_file_from_casa" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_mod_file_from_casa</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="s1">&#39;export.mod&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Writes a .mod file from a CASA exported .fits model file.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>file_path</code></b>
              –
              <div class="doc-md-description">
                <p>Image_data object</p>
              </div>
            </li>
            <li>
              <b><code>channel</code></b>
              –
              <div class="doc-md-description">
                <p>Choose the Stokes channel to use (options: "i","q","u","v")</p>
              </div>
            </li>
            <li>
              <b><code>export</code></b>
              –
              <div class="doc-md-description">
                <p>File path where to write the .mod file</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>Nothing, but writes a .mod file to export</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">write_mod_file_from_casa</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span><span class="n">export</span><span class="o">=</span><span class="s2">&quot;export.mod&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Writes a .mod file from a CASA exported .fits model file.</span>

<span class="sd">    Args:</span>
<span class="sd">        file_path: Image_data object</span>
<span class="sd">        channel: Choose the Stokes channel to use (options: &quot;i&quot;,&quot;q&quot;,&quot;u&quot;,&quot;v&quot;)</span>
<span class="sd">        export: File path where to write the .mod file</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing, but writes a .mod file to export</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">channel</span><span class="o">==</span><span class="s2">&quot;i&quot;</span><span class="p">:</span>
        <span class="n">clean_map</span><span class="o">=</span><span class="n">image_data</span><span class="o">.</span><span class="n">Z</span>
    <span class="k">elif</span> <span class="n">channel</span><span class="o">==</span><span class="s2">&quot;q&quot;</span><span class="p">:</span>
        <span class="n">clean_map</span><span class="o">=</span><span class="n">image_data</span><span class="o">.</span><span class="n">stokes_q</span>
    <span class="k">elif</span> <span class="n">channel</span><span class="o">==</span><span class="s2">&quot;u&quot;</span><span class="p">:</span>
        <span class="n">clean_map</span><span class="o">=</span><span class="n">image_data</span><span class="o">.</span><span class="n">stokes_u</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please enter a valid channel (i,q,u)&quot;</span><span class="p">)</span>

    <span class="c1">#read out clean components from pixel map</span>
    <span class="n">delta_x</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">delta_y</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">flux</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">zeros</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">X</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">Y</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">clean_map</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">delta_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">image_data</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                <span class="n">delta_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">image_data</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                <span class="n">flux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clean_map</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="n">zeros</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="c1">#create model_df</span>
    <span class="n">model_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;Flux&#39;</span><span class="p">:</span> <span class="n">flux</span><span class="p">,</span>
         <span class="s1">&#39;Delta_x&#39;</span><span class="p">:</span> <span class="n">delta_x</span><span class="p">,</span>
         <span class="s1">&#39;Delta_y&#39;</span><span class="p">:</span> <span class="n">delta_y</span><span class="p">,</span>
         <span class="s1">&#39;Major_axis&#39;</span><span class="p">:</span> <span class="n">zeros</span><span class="p">,</span>
         <span class="s1">&#39;Minor_axis&#39;</span><span class="p">:</span> <span class="n">zeros</span><span class="p">,</span>
         <span class="s1">&#39;PA&#39;</span><span class="p">:</span> <span class="n">zeros</span><span class="p">,</span>
         <span class="s1">&#39;Typ_obj&#39;</span><span class="p">:</span> <span class="n">zeros</span>
         <span class="p">})</span>

    <span class="c1">#create mod file</span>
    <span class="n">write_mod_file</span><span class="p">(</span><span class="n">model_df</span><span class="p">,</span><span class="n">export</span><span class="p">,</span><span class="n">image_data</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="n">image_data</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="vcat.image_data.write_mod_file_from_components" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_mod_file_from_components</span><span class="p">(</span><span class="n">components</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="s1">&#39;export.mod&#39;</span><span class="p">,</span> <span class="n">adv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Writes a .mod file from a given list of component objects</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>components</code></b>
                  (<code>list[Component]</code>)
              –
              <div class="doc-md-description">
                <p>List of component objects to include in the .mod file</p>
              </div>
            </li>
            <li>
              <b><code>channel</code></b>
                  (<code>str</code>, default:
                      <code>&#39;i&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>polarization channel ("I","Q","U")</p>
              </div>
            </li>
            <li>
              <b><code>export</code></b>
                  (<code>str</code>, default:
                      <code>&#39;export.mod&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>file path of the .mod file to be created</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>vcat/helpers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">write_mod_file_from_components</span><span class="p">(</span><span class="n">components</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span><span class="n">export</span><span class="o">=</span><span class="s2">&quot;export.mod&quot;</span><span class="p">,</span><span class="n">adv</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes a .mod file from a given list of component objects</span>

<span class="sd">    Args:</span>
<span class="sd">        components (list[Component]): List of component objects to include in the .mod file</span>
<span class="sd">        channel (str): polarization channel (&quot;I&quot;,&quot;Q&quot;,&quot;U&quot;)</span>
<span class="sd">        export (str): file path of the .mod file to be created</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">delta_x</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">delta_y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">maj</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">min</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">typ_obj</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">,</span><span class="s2">&quot;I&quot;</span><span class="p">]:</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span><span class="n">comp</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span>
        <span class="n">delta_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delta_x</span><span class="p">,</span><span class="n">comp</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="n">delta_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delta_y</span><span class="p">,</span><span class="n">comp</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">maj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maj</span><span class="p">,</span><span class="n">comp</span><span class="o">.</span><span class="n">maj</span><span class="p">)</span>
        <span class="nb">min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span><span class="n">comp</span><span class="o">.</span><span class="n">min</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">typ_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">typ_obj</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">#for gauss component</span>

        <span class="k">if</span> <span class="n">channel</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">,</span><span class="s2">&quot;U&quot;</span><span class="p">,</span><span class="s2">&quot;q&quot;</span><span class="p">,</span><span class="s2">&quot;U&quot;</span><span class="p">]:</span>
            <span class="c1">#calculate U and Q flux from lin_pol and evpa</span>
            <span class="n">chi</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">evpa</span>
            <span class="k">if</span> <span class="n">chi</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
                <span class="n">chi</span> <span class="o">-=</span> <span class="mi">180</span>
            <span class="k">if</span> <span class="n">chi</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">90</span><span class="p">:</span>
                <span class="n">chi</span> <span class="o">+=</span> <span class="mi">180</span>
            <span class="k">if</span> <span class="n">chi</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">chi</span> <span class="o">&lt;</span> <span class="mi">45</span><span class="p">:</span>
                <span class="n">pre_q</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
                <span class="n">pre_u</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">chi</span> <span class="o">&gt;=</span> <span class="mi">45</span> <span class="ow">and</span> <span class="n">chi</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">:</span>
                <span class="n">pre_u</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
                <span class="n">pre_q</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">chi</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">chi</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">45</span><span class="p">:</span>
                <span class="n">pre_q</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
                <span class="n">pre_u</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">chi</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">45</span> <span class="ow">and</span> <span class="n">chi</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">90</span><span class="p">:</span>
                <span class="n">pre_q</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">pre_u</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

            <span class="n">chi</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">comp</span><span class="o">.</span><span class="n">evpa</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="n">U</span> <span class="o">=</span> <span class="n">pre_u</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span> <span class="o">*</span> <span class="n">comp</span><span class="o">.</span><span class="n">lin_pol</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">pre_q</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">lin_pol</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">,</span><span class="s2">&quot;Q&quot;</span><span class="p">]:</span>
                <span class="n">flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>

    <span class="n">model_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;Flux&quot;</span><span class="p">:</span> <span class="n">flux</span><span class="p">,</span>
                             <span class="s2">&quot;Delta_x&quot;</span><span class="p">:</span> <span class="n">delta_x</span><span class="p">,</span>
                             <span class="s2">&quot;Delta_y&quot;</span><span class="p">:</span> <span class="n">delta_y</span><span class="p">,</span>
                             <span class="s2">&quot;Major_axis&quot;</span><span class="p">:</span> <span class="n">maj</span><span class="p">,</span>
                             <span class="s2">&quot;Minor_axis&quot;</span><span class="p">:</span> <span class="nb">min</span><span class="p">,</span>
                             <span class="s2">&quot;PA&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span>
                             <span class="s2">&quot;Typ_obj&quot;</span><span class="p">:</span> <span class="n">typ_obj</span><span class="p">})</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">write_mod_file</span><span class="p">(</span><span class="n">model_df</span><span class="p">,</span><span class="n">export</span><span class="p">,</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span><span class="n">adv</span><span class="o">=</span><span class="n">adv</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="overview.html" class="btn btn-neutral float-left" title="Code Overview"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="imagecube.html" class="btn btn-neutral float-right" title="ImageCube">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/mpifr-vlbi/VCAT/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="overview.html" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="imagecube.html" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="js/jquery-3.6.0.min.js"></script>
    <script>var base_url = ".";</script>
    <script src="js/theme_extra.js"></script>
    <script src="js/theme.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
